<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32.26 HD FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500;800&family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #1a237e; --bg-main: #f8fafc; --card-bg: #ffffff; --sidebar-bg: #e2e8f0; --accent-blue: #3b82f6; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styling */
        aside { width: 70px; background: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px; border-right: 1px solid #cbd5e1; }
        .nav-icon { width: 42px; height: 42px; display: flex; items-center; justify-content: center; border-radius: 10px; cursor: pointer; transition: 0.2s; color: #64748b; }
        .nav-icon:hover { background: #cbd5e1; color: var(--primary); }
        .nav-icon.active { background: #ffffff; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        /* Main Content Styling */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Card Layout */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; position: relative; }
        .card-title { font-weight: 900; font-size: 18px; color: #1e293b; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* Timer UI */
        .timer-display { font-family: 'JetBrains Mono'; font-size: 64px; font-weight: 800; color: #64748b; margin: 15px 0; letter-spacing: -3px; }
        .t-warn { color: #f59e0b !important; }
        .t-danger { color: #ef4444 !important; }
        .t-urgent { color: #b91c1c !important; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Control UI */
        .status-badge { display: inline-block; padding: 4px 12px; rounded: 20px; font-weight: 900; font-size: 14px; background: #fee2e2; color: #dc2626; }
        .vol-slider { width: 100%; height: 6px; border-radius: 5px; background: #e2e8f0; outline: none; }
        
        /* Custom UI Elements */
        .v-in { width: 100%; height: 38px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; font-family: 'JetBrains Mono'; font-weight: 700; background: #f8fafc; }
        .v-in::placeholder { font-size: 11px; color: #94a3b8; }
        .p-btn { font-weight: 900; font-size: 12px; transition: 0.2s; border-radius: 8px; }
        .pane { display: none; } .pane.active { display: block; }
        body.system-off { filter: grayscale(1); pointer-events: none; }
        header, aside { pointer-events: auto !important; }
    </style>
</head>
<body>

<aside>
    <div class="nav-icon active" onclick="tab('dash', this)" title="ëŒ€ì‹œë³´ë“œ"><i data-lucide="home"></i></div>
    <div class="nav-icon" onclick="tab('sched', this)" title="ìŠ¤ì¼€ì¤„"><i data-lucide="calendar"></i></div>
    <div class="nav-icon" onclick="tab('calc', this)" title="ê³„ì‚°ê¸°"><i data-lucide="calculator"></i></div>
    <div class="mt-auto nav-icon" onclick="togglePIP()" title="PiP íƒ€ì´ë¨¸"><i data-lucide="external-link"></i></div>
</aside>

<main>
    <header>
        <div class="text-xl font-black text-slate-800 tracking-tight">ë³´ìŠ¤ ì•Œë¦¬ë¯¸</div>
        <div id="pwr" class="cursor-pointer text-green-500 hover:scale-110 transition" onclick="togglePwr()">
            <i data-lucide="power" stroke-width="3"></i>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="bg-blue-900 p-6 rounded-2xl border border-blue-800 shadow-xl mb-8">
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between items-center text-white font-black text-xs uppercase tracking-widest">
                        <span>Group Sync Command</span>
                        <div id="pin-badge-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="group-kill-time" class="flex-1 h-14 rounded-xl text-center font-mono text-3xl outline-none shadow-inner" placeholder="ì˜ˆ: 1000(ì‹œë¶„), 10 00(ë¶„ì´ˆ)">
                        <button onclick="killPinnedGroupWithTime()" class="bg-orange-500 text-white font-black px-8 py-2 rounded-xl shadow-md hover:bg-orange-600 transition active:scale-95 leading-tight">
                            ğŸ“Œ ì§€ì • ì‹œê°<br>ì¼ê´„ KILLED
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid-container">
                <div class="card text-center">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[11px] font-black text-slate-400 uppercase">Next Boss Target</span>
                        <button onclick="togglePIP()" class="text-slate-300 hover:text-blue-600"><i data-lucide="external-link" size="18"></i></button>
                    </div>
                    <div id="d-name" class="text-3xl font-black text-blue-800 mb-1">ëŒ€ê¸° ì¤‘</div>
                    <div id="d-timer" class="timer-display">00:00:00</div>
                    <div class="text-xs text-slate-400 font-bold" id="d-meta">-</div>
                </div>

                <div class="flex flex-col gap-6">
                    <div class="card">
                        <div class="card-title">ì•Œë¦¼ ìƒíƒœ</div>
                        <div class="status-badge animate-pulse" id="alert-status">ì•Œë¦¼ ì‹¤í–‰ ì¤‘</div>
                    </div>
                    <div class="card">
                        <div class="card-title">ì†Œë¦¬ ì„¤ì •</div>
                        <div class="flex items-center gap-4">
                            <i data-lucide="volume-2" class="text-slate-400"></i>
                            <input type="range" class="vol-slider" min="0" max="1" step="0.1" value="0.8">
                        </div>
                    </div>
                </div>

                <div class="card h-[400px] flex flex-col">
                    <div class="card-title">ë‹¤ê°€ì˜¤ëŠ” ë³´ìŠ¤</div>
                    <div id="top3-list" class="flex-1 overflow-y-auto space-y-3 font-mono text-[14px]"></div>
                    <button class="mt-4 p-btn bg-slate-100 text-slate-600 py-3 hover:bg-slate-200" onclick="copyKakao('all')">ğŸ“‹ ì „ì²´ ì¹´í†¡ ë³µì‚¬</button>
                </div>

                <div class="card h-[400px] flex flex-col">
                    <div class="card-title">ë¡œê·¸</div>
                    <div id="logs" class="flex-1 overflow-y-auto font-mono text-[12px] text-slate-500 space-y-2"></div>
                </div>
            </div>
            
            <div class="card mt-8 bg-blue-50/50 border-blue-100">
                <div class="grid grid-cols-2 gap-8 text-xs leading-relaxed">
                    <div>
                        <p class="font-black text-blue-900 mb-2">1. ì‹œë¶„ ì…ë ¥ (ë¶™ì—¬ì“°ê¸°)</p>
                        <p class="text-slate-600"><code class="bg-white px-1.5 py-0.5 rounded border font-bold">0230</code> â” 2ì‹œê°„ 30ë¶„ í›„ ì  </p>
                    </div>
                    <div>
                        <p class="font-black text-orange-900 mb-2">2. ë¶„ì´ˆ ì…ë ¥ (ë„ì–´ì“°ê¸°)</p>
                        <p class="text-slate-600"><code class="bg-white px-1.5 py-0.5 rounded border font-bold">02 30</code> â” 2ë¶„ 30ì´ˆ í›„ ì  </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="sched" class="pane">
            <div class="card mb-6 flex justify-between items-center gap-4">
                <input type="text" id="search-boss" placeholder="ë³´ìŠ¤ í•„í„°..." class="border rounded-lg px-4 py-2 text-sm flex-1 outline-none focus:ring-2 ring-blue-100" oninput="handleSearch(this.value)">
                <select id="view-mode-sel" class="border rounded-lg px-3 py-2 text-xs font-bold bg-white" onchange="st.viewMode = this.value; save(); renderSched();">
                    <option value="main">ì˜¤ë”˜ (ë³¸ì„­)</option>
                    <option value="all">ì˜¤ë”˜ (ë³¸ì„­, ì¹¨ê³µ)</option>
                </select>
                <button onclick="openBulkModal()" class="p-btn bg-slate-800 text-white px-5 py-2 uppercase shadow-md">ì»¤ìŠ¤í…€ ë³´ìŠ¤ ê´€ë¦¬</button>
            </div>
            <div id="sched-cont"></div>
        </div>

        <div id="calc" class="pane">
            <div class="grid-container">
                <div class="card">
                    <div class="card-title">ì   ì •ë°€ ë³´ì • (ì„ë°•ìˆœ)</div>
                    <div class="grid grid-cols-2 gap-3 mb-6 font-mono text-center">
                        <div class="bg-slate-50 p-4 rounded-xl shadow-inner"><small class="block text-slate-400 font-bold mb-1">REMAIN</small><div id="zc-remain" class="text-2xl font-black">--:--</div></div>
                        <div class="bg-blue-50 p-4 rounded-xl shadow-inner"><small class="block text-blue-400 font-bold mb-1">SPAWN</small><div id="zc-preview" class="text-2xl font-black text-red-500">--:--:--</div></div>
                    </div>
                    <select id="zc-sel" class="w-full h-12 border rounded-xl mb-4 font-bold px-4 bg-slate-50 outline-none focus:ring-2 ring-blue-100"></select>
                    <input type="text" id="zc-in" class="w-full h-16 text-center font-mono text-4xl border-2 border-slate-200 rounded-2xl mb-4 bg-white" placeholder="ì‹œë¶„ ë˜ëŠ” ë¶„ ì´ˆ" oninput="updateZenPreview(this.value)">
                    <button class="w-full p-btn bg-blue-900 text-white h-16 text-lg shadow-lg hover:bg-blue-800 transition" onclick="applyZenCalc('single')">ë³´ìŠ¤ ì‹œê°„ ì—…ë°ì´íŠ¸</button>
                </div>
                
                <div class="card">
                    <div class="card-title text-red-600">ê´‘ ê³„ì‚°ê¸°</div>
                    <div class="grid grid-cols-2 gap-3 mb-10 font-mono text-center">
                        <div class="bg-slate-50 p-6 rounded-2xl shadow-inner"><small class="block text-slate-400 font-bold mb-1 uppercase">Elapsed</small><div id="b-elap" class="text-3xl font-black text-slate-700">00:00</div></div>
                        <div class="bg-red-50 p-6 rounded-2xl shadow-inner"><small class="block text-red-400 font-bold mb-1 uppercase">Predict</small><div id="b-timer" class="text-3xl font-black text-red-600">--:--</div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <button class="p-btn bg-slate-700 text-white h-16 text-lg shadow-md active:scale-95" onclick="btl('start')">ì‹œì‘</button>
                        <button class="p-btn bg-orange-500 text-white h-16 text-lg shadow-md active:scale-95" onclick="btl('kwang')">ê´‘</button>
                        <button class="p-btn bg-slate-900 text-white h-16 text-lg shadow-xl active:scale-95" onclick="btl('kill')">ì¡í˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="bulk-modal" class="modal"><div class="modal-content shadow-2xl relative"><div id="bulk-inner"></div><div class="mt-8 flex justify-end gap-3"><button onclick="closeBulkModal()" class="p-btn bg-slate-100 text-slate-500 px-8 py-3">ì·¨ì†Œ</button><button onclick="applyBulkUpdate()" class="p-btn bg-blue-900 text-white px-10 py-3 shadow-lg">ë³´ìŠ¤ ì‹œê°„ ì—…ë°ì´íŠ¸</button></div></div></div>

<canvas id="pip-canvas" width="800" height="450" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline style="display:none;"></video>

<script>
/* [ë°ì´í„°] ë³¸ì„­+ì¹¨ê³µ 15ê°œ ë§µ ì „ ì§€ì—­ */
const bosses = [
    { w: "ìš”íˆ°", i: false, b: [{n:"íŒŒë¥´ë°”", r:120}, {n:"ì…€ë¡œë¹„ì•„", r:720}, {n:"íë‹ˆë¥´", r:720}, {n:"í˜í‹°", r:720}, {n:"ë°”ìš°í‹°", r:120}, {n:"ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì•¼ë¥¸", r:240}, {n:"í‹°ë¥´", r:1440}] },
    { w: "ë‹ˆë‹¤", i: false, b: [{n:"ë¼ì´ë…¸ë¥´", r:720}, {n:"ë¹„ìš”ë¥¸", r:720}, {n:"í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ë¸Œë¥€íë“œ", r:720}, {n:"ë¼íƒ€í† ìŠ¤í¬", r:240}, {n:"ìˆ˜ë“œë¦¬", r:720}, {n:"í† ë¥´", r:1440}] },
    { w: "ì•Œë¸Œ", i: false, b: [{n:"ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ë“œë¼ìš°ê·¸", r:240}, {n:"êµ´ë² ì´ê·¸", r:480}, {n:"ì˜¤ë”˜", r:1440}] },
    { w: "ë¬´ìŠ¤í ", i: false, b: [{n:"ë©”ê¸°ë¥´", r:120}, {n:"ì‹ ë§ˆë¼", r:720}, {n:"í—¤ë¥´ê°€ë¦„", r:120}, {n:"íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì—˜ë“œë£¬", r:720}, {n:"ìš°ë¡œë³´ë¡œìŠ¤", r:1440}, {n:"ìˆ˜ë¥´íŠ¸", r:1440}] },
    { w: "ì•„ìŠ¤", i: false, b: [{n:"ë°œë¦¬", r:120}, {n:"ë…¸íŠ¸", r:480}, {n:"ìƒ¤ë¬´í¬", r:120}, {n:"ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"ê·¸ë¡œì•„", r:1440}, {n:"ë¯¸ë¯¸ë¥´", r:240}] },
    { w: "ë‹ˆí”Œ", i: false, b: [{n:"íˆë¡œí‚¨", r:1440}, {n:"í˜¸ë“œ", r:1440}, {n:"í—¤ì´ë“œ", r:1440}, {n:"í”„ë ˆì´", r:1440}, {n:"ì´ë¯¸ë¥´", r:1440}] },
    { w: "ë°”ë‚˜", i: false, b: [{n:"ì—˜ë””ë¥´", r:1440}, {n:"ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ìŠ¤ì¹´ë””", r:1440}, {n:"ì—ê¸°ë¥´", r:1440}] },
    { w: "ë˜ì „", i: false, b: [{n:"4ì¸µ", r:480}, {n:"7ì¸µ", r:480}, {n:"10ì¸µ", r:480}, {n:"ìµœí•˜ì¸µêµ´ë² ", r:480}, {n:"ìµœí•˜ì¸µê°•ê¸€", r:480}, {n:"ìµœí•˜ì¸µìŠ¤ë„¤ë¥´", r:480}] },
    { w: "ì¹¨ê³µ ìš”íˆ°", i: true, b: [{n:"ì¹¨ê³µ íŒŒë¥´ë°”", r:120}, {n:"ì¹¨ê³µ ì…€ë¡œë¹„ì•„", r:720}, {n:"ì¹¨ê³µ íë‹ˆë¥´", r:720}, {n:"ì¹¨ê³µ í˜í‹°", r:720}, {n:"ì¹¨ê³µ ë°”ìš°í‹°", r:120}, {n:"ì¹¨ê³µ ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì¹¨ê³µ ì•¼ë¥¸", r:240}, {n:"ì¹¨ê³µ í‹°ë¥´", r:1440}] },
    { w: "ì¹¨ê³µ ë‹ˆë‹¤", i: true, b: [{n:"ì¹¨ê³µ ë¼ì´ë…¸ë¥´", r:720}, {n:"ì¹¨ê³µ ë¹„ìš”ë¥¸", r:720}, {n:"ì¹¨ê³µ í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ì¹¨ê³µ ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ì¹¨ê³µ ë¸Œë¥€íë“œ", r:720}] },
    { w: "ì¹¨ê³µ ì•Œë¸Œ", i: true, b: [{n:"ì¹¨ê³µ ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ì¹¨ê³µ ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ì¹¨ê³µ ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ì¹¨ê³µ ë“œë¼ìš°ê·¸", r:240}, {n:"ì¹¨ê³µ êµ´ë² ì´ê·¸", r:480}] },
    { w: "ì¹¨ê³µ ë¬´ìŠ¤í ", i: true, b: [{n:"ì¹¨ê³µ ë©”ê¸°ë¥´", r:120}, {n:"ì¹¨ê³µ ì‹ ë§ˆë¼", r:720}, {n:"ì¹¨ê³µ í—¤ë¥´ê°€ë¦„", r:120}, {n:"ì¹¨ê³µ íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì¹¨ê³µ ì—˜ë“œë£¬", r:720}] },
    { w: "ì¹¨ê³µ ì•„ìŠ¤", i: true, b: [{n:"ì¹¨ê³µ ë°œë¦¬", r:120}, {n:"ì¹¨ê³µ ë…¸íŠ¸", r:480}, {n:"ì¹¨ê³µ ìƒ¤ë¬´í¬", r:120}, {n:"ì¹¨ê³µ ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"ì¹¨ê³µ ê·¸ë¡œì•„", r:1440}, {n:"ì¹¨ê³µ ë¯¸ë¯¸ë¥´", r:240}] },
    { w: "ì¹¨ê³µ ë‹ˆí”Œ", i: true, b: [{n:"ì¹¨ê³µ íˆë¡œí‚¨", r:1440}, {n:"í˜¸ë“œ", r:1440}, {n:"í—¤ì´ë“œ", r:1440}, {n:"í”„ë ˆì´", r:1440}, {n:"ì´ë¯¸ë¥´", r:1440}] },
    { w: "ì¹¨ê³µ ë°”ë‚˜", i: true, b: [{n:"ì¹¨ê³µ ì—˜ë””ë¥´", r:1440}, {n:"ì¹¨ê³µ ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ì¹¨ê³µ ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ì¹¨ê³µ ìŠ¤ì¹´ë””", r:1440}, {n:"ì¹¨ê³µ ì—ê¸°ë¥´", r:1440}] }
];

const BOSS_RESPAWN_MAP = {}; bosses.forEach(g => g.b.forEach(b => BOSS_RESPAWN_MAP[b.n] = b.r));
let st = { on: true, profile: 'A', timers: [], pins: [], autoRotate: true, viewMode: 'main', battle: { s: null, k: null, est: 0 }, foldState: {}, timeOffsetMs: 0, _keyCache: {} };

/* [í•µì‹¬] í•˜ì´ë¸Œë¦¬ë“œ íŒŒì‹± ì—”ì§„ */
function parseSmart(s) {
    if (!s) return 0; s = String(s).trim(); let total = 0;
    if (s.match(/[ì¼ì‹œë¶„ì´ˆ]/)) {
        const d = s.match(/(\d+)ì¼/); const h = s.match(/(\d+)ì‹œê°„|(\d+)ì‹œ/); const m = s.match(/(\d+)ë¶„/); const sc = s.match(/(\d+)ì´ˆ/);
        if (d) total += parseInt(d[1]) * 86400; if (h) total += parseInt(h[1] || h[2]) * 3600; if (m) total += parseInt(m[1]) * 60; if (sc) total += parseInt(sc[1]); return total;
    }
    if (s.includes(' ')) { const p = s.split(/\s+/).map(Number); if (p.length === 2) return p[0]*60 + p[1]; if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2]; }
    const v = parseInt(s.replace(/[^0-9]/g, ''));
    if (v >= 100 && v < 10000) return Math.floor(v/100)*3600 + (v%100)*60;
    if (v >= 10000) return Math.floor(v/10000)*3600 + Math.floor((v%10000)/100)*60 + (v%100);
    return v * 60;
}

/* [í•µì‹¬] PiP ë“œë¡œì‰ ì—”ì§„ (image_0e570f ìŠ¤íƒ€ì¼) */
function drawPIP(list) {
    const canvas = document.getElementById('pip-canvas'); const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 800, 450); ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 800, 450);
    if (list.length > 0) {
        const next = list[0]; const rem = next.t - (Date.now() + st.timeOffsetMs);
        ctx.textAlign = "center"; ctx.fillStyle = "#1e3a8a"; ctx.font = "900 80px 'Noto Sans KR'";
        ctx.fillText(next.n, 400, 130);
        let timeColor = "#444444"; 
        if (rem <= 60000) timeColor = "#b91c1c"; else if (rem <= 300000) timeColor = "#ef4444"; else if (rem <= 600000) timeColor = "#f59e0b";
        ctx.fillStyle = timeColor; ctx.font = "800 160px 'JetBrains Mono'";
        ctx.fillText(formatTimerFull(rem), 400, 320);
    }
}

const __dom = { dName:null, dTimer:null, top3:null, bElap:null, bTimer:null };
function cacheDom() { if(!__dom.dName) { __dom.dName=document.getElementById('d-name'); __dom.dTimer=document.getElementById('d-timer'); __dom.top3=document.getElementById('top3-list'); __dom.bElap=document.getElementById('b-elap'); __dom.bTimer=document.getElementById('b-timer'); } }

function loop() {
    if (!st.on) return; cacheDom();
    const now = Date.now() + st.timeOffsetMs;
    for (const tm of st.timers) {
        if (st.autoRotate && now > tm.t) { tm.t += (BOSS_RESPAWN_MAP[tm.n] || 120) * 60 * 1000; tm.lastD = 9999; }
        const zenEl = document.getElementById(`zen-${safeKey(tm.n)}`);
        if (zenEl) zenEl.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
    }
    const upcoming = [...st.timers].sort((a,b) => a.t - b.t).filter(t => t.t > now);
    const next = upcoming[0];
    if (next) { 
        const rem = next.t - now;
        __dom.dName.innerText = next.n; __dom.dTimer.innerText = formatTimerFull(rem);
        __dom.dTimer.className = "timer-big font-mono " + (rem <= 60000 ? "t-urgent" : rem <= 300000 ? "t-danger" : rem <= 600000 ? "t-warn" : "");
    }
    __dom.top3.innerHTML = upcoming.slice(0,10).map((t, i) => `
        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
            <span class="text-slate-500 font-bold">[${new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})}] ${t.n}</span>
            <span class="text-blue-900 font-black">(${formatSimple((t.t-now)/1000)})</span>
        </div>`).join('') || "ì˜ˆì • ì—†ìŒ";
    
    if (st.battle.s && !st.battle.k) __dom.bElap.innerText = formatSimple((Date.now()-st.battle.s)/1000);
    else if (st.battle.k) { const rem = st.battle.est - Math.floor((Date.now()-st.battle.k)/1000); __dom.bTimer.innerText = (rem>=0?"":"+")+formatSimple(Math.abs(rem)); }
    drawPIP(upcoming);
}

/* [ê¸°íƒ€ í•„ìˆ˜ ë¡œì§] */
async function togglePIP() { const video = document.getElementById('pip-video'); const canvas = document.getElementById('pip-canvas'); if (document.pictureInPictureElement) { await document.exitPictureInPicture(); } else { try { video.srcObject = canvas.captureStream(30); await video.play(); await video.requestPictureInPicture(); } catch (e) { alert("ì‚¬ìš©ì ì•¡ì…˜ í›„ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤."); } } }
function formatTimerFull(ms) { if (ms < 0) return "00:00:00"; const s = Math.floor(ms / 1000); return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
function formatSimple(s) { if(s<0) return "00:00"; return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
function safeKey(n) { if (!st._keyCache[n]) st._keyCache[n] = "b" + fnv1a32(String(n)).toString(36); return st._keyCache[n]; }
function fnv1a32(str) { let h = 0x811c9dc5; for (let i=0; i<str.length; i++) { h ^= str.charCodeAt(i); h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0; } return h >>> 0; }
function save() { localStorage.setItem(`v32_data_${st.profile}`, JSON.stringify({ timers: st.timers, pins: st.pins, auto: st.autoRotate, view: st.viewMode })); }
function switchProfile(p) { st.profile = p; const d = JSON.parse(localStorage.getItem(`v32_data_${p}`)) || {}; st.timers = d.timers || []; st.pins = d.pins || []; st.autoRotate = d.auto !== undefined ? d.auto : true; st.viewMode = d.view || 'main'; renderSched(); }
function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active')); el.classList.add('active'); if (id === 'calc') updateZenSelect(); }
function updateZenSelect() { const zSel = document.getElementById('zc-sel'); if(!zSel) return; const active = [...st.timers].filter(t => t.t > Date.now()).sort((a, b) => a.t - b.t); let h = '<option value="">ë³´ì • ë³´ìŠ¤ ì„ íƒ (ì„ë°•ìˆœ)</option>'; active.forEach(tm => h += `<option value="${tm.n}">[${formatTimerFull(tm.t-Date.now())}] ${tm.n}</option>`); zSel.innerHTML = h; }
function renderSched() {
    const cont = document.getElementById('sched-cont'); let html = ''; const timerMap = new Map(st.timers.map(t => [t.n, t]));
    const filterGroups = st.viewMode === 'main' ? bosses.filter(g => !g.i) : bosses;
    filterGroups.forEach(g => {
        html += `<div class="card mb-3"><div class="font-black text-xs text-slate-400 mb-3 uppercase tracking-widest">${g.w}</div><div class="space-y-1">`;
        g.b.forEach(b => {
            const tm = timerMap.get(b.n); const zenTxt = tm ? new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}) : '--:--';
            html += `<div class="boss-row"><button onclick="togglePin('${b.n}')" class="text-lg">${st.pins.includes(b.n)?'ğŸ“Œ':'ğŸ“'}</button><b class="text-sm truncate">${b.n}</b><input type="text" data-name="${b.n}" class="v-in" placeholder="0230" onkeydown="if(event.key==='Enter') handleEnterNav(this)"><div id="zen-${safeKey(b.n)}" class="font-mono font-bold text-slate-600">${zenTxt}</div><button onclick="setTimer('${b.n}', ${b.r*60}, 'Kill')" class="bg-blue-900 text-white text-[10px] py-1 rounded">Kill</button><button onclick="delTimer('${b.n}')" class="text-red-400 font-bold">Ã—</button></div>`;
        });
        html += `</div></div>`;
    });
    cont.innerHTML = html; updatePinBadges();
}
function setTimer(n, s, raw) { const t = Date.now() + st.timeOffsetMs + (s * 1000); st.timers = st.timers.filter(x => x.n !== n); st.timers.push({ n, t, lastD: s + 1, m10: false, m5: false, m1: false }); save(); updateZenSelect(); }
function killPinnedGroupWithTime() { const rawTime = document.getElementById('group-kill-time').value.trim(); if (!st.pins.length || !rawTime) return; const val = parseInt(rawTime.replace(/[^0-9]/g, '')); let hh = Math.floor(val/100), mm = val%100; let killDate = new Date(); killDate.setHours(hh, mm, 0, 0); if (killDate.getTime() > Date.now() + 3600000) killDate.setDate(killDate.getDate() - 1); st.pins.forEach(name => { const targetZenTs = killDate.getTime() + ((BOSS_RESPAWN_MAP[name] || 120) * 60 * 1000); setTimer(name, (targetZenTs - Date.now())/1000, ""); }); document.getElementById('group-kill-time').value = ""; }
function openBulkModal() {
    const inner = document.getElementById('bulk-inner'); let html = `<div class="card-title mb-6 uppercase">Bulk Edit Center</div><div class="overflow-y-auto max-h-[60vh] border rounded-xl shadow-inner"><table class="w-full text-left"><thead><tr class="bg-slate-50 text-[10px] uppercase border-b"><th class="p-4">Boss</th><th class="p-4">Remain</th></tr></thead><tbody>`;
    const list = st.viewMode === 'main' ? bosses.filter(g => !g.i) : bosses;
    list.forEach(g => g.b.forEach(b => html += `<tr><td class="p-3 border-b font-bold text-slate-700">${b.n}</td><td class="p-3 border-b"><input type="text" class="bulk-in v-in w-full" data-name="${b.n}" placeholder="ì‹œë¶„ ë˜ëŠ” ë¶„ ì´ˆ"></td></tr>`));
    inner.innerHTML = html + `</tbody></table></div>`; document.getElementById('bulk-modal').style.display = 'flex';
}
function applyBulkUpdate() { document.querySelectorAll('.bulk-in').forEach(el => { const s = parseSmart(el.value); if (s > 0) setTimer(el.dataset.name, s, el.value); }); closeBulkModal(); }
function closeBulkModal() { document.getElementById('bulk-modal').style.display = 'none'; }
function updatePinBadges() { const box = document.getElementById('pin-badge-list'); if (box) box.innerHTML = st.pins.map(name => `<span class="bg-blue-800 text-white text-[9px] px-2 py-0.5 rounded font-bold shadow-sm">${name}</span>`).join(''); }
function togglePin(n) { const i = st.pins.indexOf(n); if(i>-1) st.pins.splice(i,1); else st.pins.push(n); save(); renderSched(); updatePinBadges(); }
function btl(type) { const now = Date.now(); if(type==='start') { st.battle.s=now; st.battle.k=null; } else if(type==='kwang') { if(!st.battle.s) return; st.battle.k=now; st.battle.est=Math.floor(((now-st.battle.s)/1000)*0.51); } else if(type==='kill') { st.battle.s=null; st.battle.k=null; } }
function togglePwr() { st.on = !st.on; document.getElementById('pwr').style.color = st.on ? '#22c55e' : '#94a3b8'; document.body.classList.toggle('system-off', !st.on); }
function addLog(m) { const b = document.getElementById('logs'); if(b) { const d = document.createElement('div'); d.innerHTML = `<span class="text-slate-400 font-bold">[${new Date().toLocaleTimeString()}]</span> ${m}`; b.appendChild(d); } }
function triggerAlert(n, m) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(`${n} ${m}ì…ë‹ˆë‹¤.`); u.lang = 'ko-KR'; window.speechSynthesis.speak(u); }
function handleSearch(v) { const s = v.toLowerCase(); document.querySelectorAll('.boss-row').forEach(r => r.style.display = r.querySelector('b').innerText.toLowerCase().includes(s) ? 'grid' : 'none'); }
function handleEnterNav(el) { const s = parseSmart(el.value); if (s > 0) setTimer(el.dataset.name, s, el.value); const inputs = Array.from(document.querySelectorAll('.v-in')); const idx = inputs.indexOf(el); for (let i = idx + 1; i < inputs.length; i++) { if (inputs[i].offsetParent !== null) { inputs[i].focus(); inputs[i].select(); break; } } }
function applyZenCalc(mode) { const s = parseSmart(document.getElementById('zc-in').value); if (s <= 0) return; setTimer(document.getElementById('zc-sel').value, s, ""); document.getElementById('zc-in').value = ""; tab('dash', document.querySelector('.nav-icon')); }
function updateZenPreview(v) { const s = parseSmart(v); document.getElementById('zc-remain').innerText = s > 0 ? formatSimple(s) : "--:--"; document.getElementById('zc-preview').innerText = s > 0 ? new Date(Date.now() + s*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:--"; }
function clearAllPins() { st.pins = []; save(); renderSched(); }
function delTimer(n) { st.timers = st.timers.filter(x => x.n !== n); save(); renderSched(); }
function confirmClear() { if(confirm("ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?")) { st.timers = []; save(); renderSched(); } }
function handleKeys(e) { if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return; if(e.key==='/'){e.preventDefault(); document.getElementById('search-boss').focus();} }

window.onload = () => { switchProfile('A'); setInterval(loop, 1000); lucide.createIcons(); };
</script>
</body>
</html>
