<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32.9 HD FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;800&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #1a237e; --primary-light: #e8eaf6; --border: #dee2e6; --danger: #d32f2f; --warning: #ef6c00; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: #f4f5f7; margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        body.system-off .content { filter: grayscale(1) brightness(0.9); pointer-events: none; }
        header, nav { pointer-events: auto !important; }
        nav { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; flex-shrink: 0; }
        .nav-brand { padding: 0 25px 20px; font-weight: 900; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: #6c757d; transition: 0.2s; gap: 12px; font-weight: 700; }
        .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .pane { display: none; width: 100%; max-width: 720px; animation: fadeIn 0.15s ease; }
        .pane.active { display: block; }
        .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .timer-big { font-family: 'JetBrains Mono'; font-size: 52px; font-weight: 800; color: var(--primary); margin: 10px 0; letter-spacing: -2px; }
        .timer-10m { color: #f59e0b !important; }
        .timer-5m { color: #ef4444 !important; }
        .timer-1m { color: #b91c1c !important; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .boss-row { display: grid; grid-template-columns: 35px 105px 1fr 100px 75px 35px; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f1f3f5; gap: 8px; }
        .v-in { height: 32px; width: 100%; border-radius: 6px; border: 1px solid #ced4da; text-align: center; font-family: 'JetBrains Mono'; font-weight: 700; font-size: 13px; }
        .v-in::placeholder { font-family: 'Inter'; font-weight: 400; font-size: 10px; color: #94a3b8; }
        .zen-time-display { font-family: 'JetBrains Mono'; font-weight: 700; text-align: right; color: #475569; }
        .log-box { font-family: 'JetBrains Mono'; font-size: 11px; height: 180px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; }
        .p-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 800; font-size: 11px; }
        .p-btn.active { background: var(--primary); color: #fff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
    </style>
</head>
<body onkeydown="handleKeys(event)">

<nav>
    <div class="nav-brand italic text-center text-blue-900 font-black uppercase tracking-tighter">B-OPS V32.9 HD</div>
    <div class="nav-item active" onclick="tab('dash', this)">ğŸ  Dashboard</div>
    <div class="nav-item" onclick="tab('sched', this)">ğŸ“… Boss Schedule</div>
    <div class="nav-item" onclick="tab('calc', this)">ğŸ–© ê³„ì‚°ê¸° (Calculator)</div>
    <div class="nav-item" onclick="tab('set-txt', this)">ğŸ•’ Text Sync</div>
    <div class="nav-item" onclick="togglePIP()">ğŸ“º Toggle HD-PiP</div>
</nav>

<main>
    <header>
        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
            <button class="p-btn active" data-p="A" onclick="switchProfile('A')">PROFILE A</button>
            <button class="p-btn" data-p="B" onclick="switchProfile('B')">PROFILE B</button>
        </div>
        <div class="flex items-center gap-4">
            <button class="p-btn border bg-white shadow-sm font-black" onclick="copyKakao('all')">ğŸ“‹ ì¹´í†¡ ë³µì‚¬</button>
            <div id="pwr" class="cursor-pointer text-2xl text-green-600 font-bold" onclick="togglePwr()">â»</div>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="bg-blue-900 p-4 rounded-2xl border border-blue-800 shadow-lg mb-6">
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <span class="text-white font-black text-xs uppercase tracking-widest flex items-center gap-2">
                            <span class="animate-pulse">â—</span> Pinned Group Ops
                        </span>
                        <span class="text-blue-300 text-[10px]">ğŸ“ ê³ ì •ëœ ë³´ìŠ¤: <span id="pin-count" class="text-white font-bold">0</span>ë§ˆë¦¬</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="group-kill-time" class="flex-1 h-12 rounded-xl text-center font-mono text-2xl border-none outline-none shadow-inner" placeholder="ì²˜ì¹˜ ì‹œê° (ì˜ˆ: 1000)">
                        <button onclick="killPinnedGroupWithTime()" class="bg-orange-500 text-white font-black px-6 py-2 rounded-xl shadow-md hover:bg-orange-600 transition active:scale-95 leading-tight text-xs">
                            ğŸ“Œ ì§€ì • ì‹œê°<br>ì¼ê´„ KILLED
                        </button>
                    </div>
                    <p class="text-blue-300 text-[9px] text-center">* ì…ë ¥í•œ ì‹œê°ì— ì²˜ì¹˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ë¦¬ì   ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div id="hero-card" class="card text-center py-8">
                <div id="d-name" class="text-3xl font-black mt-2 leading-none text-blue-900 italic">ëŒ€ê¸° ì¤‘</div>
                <div id="d-timer" class="timer-big">00:00:00</div>
                <div id="d-meta" class="text-sm text-gray-400 font-bold font-mono">-</div>
                <div id="top3-list" class="mt-8 text-left bg-gray-50 p-5 rounded-2xl border border-gray-100 space-y-2 font-mono text-sm"></div>
            </div>
            <div class="card"><div id="logs" class="log-box"></div></div>
        </div>

        <div id="sched" class="pane">
            <div class="card flex gap-3 items-center bg-gray-50 border-none mb-4 shadow-sm">
                <input type="text" id="search-boss" placeholder="ë³´ìŠ¤ í•„í„°..." class="border rounded-md px-3 py-1 text-sm flex-1 outline-none">
                <label class="text-xs font-bold flex gap-1 items-center cursor-pointer"><input type="checkbox" id="active-only" onchange="applyFilters()"> í™œì„±ë§Œ</label>
                <button class="p-btn border bg-white text-red-500 font-black" onclick="confirmClear()">CLEAR ALL</button>
            </div>
            <div id="sched-cont"></div>
        </div>

        <div id="calc" class="pane">
            <div class="grid grid-cols-2 gap-4">
                <div class="card shadow-md">
                    <h3 class="font-black mb-6 text-center text-lg italic border-b pb-2">ì   ê³„ì‚°ê¸° (ì„ë°•ìˆœ)</h3>
                    <div class="grid grid-cols-2 gap-2 mb-6 text-center font-mono">
                        <div class="bg-gray-50 p-4 border rounded-xl"><small class="text-gray-400 font-black">Remain</small><div id="zc-remain" class="text-2xl font-black text-gray-500">--:--</div></div>
                        <div class="bg-blue-50 p-4 border border-blue-100 rounded-xl"><small class="text-blue-400 font-black">Spawn</small><div id="zc-preview" class="text-2xl font-black text-red-500">--:--:--</div></div>
                    </div>
                    <select id="zc-sel" class="w-full h-11 border rounded-lg mb-4 font-bold px-3 bg-gray-50"></select>
                    <input type="text" id="zc-in" class="w-full h-14 text-center font-mono text-3xl border-2 border-blue-900 rounded-xl mb-4 bg-blue-50" placeholder="ì˜ˆ: 0430, 8 44" oninput="updateZenPreview(this.value)">
                    <div class="grid grid-cols-2 gap-2">
                        <button class="p-btn active h-12 text-[10px]" onclick="applyZenCalc('single')">ì„ íƒ ë³´ìŠ¤ ë³´ì •</button>
                        <button class="p-btn bg-orange-600 text-white h-12 text-[10px]" onclick="applyZenCalc('group')">ğŸ“Œ ê·¸ë£¹ ì¼ê´„ ë³´ì •</button>
                    </div>
                </div>
                <div class="card shadow-md">
                    <h3 class="font-black mb-6 text-center text-lg italic border-b pb-2 text-red-700">ê´‘ ê³„ì‚°ê¸°</h3>
                    <div class="grid grid-cols-2 gap-2 mb-10 text-center font-mono">
                        <div class="bg-gray-50 p-6 rounded-xl border"><small class="font-black text-gray-400 uppercase">ì „íˆ¬ ì§„í–‰</small><div id="b-elap" class="text-3xl font-black mt-2 text-slate-700">00:00</div></div>
                        <div class="bg-red-50 p-6 rounded-xl border border-red-100"><small class="font-black text-red-500 uppercase">ì˜ˆìƒ ì¡í˜</small><div id="b-timer" class="text-3xl font-black mt-2 text-red-600">--:--</div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <button class="p-btn bg-slate-700 text-white h-14 font-black" onclick="btl('start')">ì‹œì‘</button>
                        <button class="p-btn bg-orange-500 text-white h-14 font-black" onclick="btl('kwang')">ê´‘</button>
                        <button class="p-btn active h-14 font-black shadow-lg" onclick="btl('kill')">ì¡í˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="set-txt" class="pane">
            <div class="card shadow-md">
                <textarea id="txt-ed" class="w-full h-[520px] border p-6 font-mono text-sm rounded-2xl resize-none bg-gray-50 border-gray-200 outline-none"></textarea>
            </div>
        </div>
    </div>
</main>

<canvas id="pip-canvas" width="600" height="340" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline style="display:none;"></video>

<script>
/* [ë°ì´í„°] ë„ê· ë‹˜ ìš”ì²­ ìˆœì„œ ë° ëª…ì¹­ ì™„ì „ ê³ ì • */
const bosses = [
    { w: "ìš”íˆ°í•˜ì„", b: [{n:"íŒŒë¥´ë°”", r:120}, {n:"ì…€ë¡œë¹„ì•„", r:720}, {n:"íë‹ˆë¥´", r:720}, {n:"í˜í‹°", r:720}, {n:"ë°”ìš°í‹°", r:120}, {n:"ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì•¼ë¥¸", r:240}, {n:"í‹°ë¥´", r:1440}] },
    { w: "ë‹ˆë‹¤ë²¨ë¦¬ë¥´", b: [{n:"ë¼ì´ë…¸ë¥´", r:720}, {n:"ë¹„ìš”ë¥¸", r:720}, {n:"í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ë¸Œë¥€íë“œ", r:720}, {n:"ë¼íƒ€í† ìŠ¤í¬", r:240}, {n:"ìˆ˜ë“œë¦¬", r:720}, {n:"í† ë¥´", r:1440}] },
    { w: "ì•Œë¸Œí•˜ì„", b: [{n:"ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ë“œë¼ìš°ê·¸", r:240}, {n:"êµ´ë² ì´ê·¸", r:480}, {n:"ì˜¤ë”˜", r:1440}] },
    { w: "ë¬´ìŠ¤í í•˜ì„", b: [{n:"ë©”ê¸°ë¥´", r:120}, {n:"ì‹ ë§ˆë¼", r:720}, {n:"í—¤ë¥´ê°€ë¦„", r:120}, {n:"íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì—˜ë“œë£¬", r:720}, {n:"ìš°ë¡œë³´ë¡œìŠ¤", r:1440}, {n:"ìˆ˜ë¥´íŠ¸", r:1440}] },
    { w: "ì•„ìŠ¤ê°€ë¥´ë“œ", b: [{n:"ë°œë¦¬", r:120}, {n:"ë…¸íŠ¸", r:480}, {n:"ìƒ¤ë¬´í¬", r:120}, {n:"ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"ê·¸ë¡œì•„", r:1440}, {n:"ë¯¸ë¯¸ë¥´", r:240}] },
    { w: "ë‹ˆí”Œí•˜ì„", b: [{n:"íˆë¡œí‚¨", r:1440}, {n:"í˜¸ë“œ", r:1440}, {n:"í—¤ì´ë“œ", r:1440}, {n:"í”„ë ˆì´", r:1440}, {n:"ì´ë¯¸ë¥´", r:1440}] },
    { w: "ë°”ë‚˜í•˜ì„", b: [{n:"ì—˜ë””ë¥´", r:1440}, {n:"ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ìŠ¤ì¹´ë””", r:1440}, {n:"ì—ê¸°ë¥´", r:1440}] },
    { w: "ë˜ì „", b: [{n:"4ì¸µ", r:480}, {n:"7ì¸µ", r:480}, {n:"10ì¸µ", r:480}, {n:"ìµœí•˜ì¸µêµ´ë² ", r:480}, {n:"ìµœí•˜ì¸µê°•ê¸€", r:480}, {n:"ìµœí•˜ì¸µìŠ¤ë„¤ë¥´", r:480}] }
];

const BOSS_WORLD_MAP = {}; bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));
const BOSS_RESPAWN_MAP = {}; bosses.forEach(g => g.b.forEach(b => BOSS_RESPAWN_MAP[b.n] = b.r));

let st = { on: true, profile: 'A', timers: [], pins: [], battle: { s: null, k: null, est: 0 }, foldState: {}, timeOffsetMs: 0, _keyCache: {} };

/* [í•µì‹¬] ì§€ì • ì‹œê° ì¼ê´„ ì²˜ì¹˜ ë¡œì§ */
function killPinnedGroupWithTime() {
    const rawTime = document.getElementById('group-kill-time').value.trim();
    if (!st.pins.length) return alert("í•€(ğŸ“)ìœ¼ë¡œ ë³´ìŠ¤ë“¤ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    if (!rawTime) return alert("ì²˜ì¹˜ ì‹œê°ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1000).");

    const killSecs = parseSmart(rawTime);
    if (killSecs === 0 && rawTime !== "0") return alert("ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

    // ì…ë ¥ë°›ì€ ì‹œê°(HHMM ë“±)ì„ ì˜¤ëŠ˜ ë‚ ì§œì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
    const now = new Date();
    let killDate = new Date();
    
    // hhmm íŒŒì‹± ë¡œì§ì„ ì‹œê°ìœ¼ë¡œ í•´ì„ (v/100 -> ì‹œ, v%100 -> ë¶„)
    const val = parseInt(rawTime.replace(/[^0-9]/g, ''));
    let hh = 0, mm = 0;
    if (val >= 100) { hh = Math.floor(val/100); mm = val%100; } 
    else { mm = val; }
    
    killDate.setHours(hh, mm, 0, 0);
    
    // ë§Œì•½ ì„¤ì •í•œ ì‹œê°„ì´ í˜„ì¬ë³´ë‹¤ ë„ˆë¬´ ë¯¸ë˜ë¼ë©´ ì–´ì œë¡œ ê°„ì£¼ (ìœ ë™ì  ì²˜ë¦¬)
    if (killDate.getTime() > Date.now() + 3600000) killDate.setDate(killDate.getDate() - 1);

    const baseTs = killDate.getTime();

    if (!confirm(`${st.pins.length}ë§ˆë¦¬ ë³´ìŠ¤ë¥¼ [${killDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}] ì²˜ì¹˜ë¡œ ì¼ê´„ ë“±ë¡í•©ë‹ˆê¹Œ?`)) return;

    st.pins.forEach(name => {
        const respawnMin = BOSS_RESPAWN_MAP[name] || 120;
        const targetZenTs = baseTs + (respawnMin * 60 * 1000);
        
        st.timers = st.timers.filter(x => x.n !== name);
        st.timers.push({ n: name, t: targetZenTs, m10: false, m5: false, m1: false, lastD: 9999 });
    });

    save(); renderSched(); updateZenSelect();
    addLog(`Group Killed at ${rawTime}: ${st.pins.join(', ')}`);
    document.getElementById('group-kill-time').value = "";
}

/* [í•µì‹¬] hhmm ìš°ì„  íŒŒì‹± ì—”ì§„ */
function parseSmart(s) {
    if (!s) return 0; s = String(s).trim();
    const cleaned = s.replace(/[^\d:\s]/g, ' ').trim();
    const p = cleaned.split(/[:\s]+/).filter(Boolean).map(Number);
    if (p.length === 1) {
        const v = p[0];
        if (v >= 100 && v < 10000) return Math.floor(v/100)*3600 + (v%100)*60;
        if (v >= 10000) return Math.floor(v/10000)*3600 + Math.floor((v%10000)/100)*60 + (v%100);
        return v * 60;
    }
    if (p.length === 2) return p[0]*60 + p[1];
    if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
    return 0;
}

const __dom = { dName:null, dTimer:null, dMeta:null, top3:null, bElap:null, bTimer:null, pCount:null };
function cacheDom() { if(!__dom.dName) { __dom.dName=document.getElementById('d-name'); __dom.dTimer=document.getElementById('d-timer'); __dom.dMeta=document.getElementById('d-meta'); __dom.top3=document.getElementById('top3-list'); __dom.bElap=document.getElementById('b-elap'); __dom.bTimer=document.getElementById('b-timer'); __dom.pCount=document.getElementById('pin-count'); } }

function loop() {
    if (!st.on) return; cacheDom();
    const now = Date.now() + st.timeOffsetMs;
    st.timers = (st.timers || []).filter(t => (now - t.t) < 600000);
    if(__dom.pCount) __dom.pCount.innerText = st.pins.length;

    for (const tm of st.timers) {
        const d = Math.floor((tm.t - now) / 1000);
        const prev = tm.lastD || d;
        if (!tm.m10 && prev > 600 && d <= 600) { triggerAlert(tm.n, "10ë¶„ ì „"); tm.m10 = true; }
        if (!tm.m5 && prev > 300 && d <= 300) { triggerAlert(tm.n, "5ë¶„ ì „"); tm.m5 = true; }
        if (!tm.m1 && prev > 60 && d <= 60) { triggerAlert(tm.n, "1ë¶„ ì „"); tm.m1 = true; }
        tm.lastD = d;
        const el = document.getElementById(`zen-${safeKey(tm.n)}`);
        if (el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
    }

    const upcoming = [...st.timers].sort((a,b) => a.t - b.t).filter(t => t.t > now);
    const next = upcoming[0];
    if (next) {
        const rem = next.t - now;
        __dom.dName.innerText = next.n; __dom.dTimer.innerText = formatTimer(rem);
        __dom.dTimer.classList.remove('timer-10m', 'timer-5m', 'timer-1m');
        if (rem <= 60000) __dom.dTimer.classList.add('timer-1m');
        else if (rem <= 300000) __dom.dTimer.classList.add('timer-5m');
        else if (rem <= 600000) __dom.dTimer.classList.add('timer-10m');
    } else { __dom.dName.innerText = "ëŒ€ê¸° ì¤‘"; __dom.dTimer.innerText = "00:00:00"; }

    __dom.top3.innerHTML = upcoming.slice(0,3).map((t, i) => `<div class="flex justify-between border-b border-gray-100 py-2 items-center font-mono font-bold"><span>${i+1}. ${t.n}</span><span class="text-blue-900">${formatTimer(t.t-now).substring(3)}</span></div>`).join('') || "ì˜ˆì • ì—†ìŒ";
    
    if (st.battle.s && !st.battle.k) __dom.bElap.innerText = formatSimple((Date.now()-st.battle.s)/1000);
    else if (st.battle.k) __dom.bTimer.innerText = (st.battle.est-Math.floor((Date.now()-st.battle.k)/1000)>=0?"":"+")+formatSimple(Math.abs(st.battle.est-Math.floor((Date.now()-st.battle.k)/1000)));

    drawPIP(upcoming);
}

function drawPIP(list) {
    const canvas = document.getElementById('pip-canvas'); const ctx = canvas.getContext('2d');
    ctx.fillStyle = "#0f172a"; ctx.fillRect(0, 0, 600, 340);
    ctx.fillStyle = "#1e293b"; ctx.fillRect(0, 0, 600, 80);
    ctx.fillStyle = "#94a3b8"; ctx.font = "bold 24px Inter"; ctx.fillText("B-OPS COMMANDER HD+", 40, 50);
    if (list.length > 0) {
        const next = list[0]; const rem = next.t - (Date.now() + st.timeOffsetMs);
        let color = "#ffffff";
        if (rem <= 60000) color = "#ef4444"; else if (rem <= 300000) color = "#f87171"; else if (rem <= 600000) color = "#fbbf24";
        ctx.textAlign = "center"; ctx.fillStyle = color; ctx.font = "900 46px 'Noto Sans KR'"; ctx.fillText(next.n, 300, 155);
        ctx.fillStyle = "#ffffff"; ctx.font = "800 90px 'JetBrains Mono'"; ctx.fillText(formatTimer(rem).substring(3), 300, 260);
    }
    if (st.battle.s) {
        ctx.fillStyle = "#1e293b"; ctx.fillRect(0, 280, 600, 60); ctx.fillStyle = "#ffffff"; ctx.font = "800 24px 'JetBrains Mono'"; ctx.textAlign = "left";
        ctx.fillText("BATTLE: " + formatSimple((Date.now()-st.battle.s)/1000), 40, 320);
        if (st.battle.k) { ctx.fillStyle = "#f87171"; ctx.textAlign = "right"; const rem = st.battle.est-Math.floor((Date.now()-st.battle.k)/1000); ctx.fillText("PRED: " + (rem>=0?"":"+")+formatSimple(Math.abs(rem)), 560, 320); }
    }
}

function renderSched() {
    const cont = document.getElementById('sched-cont'); let html = ''; const timerMap = new Map(st.timers.map(t => [t.n, t]));
    bosses.forEach(g => {
        html += `<div class="world-section mb-3 border rounded-xl overflow-hidden shadow-sm"><div class="bg-gray-100 p-2 font-black text-[10px] flex justify-between cursor-pointer uppercase" onclick="toggleFold('${g.w}')"><span>${g.w}</span></div><div class="world-content">`;
        g.b.forEach(b => {
            const tm = timerMap.get(b.n); const zenTxt = tm ? new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}) : '--:--';
            html += `<div class="boss-row"><button onclick="togglePin('${b.n}')" class="text-lg">${st.pins.includes(b.n)?'ğŸ“Œ':'ğŸ“'}</button><b class="text-sm truncate">${b.n}</b><input type="text" data-name="${b.n}" class="v-in" placeholder="ì˜ˆ: 0430" onkeydown="if(event.key==='Enter') handleEnterNav(this)"><div class="zen-time-display"><div id="zen-${safeKey(b.n)}">${zenTxt}</div></div><button onclick="setTimer('${b.n}', ${b.r*60}, 'ìë™')" class="bg-blue-900 text-white text-[10px] py-1 rounded font-bold transition hover:bg-black uppercase">Kill</button><button onclick="delTimer('${b.n}')" class="text-red-400 font-bold text-lg hover:text-red-600 transition">Ã—</button></div>`;
        });
        html += `</div></div>`;
    });
    cont.innerHTML = html;
}

/* [Utility Functions] */
function safeKey(n) { if (!st._keyCache[n]) st._keyCache[n] = "b" + fnv1a32(String(n)).toString(36); return st._keyCache[n]; }
function fnv1a32(str) { let h = 0x811c9dc5; for (let i=0; i<str.length; i++) { h ^= str.charCodeAt(i); h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0; } return h >>> 0; }
function setTimer(n, s, raw) { const t = Date.now() + st.timeOffsetMs + (s * 1000); st.timers = st.timers.filter(x => x.n !== n); st.timers.push({ n, t, m10: false, m5: false, m1: false, lastD: s + 1 }); save(); renderSched_Partial(); updateZenSelect(); }
function renderSched_Partial() { st.timers.forEach(tm => { const el = document.getElementById(`zen-${safeKey(tm.n)}`); if (el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); }); }
function save() { localStorage.setItem(`v32_data_${st.profile}`, JSON.stringify({ timers: st.timers, pins: st.pins, fold: st.foldState })); }
function switchProfile(p) { st.profile = p; const d = JSON.parse(localStorage.getItem(`v32_data_${p}`)) || {}; st.timers = d.timers || []; st.pins = d.pins || []; st.foldState = d.fold || {}; renderSched(); }
function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); if (id === 'calc') updateZenSelect(); }
function btl(type) { const now = Date.now(); if(type==='start') { st.battle.s=now; st.battle.k=null; } else if(type==='kwang') { if(!st.battle.s) return; st.battle.k=now; st.battle.est=Math.floor(((now-st.battle.s)/1000)*0.51); } else if(type==='kill') st.battle.s=null; }
function updateZenSelect() { const zSel = document.getElementById('zc-sel'); const now = Date.now(); const active = [...st.timers].filter(t => t.t > now).sort((a, b) => a.t - b.t); let h = '<option value="">ë³´ìŠ¤ ì„ íƒ (ì„ë°•ìˆœ)</option>'; active.forEach(tm => h += `<option value="${tm.n}">[${formatTimer(tm.t-now).substring(3)}] ${tm.n}</option>`); const allNames = bosses.flatMap(g => g.b.map(b => b.n)); const timedSet = new Set(active.map(t => t.n)); allNames.forEach(n => { if(!timedSet.has(n)) h += `<option value="${n}">${n}</option>`; }); zSel.innerHTML = h; }
function formatTimer(ms) { if(ms<0) return "00:00:00"; const s=Math.floor(ms/1000); return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
function togglePin(n) { const i = st.pins.indexOf(n); if(i>-1) st.pins.splice(i,1); else st.pins.push(n); save(); renderSched(); }
function delTimer(n) { st.timers = st.timers.filter(x => x.n !== n); save(); renderSched(); }
function addLog(m) { const b = document.getElementById('logs'); const d = document.createElement('div'); d.innerHTML = `<span class="text-gray-500 font-bold font-mono text-[10px]">[${new Date().toLocaleTimeString()}]</span> ${m}`; b.appendChild(d); }
function togglePwr() { st.on = !st.on; document.getElementById('pwr').style.color = st.on ? '#16a34a' : '#94a3b8'; }
function triggerAlert(n, m) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(`${n} ${m}ì…ë‹ˆë‹¤.`); u.lang = 'ko-KR'; window.speechSynthesis.speak(u); }
async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }
function updateZenPreview(v) { const s = parseSmart(v); document.getElementById('zc-remain').innerText = s > 0 ? formatSimple(s) : "--:--"; document.getElementById('zc-preview').innerText = s > 0 ? new Date(Date.now() + s*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:----"; }
function handleKeys(e) { if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return; if(e.key==='/'){e.preventDefault(); document.getElementById('search-boss').focus();} }
function applyZenCalc(mode) { 
    const s = parseSmart(document.getElementById('zc-in').value); if (s <= 0) return alert("ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”."); 
    if (mode === 'single') setTimer(document.getElementById('zc-sel').value, s, "");
    else if (mode === 'group') st.pins.forEach(name => setTimer(name, s, ""));
    document.getElementById('zc-in').value = ""; updateZenPreview(""); tab('dash', document.querySelector('.nav-item'));
}
function handleEnterNav(el) { const s = parseSmart(el.value); if (s > 0) setTimer(el.dataset.name, s, el.value); const inputs = Array.from(document.querySelectorAll('.v-in')); const idx = inputs.indexOf(el); for (let i = idx + 1; i < inputs.length; i++) { if (inputs[i].offsetParent !== null) { inputs[i].focus(); inputs[i].select(); break; } } }
function confirmClear() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { st.timers = []; save(); renderSched(); updateZenSelect(); } }
function toggleFold(w) { st.foldState[w] = !st.foldState[w]; save(); renderSched(); }
function handleSearch(v) { const stm = v.toLowerCase(); document.querySelectorAll('.boss-row').forEach(row => { const n = row.querySelector('b').innerText.toLowerCase(); row.style.display = n.includes(stm) ? 'grid' : 'none'; }); }
function copyKakao(mode) { const now = Date.now(); let list = [...st.timers].sort((a, b) => a.t - b.t); if (mode === 'top3') list = list.filter(t => t.t > now).slice(0, 3); if (!list.length) return alert("ë°ì´í„° ì—†ìŒ"); const d = new Date(); const mm = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); let txt = mode === 'top3' ? `[${mm}.${dd} TOP3]\n` : `${mm}.${dd}\n`; list.forEach(t => { txt += `${new Date(t.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} ${t.n}\n`; }); navigator.clipboard.writeText(txt.trim()).then(() => alert("ë³µì‚¬ ì™„ë£Œ!")); }

window.onload = () => { switchProfile('A'); setInterval(loop, 1000); };
</script>
</body>
</html>
