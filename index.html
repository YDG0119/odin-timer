<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODIN COMMANDER - ULTIMATE V16</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8e24aa; --accent: #1e88e5; --bg: #f5f7fa;
            --card: #ffffff; --text: #333; --danger: #d32f2f;
            --sidebar-w: 75px;
        }

        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* 1. ì‚¬ì´ë“œë°” (image_ef427f ìŠ¤íƒ€ì¼ ì™„ë²½ ì¬í˜„) */
        nav { width: var(--sidebar-w); background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 15px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .nav-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; color: #777; transition: 0.3s; font-size: 24px; }
        .nav-item:hover { background: #f0f0f0; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(142, 36, 170, 0.3); }

        /* 2. ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; color: var(--primary); position: relative; }
        .power-btn { position: absolute; right: 25px; color: var(--primary); font-size: 1.5em; cursor: pointer; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .pane { display: none; } .pane.active { display: block; animation: fadeIn 0.4s ease; }

        /* 3. ë³´ìŠ¤ ì„¤ì • (image_fdc31b ë²¤ì¹˜ë§ˆí‚¹) */
        .text-editor { width: 100%; height: 500px; padding: 20px; border-radius: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 1.1em; line-height: 1.6; resize: none; box-sizing: border-box; }
        .btn-save-text { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; float: right; }

        /* 4. ìŠ¤ì¼€ì¤„ëŸ¬ (ë³¸ì„­/ì¹¨ê³µ íƒ­) */
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: #ddd; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--accent); color: white; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 0.85em; color: #666; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f3f5; }
        .btn-toggle { width: 45px; height: 24px; background: #ccc; border-radius: 12px; position: relative; cursor: pointer; transition: 0.3s; }
        .btn-toggle.on { background: var(--primary); }
        .btn-toggle::after { content: ''; width: 18px; height: 18px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
        .btn-toggle.on::after { left: 24px; }

        /* 5. ê´‘í­í™” ê³„ì‚°ê¸° (image_ef42b9 ì™„ë²½ ë³µì›) */
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .calc-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); text-align: center; }
        .calc-box { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .timer-unit { flex: 1; background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        .val-large { font-family: 'Orbitron'; font-size: 2.8em; color: #333; }
        .val-red { color: var(--danger); }
        .calc-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .c-btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 1.1em; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }
        #pip-video { position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

<nav>
    <div class="nav-item active" onclick="tab('home')">ğŸ </div>
    <div class="nav-item" onclick="tab('boss-settings')">ğŸ•’</div>
    <div class="nav-item" onclick="tab('sched')">ğŸ“…</div>
    <div class="nav-item" onclick="tab('calc')">ğŸ§®</div>
    <div class="nav-item" onclick="tab('settings-fixed')">âš™ï¸</div>
    <div class="nav-item" onclick="togglePIP()">ğŸ“º</div>
</nav>

<main>
    <header>ë³´ìŠ¤ ì•Œë¦¬ë¯¸ <span class="power-btn" onclick="location.reload()">â»</span></header>
    <div class="content">
        <div id="home" class="pane active">
            <div style="display:grid; grid-template-columns: 1fr 350px; gap: 25px;">
                <div style="background:white; padding:40px; border-radius:20px; text-align:center; border-top:6px solid var(--accent);">
                    <div style="color:#888; font-weight:bold;">ë‹¤ìŒ ë³´ìŠ¤</div>
                    <div id="next-name" style="font-size:2em; font-weight:bold; margin-top:10px;">--</div>
                    <div id="next-timer" style="font-family:Orbitron; font-size:5.5em; color:var(--accent);">00:00:00</div>
                </div>
                <div style="background:white; padding:25px; border-radius:20px;">
                    <h3>ë‹¤ê°€ì˜¤ëŠ” ë³´ìŠ¤</h3>
                    <div id="upcoming-list"></div>
                </div>
            </div>
        </div>

        <div id="boss-settings" class="pane">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <div>
                    <h2 style="margin:0;">ë³´ìŠ¤ ì„¤ì •</h2>
                    <small>í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ë©´ ë³´ìŠ¤ ì‹œê°„ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</small>
                </div>
                <button class="btn-save-text" onclick="parseTextSettings()">ë³´ìŠ¤ ì„¤ì • ì €ì¥</button>
            </div>
            <textarea id="boss-text-editor" class="text-editor" placeholder="12.28&#10;20:29 ì§€ê°7ì¸µ&#10;20:43 ë¼íƒ€í† ìŠ¤í¬"></textarea>
        </div>

        <div id="sched" class="pane">
            <div class="tab-group">
                <button id="tab-main" class="tab-btn active" onclick="switchServer('main')">ì˜¤ë”˜(ë³¸ì„­)</button>
                <button id="tab-invasion" class="tab-btn" onclick="switchServer('invasion')">ì¹¨ê³µì„œë²„</button>
            </div>
            <div id="sched-table-content"></div>
        </div>

        <div id="calc" class="pane">
            <div class="calc-grid">
                <div class="calc-card">
                    <h3>ì   ê³„ì‚°ê¸°</h3>
                    <div class="timer-unit" style="margin-bottom:20px;">
                        <div class="val-large" id="z-preview">00:00</div>
                    </div>
                    <select id="z-sel" style="width:100%; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #ddd;"></select>
                    <input type="text" id="z-in" placeholder="ì‹œ ë¶„ ì´ˆ (ì˜ˆ: 8 44)" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
                    <button class="c-btn" style="background:var(--accent); width:100%; margin-top:15px;" onclick="applyZ()">ë³´ìŠ¤ ì‹œê°„ ì—…ë°ì´íŠ¸</button>
                </div>

                <div class="calc-card">
                    <h3>ê´‘í­í™”(ê´‘) ê³„ì‚°ê¸°</h3>
                    <div class="calc-box">
                        <div class="timer-unit">
                            <small>ê²½ê³¼ ì‹œê°„</small>
                            <div class="val-large" id="g-elapsed">00:00</div>
                        </div>
                        <div class="timer-unit">
                            <small>ì¡í˜ ì˜ˆìƒ ì‹œê°„</small>
                            <div class="val-large val-red" id="g-predicted">--:--</div>
                        </div>
                    </div>
                    <select id="g-sel" style="width:100%; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #ddd;"></select>
                    <div class="calc-actions">
                        <button class="c-btn" style="background:#455a64;" onclick="gwangStart()">ì‹œì‘</button>
                        <button class="c-btn" style="background:#ffa000;" onclick="gwangGlow()">ê´‘</button>
                        <button class="c-btn" style="background:#d32f2f;" onclick="gwangKill()">ì¡í˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-fixed" class="pane">
            <div style="background:white; padding:30px; border-radius:20px;">
                <h3>ê³ ì • ì•Œë¦¼ ì„¤ì • (ëŒ€ë¥™ì¹¨ëµì / ë°œí• ë¼)</h3>
                <div id="fixed-list"></div>
            </div>
        </div>
    </div>
</main>

<canvas id="pip-canvas" width="220" height="100" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline></video>

<script>
    // 1. ë³´ìŠ¤ ì›ë³¸ ë°ì´í„° (ë³¸ì„­ & ì¹¨ê³µ í†µí•©)
    const bossMaster = [
        { n: "íŒŒë¥´ë°”", r: 120, w: "ìš”íˆ°" }, { n: "ì…€ë¡œë¹„ì•„", r: 720, w: "ìš”íˆ°" }, { n: "íë‹ˆë¥´", r: 720, w: "ìš”íˆ°" }, { n: "í˜í‹°", r: 720, w: "ìš”íˆ°" }, { n: "ë°”ìš°í‹°", r: 120, w: "ìš”íˆ°" }, { n: "ë‹ˆë“œí˜¸ê·¸", r: 1440, w: "ìš”íˆ°" }, { n: "ì•¼ë£¬", r: 240, w: "ìš”íˆ°" }, { n: "í‹°ë¥´", r: 1440, w: "ìš”íˆ°" },
        { n: "ë¼ì´ë…¸ë¥´", r: 720, w: "ë‹ˆë‹¤" }, { n: "ë¹„ìš”ë¥¸", r: 720, w: "ë‹ˆë‹¤" }, { n: "í—¤ë¥´ëª¨ë“œ", r: 240, w: "ë‹ˆë‹¤" }, { n: "ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r: 120, w: "ë‹ˆë‹¤" }, { n: "ë¸Œë¥€íë“œ", r: 720, w: "ë‹ˆë‹¤" }, { n: "ë¼íƒ€í† ìŠ¤í¬", r: 240, w: "ë‹ˆë‹¤" }, { n: "ìˆ˜ë“œë¦¬", r: 720, w: "ë‹ˆë‹¤" }, { n: "í† ë¥´", r: 1440, w: "ë‹ˆë‹¤" },
        { n: "ëŒ€ë¥™ ì¹¨ëµì", r: 0, w: "ê³ ì •" }, { n: "ë°œí• ë¼ ëŒ€ì „", r: 0, w: "ê³ ì •" }
    ];

    let currentServer = 'main'; // main or invasion
    let timers = JSON.parse(localStorage.getItem('odin_ultimate_timers')) || { main: [], invasion: [] };
    let bossActive = JSON.parse(localStorage.getItem('odin_ultimate_active')) || {};
    let alerted = { m5: [], m1: [] };
    
    // ê´‘í­í™” ê³„ì‚°ê¸° ë³€ìˆ˜
    let gwangInterval = null;
    let gwangStartTime = null;

    function init() {
        renderScheduler();
        renderDashboard();
        updateTextSettings(); // ë³´ìŠ¤ ì„¤ì • í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
        setInterval(updateDisplay, 1000);
        
        // ê³„ì‚°ê¸° ì…€ë ‰íŠ¸ë°•ìŠ¤ ì±„ìš°ê¸°
        const zSel = document.getElementById('z-sel');
        const gSel = document.getElementById('g-sel');
        bossMaster.forEach(b => {
            const opt = `<option value="${b.n}">${b.n}</option>`;
            zSel.innerHTML += opt; gSel.innerHTML += opt;
        });
    }

    // ğŸ•’ ë³´ìŠ¤ ì„¤ì • (í…ìŠ¤íŠ¸ ì—°ë™) ë¡œì§
    function updateTextSettings() {
        const now = new Date();
        let txt = `${now.getMonth()+1}.${now.getDate()}\n`;
        const activeTimers = timers[currentServer].filter(t => bossActive[t.n] !== false).sort((a,b) => a.t - b.t);
        activeTimers.forEach(t => {
            const date = new Date(t.t);
            const timeStr = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            txt += `${timeStr} ${t.n}\n`;
        });
        document.getElementById('boss-text-editor').value = txt;
    }

    function parseTextSettings() {
        const text = document.getElementById('boss-text-editor').value;
        const lines = text.split('\n');
        let currentMonthDay = "";
        
        const newTimers = [];
        lines.forEach(line => {
            if (line.includes('.')) currentMonthDay = line.trim();
            const match = line.match(/(\d{2}:\d{2})\s+(.+)/);
            if (match && currentMonthDay) {
                const [m, d] = currentMonthDay.split('.').map(Number);
                const [hh, mm] = match[1].split(':').map(Number);
                const target = new Date(new Date().getFullYear(), m - 1, d, hh, mm, 0).getTime();
                newTimers.push({ n: match[2].trim(), t: target });
            }
        });
        
        timers[currentServer] = newTimers;
        save();
        alert("ë³´ìŠ¤ ì„¤ì •ì´ íƒ€ì´ë¨¸ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        tab('home');
    }

    // ğŸ“… ìŠ¤ì¼€ì¤„ëŸ¬ & ì˜¨ì˜¤í”„
    function renderScheduler() {
        const container = document.getElementById('sched-table-content');
        let html = `<table><thead><tr><th>ë³´ìŠ¤ëª…</th><th>ì˜¨/ì˜¤í”„</th><th>ë‚¨ì€ ì‹œê°„</th><th>ì˜ˆìƒ ì  </th><th>ë™ì‘</th></tr></thead><tbody>`;
        bossMaster.filter(b => b.w !== 'ê³ ì •').forEach(b => {
            const isActive = bossActive[b.n] !== false;
            html += `
                <tr>
                    <td><strong>${b.n}</strong></td>
                    <td><div class="btn-toggle ${isActive?'on':''}" onclick="toggleActive('${b.n}')"></div></td>
                    <td><input type="text" class="v-in" data-name="${b.n}" placeholder="ë¶„ ì…ë ¥"></td>
                    <td id="zen-${b.n}" style="font-family:monospace; color:#888;">--:--</td>
                    <td><button style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="autoZen('${b.n}', ${b.r})">ì¡ìŒ</button></td>
                </tr>`;
        });
        container.innerHTML = html + `</tbody></table>`;
        
        // ì—”í„° ì´ë™ ë¡œì§
        const ins = document.querySelectorAll('.v-in');
        ins.forEach((el, i) => el.addEventListener('keydown', (e) => {
            if(e.key==='Enter') { setTimer(el.dataset.name, el.value); if(ins[i+1]) ins[i+1].focus(); }
        }));
    }

    // ğŸ§® ê´‘í­í™” ê³„ì‚°ê¸° ì •ë°€ ë¡œì§ (ê²½ê³¼ ì‹œê°„ ì¹´ìš´íŠ¸)
    function gwangStart() {
        gwangStartTime = Date.now();
        if(gwangInterval) clearInterval(gwangInterval);
        gwangInterval = setInterval(() => {
            const diff = Date.now() - gwangStartTime;
            document.getElementById('g-elapsed').innerText = formatCounter(diff);
        }, 100);
    }
    
    function gwangGlow() {
        if(!gwangStartTime) return;
        const now = new Date();
        document.getElementById('g-predicted').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function gwangKill() {
        if(!gwangStartTime) return;
        clearInterval(gwangInterval);
        const name = document.getElementById('g-sel').value;
        const boss = bossMaster.find(b => b.n === name);
        if(boss) autoZen(name, boss.r);
        document.getElementById('g-elapsed').innerText = "00:00";
        document.getElementById('g-predicted').innerText = "--:--";
        alert(`${name} ì   ì‹œê°„ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ğŸ“º PIP ì„¤ì •: 1êµ¬ ì½¤íŒ©íŠ¸
    function drawPIP() {
        const ctx = document.getElementById('pip-canvas').getContext('2d');
        ctx.fillStyle = "#121212"; ctx.fillRect(0,0,220,100);
        const activeOnly = timers[currentServer].filter(t => bossActive[t.n] !== false).sort((a,b) => a.t - b.t);
        if(activeOnly.length > 0) {
            const t = activeOnly[0]; const d = t.t - Date.now();
            ctx.fillStyle = "#ffd700"; ctx.font = "bold 14px Orbitron"; ctx.fillText("NEXT BOSS", 10, 25);
            ctx.fillStyle = d < 300000 ? "#ff5252" : "#00e5ff"; ctx.font = "bold 22px Orbitron";
            ctx.fillText(t.n.substring(0,8), 10, 55); ctx.fillText(formatTimer(d), 10, 85);
        } else { ctx.fillStyle = "#555"; ctx.fillText("No Target", 10, 50); }
    }

    // [ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜]
    function formatCounter(ms) {
        const s = Math.floor(ms/1000) % 60; const m = Math.floor(ms/60000);
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function formatTimer(ms) {
        if(ms < 0) return "ZEN!!";
        const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000); const s = Math.floor((ms%60000)/1000);
        return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function tab(id) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); event.currentTarget.classList.add('active'); if(id==='boss-settings') updateTextSettings(); }
    function switchServer(s) { currentServer = s; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-'+s).classList.add('active'); renderScheduler(); }
    function toggleActive(n) { bossActive[n] = (bossActive[n] === false); save(); renderScheduler(); }
    function autoZen(n, r) { const t = Date.now() + (r * 60000); pushTimer(n, t); }
    function setTimer(n, v) { const s = parseSmart(v); if(s>0) pushTimer(n, Date.now()+(s*1000)); }
    function pushTimer(n, t) { const idx = timers[currentServer].findIndex(tm => tm.n === n); if(idx>-1) timers[currentServer][idx].t = t; else timers[currentServer].push({n, t}); save(); }
    function save() { localStorage.setItem('odin_ultimate_timers', JSON.stringify(timers)); localStorage.setItem('odin_ultimate_active', JSON.stringify(bossActive)); }
    function parseSmart(str) { 
        if(!str) return 0; const p = str.split(/[:\s]+/).filter(x=>x!=="").map(Number);
        if(p.length===3) return (p[0]*3600)+(p[1]*60)+p[2]; if(p.length===2) return (p[0]*60)+p[1]; return p[0]*60;
    }
    function updateDisplay() {
        const now = Date.now();
        const list = timers[currentServer].filter(t => bossActive[t.n] !== false).sort((a,b) => a.t - b.t);
        if(list.length > 0) { document.getElementById('next-name').innerText = list[0].n; document.getElementById('next-timer').innerText = formatTimer(list[0].t - now); }
        document.getElementById('upcoming-list').innerHTML = list.slice(1,8).map(t => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${t.n}</span><b>${formatTimer(t.t-now)}</b></div>`).join('');
        // ìŠ¤ì¼€ì¤„ëŸ¬ ì   ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        timers[currentServer].forEach(t => { const el = document.getElementById(`zen-${t.n}`); if(el) el.innerText = new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); });
        drawPIP();
    }
    async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }

    init();
</script>
</body>
</html>
