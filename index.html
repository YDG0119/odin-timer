<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32.30 HD FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;800&family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #1a237e; --border: #dee2e6; --danger: #ef4444; --warning: #f59e0b; --urgent: #b91c1c; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: #f4f5f7; margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        nav { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; }
        .nav-brand { padding: 0 25px 20px; font-weight: 900; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; }
        .nav-item { padding: 12px 25px; cursor: pointer; color: #6c757d; font-weight: 700; transition: 0.2s; }
        .nav-item.active { background: #e8eaf6; color: var(--primary); border-left: 4px solid var(--primary); }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .pane { display: none; width: 100%; max-width: 820px; animation: fadeIn 0.1s ease; }
        .pane.active { display: block; }
        .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; }
        .timer-big { font-family: 'JetBrains Mono'; font-size: 52px; font-weight: 800; color: var(--primary); letter-spacing: -2px; }
        .t-warn { color: var(--warning) !important; } .t-danger { color: var(--danger) !important; } .t-urgent { color: var(--urgent) !important; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .v-in { height: 34px; border-radius: 6px; border: 1px solid #ced4da; text-align: center; font-family: 'JetBrains Mono'; font-weight: 700; }
        .v-in::placeholder { font-family: 'Noto Sans KR'; font-weight: 500; font-size: 11px; color: #adb5bd; }
        .guide-box { background: #fff; border-top: 4px solid var(--primary); padding: 20px; border-radius: 12px; }
        .x-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .x-table th { background: #f8fafc; border: 1px solid #cbd5e1; padding: 8px; font-weight: 900; }
        .x-table td { border: 1px solid #cbd5e1; padding: 6px; text-align: center; }
        .row-warn { background: #fee2e2 !important; color: #b91c1c; }
        .member-chip { cursor: pointer; padding: 5px 12px; border-radius: 20px; background: #f1f5f9; border: 1px solid #e2e8f0; font-weight: 700; }
        .member-chip.selected { background: var(--primary); color: #fff; }
    </style>
</head>
<body>

<nav>
    <div class="nav-brand italic">B-OPS V32.30 HD</div>
    <div class="nav-item active" onclick="tab('dash', this)">ğŸ  Dashboard</div>
    <div class="nav-item" onclick="tab('sched', this)">ğŸ“… Boss Schedule</div>
    <div class="nav-item" onclick="tab('calc', this)">ğŸ–© Calculator</div>
    <div class="nav-item" onclick="tab('guild', this)">ğŸ‘¥ Guild Admin</div>
</nav>

<main>
    <header>
        <div class="flex gap-2">
            <button class="px-3 py-1 bg-blue-900 text-white rounded font-bold text-[10px]" onclick="switchProfile('A')">PROFILE A</button>
            <button class="px-3 py-1 bg-gray-200 rounded font-bold text-[10px]" onclick="switchProfile('B')">PROFILE B</button>
        </div>
        <div id="pwr" class="text-green-500 font-black cursor-pointer" onclick="togglePwr()">â— SYSTEM ON</div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="bg-blue-900 p-5 rounded-2xl shadow-lg mb-6">
                <div class="flex justify-between items-center text-white font-black text-[10px] mb-3">
                    <span>GROUP SYNC COMMAND</span>
                    <div id="pin-badge-list" class="flex gap-1"></div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="group-kill-time" class="flex-1 h-12 rounded-xl text-center font-mono text-2xl" placeholder="ì˜ˆ: 1000(ì‹œë¶„), 10 00(ë¶„ì´ˆ)">
                    <button onclick="killPinnedGroupWithTime()" class="bg-orange-500 text-white font-black px-6 rounded-xl text-xs transition active:scale-95">ğŸ“Œ ì¼ê´„ KILLED</button>
                </div>
            </div>
            
            <div id="hero-card" class="card text-center py-8 shadow-xl border-blue-50">
                <button onclick="togglePIP()" class="absolute top-4 right-4 text-gray-300 hover:text-blue-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                </button>
                <div id="d-name" class="text-3xl font-black text-blue-900 italic mb-1">ëŒ€ê¸° ì¤‘</div>
                <div id="d-timer" class="timer-big font-mono mb-4">00:00:00</div>
                <div id="top3-list" class="text-left bg-gray-50 p-4 rounded-xl space-y-2 font-mono text-[13px]"></div>
            </div>

            <div class="guide-box shadow-sm">
                <h4 class="font-black text-blue-900 text-sm mb-4 italic">ğŸ•’ ì‹œê°„ ì…ë ¥ ë§ˆìŠ¤í„° ê°€ì´ë“œ</h4>
                <div class="grid grid-cols-2 gap-6 text-[12px] font-bold">
                    <div class="border-r pr-4"><p class="text-gray-800 mb-1 underline">1. ì‹œë¶„ (ë¶™ì—¬ì“°ê¸°)</p><p class="text-blue-700">0230 â” 2ì‹œê°„ 30ë¶„</p></div>
                    <div><p class="text-gray-800 mb-1 underline">2. ë¶„ì´ˆ (ë„ì–´ì“°ê¸°)</p><p class="text-orange-600">02 30 â” 2ë¶„ 30ì´ˆ</p></div>
                </div>
            </div>
        </div>

        <div id="guild" class="pane">
            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-7 card h-[78vh] flex flex-col">
                    <h3 class="font-black text-lg mb-4">ğŸ“Š ê¸¸ë“œ í†µê³„ (Excel Style)</h3>
                    <div class="overflow-auto border rounded-lg flex-1">
                        <table class="x-table">
                            <thead><tr><th>ìºë¦­ëª…</th><th>ì „íˆ¬ë ¥</th><th>ëˆ„ì ì ìˆ˜</th><th>ëˆ„ì %</th><th>ìµœê·¼%</th><th>ì‚­ì œ</th></tr></thead>
                            <tbody id="guild-stats-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="new-name" class="v-in w-32" placeholder="ìºë¦­ëª…">
                        <input type="number" id="new-cp" class="v-in w-32" placeholder="ì „íˆ¬ë ¥">
                        <button onclick="addMember()" class="bg-blue-900 text-white px-4 rounded font-black text-xs">ì¶”ê°€</button>
                    </div>
                </div>
                <div class="col-span-5 card h-[78vh] flex flex-col">
                    <h3 class="font-black text-lg text-blue-900 italic mb-4">ğŸ›¡ï¸ ë ˆì´ë“œ ì°¸ì—¬ ê¸°ë¡</h3>
                    <select id="boss-weight" class="v-in w-full mb-4">
                        <option value="1">1ì : 2~5ì±• ëª¨ë“  ë³´ìŠ¤</option>
                        <option value="2">2ì : 6ì±•, 10ì¸µ, ì´ë‘”, ê±°ì </option>
                        <option value="3">3ì : 7ì±•, ì¶•ì ˆëŒ€ì, ìµœí•˜ì¸µ, ì§€ì˜¥</option>
                        <option value="5">5ì : ê³µì„±ì „</option>
                    </select>
                    <div id="entry-pool" class="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-xl border border-dashed border-slate-300 overflow-y-auto flex-1"></div>
                    <button onclick="submitRaidRecord()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-black text-lg shadow-xl mt-4">ê¸°ë¡ í™•ì •</button>
                </div>
            </div>
        </div>

        <div id="sched" class="pane">
            <div class="flex justify-between mb-4">
                <input type="text" id="search-boss" placeholder="ë³´ìŠ¤ í•„í„°..." class="border rounded-lg px-4 py-2 text-sm flex-1 mr-2" oninput="handleSearch(this.value)">
                <select id="view-mode-sel" class="border rounded-lg px-3 text-xs font-bold" onchange="st.viewMode = this.value; renderSched();">
                    <option value="main">ë³¸ì„­</option><option value="all">ë³¸ì„­+ì¹¨ê³µ</option>
                </select>
            </div>
            <div id="sched-cont"></div>
        </div>

        <div id="calc" class="pane">
            <div class="grid grid-cols-2 gap-4">
                <div class="card text-center"><h3 class="font-black mb-4 border-b pb-2">ì   ì •ë°€ ë³´ì •</h3><div id="zc-remain" class="text-2xl font-black mb-4">--:--</div><select id="zc-sel" class="v-in w-full mb-4"></select><input type="text" id="zc-in" class="v-in w-full text-3xl h-16 mb-4" placeholder="ì‹œë¶„ ë˜ëŠ” ë¶„ ì´ˆ" oninput="updateZenPreview(this.value)"><button onclick="applyZenCalc()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-black">ì—…ë°ì´íŠ¸</button></div>
                <div class="card text-center"><h3 class="font-black mb-4 border-b pb-2 text-red-600">ê´‘ ê³„ì‚°ê¸°</h3><div id="b-elap" class="text-3xl font-black mb-6">00:00</div><div class="grid grid-cols-3 gap-3"><button class="p-btn bg-slate-700 text-white h-14" onclick="btl('start')">ì‹œì‘</button><button class="p-btn bg-orange-500 text-white h-14" onclick="btl('kwang')">ê´‘</button><button class="p-btn bg-slate-900 text-white h-14" onclick="btl('kill')">ì¡í˜</button></div></div>
            </div>
        </div>
    </div>
</main>

<canvas id="pip-canvas" width="800" height="450" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline style="display:none;"></video>

<script>
/* [ë°ì´í„°] ì „ ì§€ì—­ ë³´ìŠ¤ ë¦¬ìŠ¤íŠ¸ */
const bosses = [
    { w: "ìš”íˆ°", i: false, b: [{n:"íŒŒë¥´ë°”", r:120}, {n:"ì…€ë¡œë¹„ì•„", r:720}, {n:"íë‹ˆë¥´", r:720}, {n:"í˜í‹°", r:720}, {n:"ë°”ìš°í‹°", r:120}, {n:"ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì•¼ë¥¸", r:240}, {n:"í‹°ë¥´", r:1440}] },
    { w: "ë‹ˆë‹¤", i: false, b: [{n:"ë¼ì´ë…¸ë¥´", r:720}, {n:"ë¹„ìš”ë¥¸", r:720}, {n:"í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ë¸Œë¥€íë“œ", r:720}, {n:"ë¼íƒ€í† ìŠ¤í¬", r:240}, {n:"ìˆ˜ë“œë¦¬", r:720}, {n:"í† ë¥´", r:1440}] },
    { w: "ì•Œë¸Œ", i: false, b: [{n:"ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ë“œë¼ìš°ê·¸", r:240}, {n:"êµ´ë² ì´ê·¸", r:480}, {n:"ì˜¤ë”˜", r:1440}] },
    { w: "ë¬´ìŠ¤í ", i: false, b: [{n:"ë©”ê¸°ë¥´", r:120}, {n:"ì‹ ë§ˆë¼", r:720}, {n:"í—¤ë¥´ê°€ë¦„", r:120}, {n:"íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì—˜ë“œë£¬", r:720}, {n:"ìš°ë¡œë³´ë¡œìŠ¤", r:1440}, {n:"ìˆ˜ë¥´íŠ¸", r:1440}] },
    { w: "ì•„ìŠ¤", i: false, b: [{n:"ë°œë¦¬", r:120}, {n:"ë…¸íŠ¸", r:480}, {n:"ìƒ¤ë¬´í¬", r:120}, {n:"ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"ê·¸ë¡œì•„", r:1440}, {n:"ë¯¸ë¯¸ë¥´", r:240}] },
    { w: "ë‹ˆí”Œ", i: false, b: [{n:"íˆë¡œí‚¨", r:1440}, {n:"í˜¸ë“œ", r:1440}, {n:"í—¤ì´ë“œ", r:1440}, {n:"í”„ë ˆì´", r:1440}, {n:"ì´ë¯¸ë¥´", r:1440}] },
    { w: "ë°”ë‚˜", i: false, b: [{n:"ì—˜ë””ë¥´", r:1440}, {n:"ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ìŠ¤ì¹´ë””", r:1440}, {n:"ì—ê¸°ë¥´", r:1440}] },
    { w: "ë˜ì „", i: false, b: [{n:"4ì¸µ", r:480}, {n:"7ì¸µ", r:480}, {n:"10ì¸µ", r:480}, {n:"ìµœí•˜ì¸µêµ´ë² ", r:480}, {n:"ìµœí•˜ì¸µê°•ê¸€", r:480}, {n:"ìµœí•˜ì¸µìŠ¤ë„¤ë¥´", r:480}] },
    { w: "ì¹¨ê³µ ìš”íˆ°", i: true, b: [{n:"ì¹¨ê³µ íŒŒë¥´ë°”", r:120}, {n:"ì¹¨ê³µ ì…€ë¡œë¹„ì•„", r:720}, {n:"ì¹¨ê³µ íë‹ˆë¥´", r:720}, {n:"ì¹¨ê³µ í˜í‹°", r:720}, {n:"ì¹¨ê³µ ë°”ìš°í‹°", r:120}, {n:"ì¹¨ê³µ ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì¹¨ê³µ ì•¼ë¥¸", r:240}, {n:"ì¹¨ê³µ í‹°ë¥´", r:1440}] },
    { w: "ì¹¨ê³µ ë‹ˆë‹¤", i: true, b: [{n:"ì¹¨ê³µ ë¼ì´ë…¸ë¥´", r:720}, {n:"ì¹¨ê³µ ë¹„ìš”ë¥¸", r:720}, {n:"ì¹¨ê³µ í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ì¹¨ê³µ ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ì¹¨ê³µ ë¸Œë¥€íë“œ", r:720}] },
    { w: "ì¹¨ê³µ ì•Œë¸Œ", i: true, b: [{n:"ì¹¨ê³µ ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ì¹¨ê³µ ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ì¹¨ê³µ ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ì¹¨ê³µ ë“œë¼ìš°ê·¸", r:240}, {n:"ì¹¨ê³µ êµ´ë² ì´ê·¸", r:480}] },
    { w: "ì¹¨ê³µ ë¬´ìŠ¤í ", i: true, b: [{n:"ì¹¨ê³µ ë©”ê¸°ë¥´", r:120}, {n:"ì¹¨ê³µ ì‹ ë§ˆë¼", r:720}, {n:"ì¹¨ê³µ í—¤ë¥´ê°€ë¦„", r:120}, {n:"ì¹¨ê³µ íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì¹¨ê³µ ì—˜ë“œë£¬", r:720}] },
    { w: "ì¹¨ê³µ ì•„ìŠ¤", i: true, b: [{n:"ì¹¨ê³µ ë°œë¦¬", r:120}, {n:"ì¹¨ê³µ ë…¸íŠ¸", r:480}, {n:"ì¹¨ê³µ ìƒ¤ë¬´í¬", r:120}, {n:"ì¹¨ê³µ ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"ì¹¨ê³µ ê·¸ë¡œì•„", r:1440}, {n:"ì¹¨ê³µ ë¯¸ë¯¸ë¥´", r:240}] },
    { w: "ì¹¨ê³µ ë‹ˆí”Œ", i: true, b: [{n:"ì¹¨ê³µ íˆë¡œí‚¨", r:1440}, {n:"ì¹¨ê³µ í˜¸ë“œ", r:1440}, {n:"ì¹¨ê³µ í—¤ì´ë“œ", r:1440}, {n:"ì¹¨ê³µ í”„ë ˆì´", r:1440}, {n:"ì¹¨ê³µ ì´ë¯¸ë¥´", r:1440}] },
    { w: "ì¹¨ê³µ ë°”ë‚˜", i: true, b: [{n:"ì¹¨ê³µ ì—˜ë””ë¥´", r:1440}, {n:"ì¹¨ê³µ ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ì¹¨ê³µ ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ì¹¨ê³µ ìŠ¤ì¹´ë””", r:1440}, {n:"ì¹¨ê³µ ì—ê¸°ë¥´", r:1440}] }
];

const BOSS_RESPAWN_MAP = {}; bosses.forEach(g => g.b.forEach(b => BOSS_RESPAWN_MAP[b.n] = b.r));
let st = { timers: [], pins: [], autoRotate: true, viewMode: 'main', battle: { s: null, k: null, est: 0 }, guild: [], guildPointsPossible: 0, selectedNames: [], profile: 'A', _keyCache: {} };

/* [í•µì‹¬] í•˜ì´ë¸Œë¦¬ë“œ íŒŒì‹± ì—”ì§„ */
function parseSmart(s) {
    if (!s) return 0; s = String(s).trim(); let total = 0;
    if (s.match(/[ì¼ì‹œë¶„ì´ˆ]/)) {
        const d = s.match(/(\d+)ì¼/); const h = s.match(/(\d+)ì‹œê°„|(\d+)ì‹œ/); const m = s.match(/(\d+)ë¶„/); const sc = s.match(/(\d+)ì´ˆ/);
        if (d) total += parseInt(d[1]) * 86400; if (h) total += parseInt(h[1] || h[2]) * 3600; if (m) total += parseInt(m[1]) * 60; if (sc) total += parseInt(sc[1]); return total;
    }
    if (s.includes(' ')) { const p = s.split(/\s+/).map(Number); if (p.length === 2) return p[0]*60 + p[1]; if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2]; }
    const v = parseInt(s.replace(/[^0-9]/g, ''));
    if (v >= 100 && v < 10000) return Math.floor(v/100)*3600 + (v%100)*60;
    if (v >= 10000) return Math.floor(v/10000)*3600 + Math.floor((v%10000)/100)*60 + (v%100);
    return v * 60;
}

/* [UI/Loop] */
function loop() {
    const now = Date.now();
    for (const tm of st.timers) {
        if (st.autoRotate && now > tm.t) { tm.t += (BOSS_RESPAWN_MAP[tm.n] || 120) * 60 * 1000; tm.lastD = 9999; }
        const zenEl = document.getElementById(`zen-${safeKey(tm.n)}`);
        if (zenEl) zenEl.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
    }
    const upcoming = [...st.timers].sort((a,b) => a.t - b.t).filter(t => t.t > now);
    const next = upcoming[0];
    if (next) { 
        const rem = next.t - now; document.getElementById('d-name').innerText = next.n; document.getElementById('d-timer').innerText = formatTimerFull(rem);
        document.getElementById('d-timer').className = "timer-big font-mono " + (rem <= 60000 ? "t-urgent" : rem <= 300000 ? "t-danger" : rem <= 600000 ? "t-warn" : "");
    }
    document.getElementById('top3-list').innerHTML = upcoming.slice(0,3).map((t, i) => `<div class="flex justify-between font-bold"><span>${i+1}. ${t.n}</span><span class="text-blue-900">${formatTimerFull(t.t-now)}</span></div>`).join('') || "ì˜ˆì • ì—†ìŒ";
    
    if (st.battle.s && !st.battle.k) document.getElementById('b-elap').innerText = formatSimple((now-st.battle.s)/1000);
    else if (st.battle.k) { const rem = st.battle.est - Math.floor((now-st.battle.k)/1000); document.getElementById('b-timer').innerText = (rem>=0?"":"+")+formatSimple(Math.abs(rem)); }
    drawPIP(upcoming);
}

/* [ê¸¸ë“œ ê´€ë¦¬] */
function addMember() { const n = document.getElementById('new-name').value.trim(); const cp = parseInt(document.getElementById('new-cp').value) || 0; if(!n) return; st.guild.push({ n, cp, rec: [] }); document.getElementById('new-name').value = ''; document.getElementById('new-cp').value = ''; save(); renderGuildAll(); }
function submitRaidRecord() {
    if(!st.selectedNames.length) return; const weight = parseInt(document.getElementById('boss-weight').value);
    st.guildPointsPossible += weight;
    st.guild.forEach(m => m.rec.push(st.selectedNames.includes(m.n) ? weight : 0));
    st.selectedNames = []; save(); renderGuildAll(); alert("ê¸°ë¡ ì™„ë£Œ");
}
function renderGuildAll() {
    const body = document.getElementById('guild-stats-body');
    body.innerHTML = st.guild.map((m, i) => {
        const myTotal = m.rec.reduce((a,b)=>a+b, 0);
        const cumRate = st.guildPointsPossible === 0 ? 0 : Math.round((myTotal / st.guildPointsPossible) * 100);
        const recent = m.rec.slice(-10); const recentRate = recent.length === 0 ? 0 : Math.round((recent.reduce((a,b)=>a+b,0) / (recent.length * 3)) * 100);
        return `<tr class="${cumRate < 50 ? 'row-warn' : ''}"><td>${m.n}</td><td>${m.cp.toLocaleString()}</td><td>${myTotal}ì </td><td class="font-black">${cumRate}%</td><td>${recentRate}%</td><td><button onclick="delMember(${i})">Ã—</button></td></tr>`;
    }).join('');
    document.getElementById('entry-pool').innerHTML = st.guild.map(m => `<div class="member-chip ${st.selectedNames.includes(m.n)?'selected':''}" onclick="toggleEntry('${m.n}')">${m.n}</div>`).join('');
}

/* [PiP/Utility] */
function drawPIP(list) {
    const canvas = document.getElementById('pip-canvas'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,800,450); ctx.fillStyle="#fff"; ctx.fillRect(0,0,800,450);
    if(list.length>0){const n=list[0], rem=n.t-Date.now(); ctx.textAlign="center"; ctx.fillStyle="#1e3a8a"; ctx.font="900 80px 'Noto Sans KR'"; ctx.fillText(n.n,400,130); let c="#444"; if(rem<=60000) c="#b91c1c"; else if(rem<=300000) c="#ef4444"; else if(rem<=600000) c="#f59e0b"; ctx.fillStyle=c; ctx.font="800 160px 'JetBrains Mono'"; ctx.fillText(formatTimerFull(rem),400,320);}
}
async function togglePIP() { const v=document.getElementById('pip-video'), c=document.getElementById('pip-canvas'); if(document.pictureInPictureElement) await document.exitPictureInPicture(); else { try{v.srcObject=c.captureStream(30); await v.play(); await v.requestPictureInPicture();}catch(e){} } }
function formatTimerFull(ms) { if (ms < 0) return "00:00:00"; const s = Math.floor(ms / 1000); return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
function safeKey(n) { if (!st._keyCache[n]) st._keyCache[n] = "b" + fnv1a32(String(n)).toString(36); return st._keyCache[n]; }
function fnv1a32(str) { let h = 0x811c9dc5; for (let i=0; i<str.length; i++) { h ^= str.charCodeAt(i); h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0; } return h >>> 0; }
function save() { localStorage.setItem(`v32_ultimate_data`, JSON.stringify(st)); }
function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); if(id==='guild') renderGuildAll(); }
function switchProfile(p) { st.profile = p; renderSched(); }
function killPinnedGroupWithTime() { const raw = document.getElementById('group-kill-time').value.trim(); if(!st.pins.length || !raw) return; const val = parseInt(raw.replace(/[^0-9]/g, '')); let hh = Math.floor(val/100), mm = val%100, killD = new Date(); killD.setHours(hh, mm, 0, 0); if (killD.getTime() > Date.now() + 3600000) killD.setDate(killD.getDate()-1); st.pins.forEach(name => setTimer(name, (killD.getTime() + (BOSS_RESPAWN_MAP[name]||120)*60*1000 - Date.now())/1000)); document.getElementById('group-kill-time').value = ""; }
function setTimer(n, s) { const t = Date.now() + (s * 1000); st.timers = st.timers.filter(x => x.n !== n); st.timers.push({ n, t, lastD: s + 1 }); save(); }
function renderSched() {
    const cont = document.getElementById('sched-cont'); let html = ''; const filter = st.viewMode === 'main' ? bosses.filter(g => !g.i) : bosses;
    filter.forEach(g => {
        html += `<div class="card mb-3"><div class="font-black text-xs text-slate-400 mb-3 uppercase tracking-widest">${g.w}</div>`;
        g.b.forEach(b => { const tm = st.timers.find(t=>t.n===b.n); html += `<div class="boss-row"><button onclick="togglePin('${b.n}')">${st.pins.includes(b.n)?'ğŸ“Œ':'ğŸ“'}</button><b class="truncate">${b.n}</b><input type="text" data-name="${b.n}" class="v-in w-24" placeholder="ì‹œë¶„ ë˜ëŠ” ë¶„ì´ˆ" onkeydown="if(event.key==='Enter') handleEnterNav(this)"><div id="zen-${safeKey(b.n)}" class="font-mono font-bold text-slate-600">${tm?new Date(tm.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}):'--:--'}</div><button onclick="setTimer('${b.n}', ${b.r*60})" class="bg-blue-900 text-white text-[10px] py-1 rounded">Kill</button></div>`; });
        html += `</div>`;
    });
    cont.innerHTML = html;
}
function togglePin(n) { const i = st.pins.indexOf(n); if(i>-1) st.pins.splice(i,1); else st.pins.push(n); renderSched(); }
function toggleEntry(name) { const i = st.selectedNames.indexOf(name); if(i > -1) st.selectedNames.splice(i, 1); else st.selectedNames.push(name); renderGuildAll(); }
function btl(type) { const now = Date.now(); if(type==='start') { st.battle.s=now; st.battle.k=null; } else if(type==='kwang') { if(!st.battle.s) return; st.battle.k=now; st.battle.est=Math.floor(((now-st.battle.s)/1000)*0.51); } else if(type==='kill') { st.battle.s=null; st.battle.k=null; } }
function handleSearch(v) { const s = v.toLowerCase(); document.querySelectorAll('.boss-row').forEach(r => r.style.display = r.querySelector('b').innerText.toLowerCase().includes(s) ? 'grid' : 'none'); }
function handleEnterNav(el) { const s = parseSmart(el.value); if (s > 0) setTimer(el.dataset.name, s); }
function togglePwr() { alert("ê°ì‹œ ì‹œì‘"); }
function delMember(i) { st.guild.splice(i,1); save(); renderGuildAll(); }
function resetGuildData() { st.guild.forEach(m=>m.rec=[]); st.guildPointsPossible=0; save(); renderGuildAll(); }
window.onload = () => { const d = JSON.parse(localStorage.getItem('v32_ultimate_data')); if(d) st = {...st, ...d}; renderSched(); setInterval(loop, 1000); };
</script>
</body>
</html>
