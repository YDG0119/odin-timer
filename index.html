<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS CONTROL CENTER V31</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Orbitron:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f5f7; --bg-card: #ffffff; --border-color: #dee2e6;
            --primary: #1a237e; --primary-light: #e8eaf6;
            --text-main: #212529; --text-sub: #6c757d;
            --danger: #d32f2f; --warning: #ef6c00; --success: #2e7d32;
            --sidebar-w: 220px; --header-h: 60px;
        }

        /* Base Styles */
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-page); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        body.system-off { filter: grayscale(1) brightness(0.9); pointer-events: none; }
        body.system-off .global-controls { pointer-events: auto !important; filter: none !important; }

        /* Sidebar (Icon + Text Label) */
        nav { width: var(--sidebar-w); background: #ffffff; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; }
        .nav-brand { padding: 0 25px 20px; font-weight: 700; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: var(--text-sub); transition: 0.2s; gap: 12px; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: #f8f9fa; color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }

        /* Main Frame */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: var(--header-h); background: #fff; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #333; }
        .global-controls { display: flex; align-items: center; gap: 15px; }
        .btn-wl { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 11px; font-weight: 700; cursor: pointer; }
        .btn-wl.on { background: var(--success); color: #fff; border-color: var(--success); }

        .content { flex: 1; padding: 25px; overflow-y: auto; }
        .pane { display: none; max-width: 1300px; margin: 0 auto; animation: fadeIn 0.15s ease; }
        .pane.active { display: block; }
        .card { background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }

        /* Dashboard Layout */
        .dash-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .target-hero { text-align: center; padding: 30px 0; }
        .timer-val { font-family: 'Orbitron'; font-size: 48px; color: var(--primary); margin: 10px 0; }
        .imminent .timer-val { color: var(--danger); animation: blink 1s infinite; }
        
        .copy-group { display: flex; gap: 8px; justify-content: center; margin-top: 20px; }
        .btn-copy { height: 40px; padding: 0 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.1s; font-size: 13px; }
        .btn-top3 { background: var(--primary); color: #fff; }
        .btn-all { background: #f1f3f5; color: #495057; border: 1px solid #dee2e6; }

        .log-box { font-size: 12px; line-height: 1.8; height: 400px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #fafafa; padding: 15px; border-radius: 6px; border: 1px solid #eee; }

        /* Scheduler & Toolbar */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; }
        .toolbar input { height: 32px; padding: 0 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px; }
        .btn-tool { height: 32px; padding: 0 12px; border-radius: 6px; border: 1px solid #ced4da; background: #fff; cursor: pointer; font-weight: 500; font-size: 12px; }
        .btn-tool:hover { background: #f1f3f5; }

        /* Boss Row List */
        .world-section { margin-bottom: 10px; }
        .world-banner { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--primary); border-radius: 6px; cursor: pointer; font-weight: 700; }
        .boss-row { display: grid; grid-template-columns: 1fr 140px 100px 80px 60px; align-items: center; padding: 8px 15px; background: #fff; border-bottom: 1px solid #f1f3f5; gap: 10px; }
        .boss-row:hover { background: #fcfcfc; }
        .row-name { font-weight: 700; font-size: 14px; }
        .row-zen { font-family: 'Orbitron'; font-weight: 600; color: var(--text-sub); text-align: center; }
        .btn-row-kill { background: var(--primary); color: #fff; border: none; height: 32px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 12px; }
        .btn-row-del { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 18px; }

        /* Battle Board */
        .battle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .battle-unit { background: #f8f9fa; padding: 25px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .battle-val { font-family: 'Orbitron'; font-size: 36px; display: block; margin-top: 10px; }

        /* Text Editor */
        .txt-area { width: 100%; height: 500px; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; font-family: monospace; font-size: 14px; line-height: 1.8; resize: none; box-sizing: border-box; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        @keyframes blink { 50% { opacity: 0.6; } }
        #pip-video { position: fixed; opacity: 0; width: 1px; height: 1px; pointer-events: none; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            nav { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 5px; }
            .nav-brand { display: none; }
            .dash-grid { grid-template-columns: 1fr; }
            .boss-row { grid-template-columns: 1fr 100px 70px 50px; }
            .v-in { width: 80px; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-brand">B-CONTROL Desk</div>
    <div class="nav-item active" onclick="tab('dash', this)">üè† Dashboard</div>
    <div class="nav-item" onclick="tab('set-txt', this)">üïí Text Ops</div>
    <div class="nav-item" onclick="tab('sched', this)">üìÖ Schedule</div>
    <div class="nav-item" onclick="tab('battle', this)">‚öî Battle Ops</div>
    <div class="nav-item" onclick="tab('zen-calc', this)">üßÆ Forced Sync</div>
    <div class="nav-item" onclick="togglePIP()">üì∫ Toggle PIP</div>
</nav>

<main>
    <header>
        <div class="page-title" id="page-title-label">Dashboard</div>
        <div class="global-controls">
            <div id="wl-btn" class="btn-wl" onclick="toggleWakeLock()">üõ° ÌôîÎ©¥ Ïú†ÏßÄ OFF</div>
            <div id="pwr" class="global-pwr is-on" style="cursor:pointer; font-size:24px;" onclick="togglePwr()">‚èª</div>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="dash-grid">
                <div class="card target-hero" id="hero-card">
                    <div style="font-weight:700; color:var(--text-sub); font-size:14px;">CURRENT MISSION TARGET</div>
                    <div id="d-name" style="font-size:24px; font-weight:700; margin-top:15px;">ÎåÄÍ∏∞ Ï§ë</div>
                    <div id="d-timer" class="timer-val">00:00:00</div>
                    <div id="d-sub-info" style="color:var(--text-sub); font-weight:500;">-</div>
                    
                    <div style="margin: 20px auto; max-width: 350px; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px;" id="top3-list"></div>

                    <div class="copy-group">
                        <button class="btn-copy btn-top3" onclick="copyKakao('top3')">üì¢ Top3 Í≥µÏßÄ Î≥µÏÇ¨</button>
                        <button class="btn-copy btn-all" onclick="copyKakao('all')">üìã Ï†ÑÏ≤¥ Î™©Î°ù Î≥µÏÇ¨</button>
                    </div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:15px; font-size:14px;">EVENT LOGS</div>
                    <div id="logs" class="log-box"></div>
                </div>
            </div>
        </div>

        <div id="set-txt" class="pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Ops Manual Sync</h3>
                <button class="btn-copy btn-top3" style="height:36px;" onclick="saveText()">Ï†ÄÏû• ÌõÑ ÏãúÏä§ÌÖú Ï†ÅÏö©</button>
            </div>
            <textarea id="txt-ed" class="txt-area"></textarea>
        </div>

        <div id="sched" class="pane">
            <div class="toolbar">
                <input type="text" id="search-boss" placeholder="Î≥¥Ïä§Î™Ö Í≤ÄÏÉâ..." style="width:180px;" oninput="handleSearch(this.value)">
                <label style="font-weight:500; font-size:12px; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="active-only" onchange="applyFilters()"> ÌôúÏÑ± ÌÉÄÏù¥Î®∏Îßå
                </label>
                <div style="flex:1;"></div>
                <button class="btn-tool" onclick="toggleAllFolds(false)">Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞</button>
                <button class="btn-tool" onclick="toggleAllFolds(true)">Ï†ÑÏ≤¥ Ï†ëÍ∏∞</button>
                <button class="btn-tool" style="color:var(--danger);" onclick="clearAllTimers()">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
                <button class="btn-tool" onclick="openBackup()">Export/Import</button>
            </div>
            
            <div class="toolbar" style="background:#fff;">
                <span style="font-weight:700; font-size:12px; margin-right:10px;">Time Shift (ÌôúÏÑ±):</span>
                <input type="number" id="shift-min" style="width:60px;" value="0">
                <button class="btn-tool" onclick="applyShift(1)">+ Î∂Ñ Ï∂îÍ∞Ä</button>
                <button class="btn-tool" onclick="applyShift(-1)">- Î∂Ñ Ï∞®Í∞ê</button>
            </div>

            <div id="sched-cont"></div>
        </div>

        <div id="battle" class="pane">
            <div class="card">
                <h3 style="text-align:center; margin:0 0 20px 0;">Tactical Battle Tracker</h3>
                <div class="battle-grid">
                    <div class="battle-unit">
                        <span style="font-size:11px; font-weight:700; color:var(--text-sub);">ELAPSED TIME</span>
                        <span class="battle-val" id="b-elap">00:00</span>
                    </div>
                    <div class="battle-unit">
                        <span style="font-size:11px; font-weight:700; color:var(--text-sub);" id="b-label">ESTIMATED KILL (HP 33.8%)</span>
                        <span class="battle-val" id="b-timer" style="color:var(--danger);">--:--</span>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:20px;">
                    <button class="btn-copy btn-all" style="height:50px; background:#455a64; color:#fff;" onclick="btl('start')">START</button>
                    <button class="btn-copy btn-all" style="height:50px; background:var(--warning); color:#fff;" onclick="btl('kwang')">BERSERK</button>
                    <button class="btn-copy btn-top3" style="height:50px;" onclick="btl('kill')">KILLED</button>
                </div>
                <div id="btl-res" style="margin-top:20px; padding:15px; border-radius:8px; background:#f8f9fa; border:1px solid #eee; text-align:center; font-weight:700; display:none;"></div>
            </div>
        </div>

        <div id="zen-calc" class="pane">
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div>
                    <h3 style="margin-top:0;">Force Update</h3>
                    <select id="zc-sel" style="width:100%; height:40px; border-radius:8px; border:1px solid var(--border-color); font-weight:700; margin-bottom:15px;"></select>
                    <input type="text" id="zc-in" style="width:100%; height:45px; box-sizing:border-box; border:2px solid var(--primary); border-radius:8px; text-align:center; font-family:'Orbitron'; font-size:18px;" placeholder="Î∂Ñ Ï¥à ÏûÖÎ†• (Ïòà: 8 44)">
                    <button class="btn-copy btn-top3" style="width:100%; height:50px; margin-top:20px;" onclick="applyZenCalc()">ÏóÖÎç∞Ïù¥Ìä∏ Í∞ïÏ†ú Ï†ÅÏö©</button>
                </div>
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8f9fa; border-radius:12px; border:1px dashed var(--primary);">
                    <span style="font-weight:700; color:var(--primary);">NEXT SPAWN PREVIEW</span>
                    <span id="zc-preview" style="font-family:'Orbitron'; font-size:42px; color:var(--primary); margin:15px 0;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="backup-modal" class="modal">
    <div class="modal-card">
        <h3>System Backup / Restore</h3>
        <textarea id="backup-data"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:15px;">
            <button class="btn-tool" onclick="copyBackup()">ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨</button>
            <button class="btn-tool" style="background:var(--primary); color:#fff;" onclick="importData()">Îç∞Ïù¥ÌÑ∞ Î≥µÏõê</button>
            <button class="btn-tool" onclick="closeBackup()">Îã´Í∏∞</button>
        </div>
    </div>
</div>

<canvas id="pip-canvas" width="220" height="120" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline></video>

<script>
    const bosses = [
        { w: "ÏöîÌà∞Ìó§ÏûÑ", c: "#3f51b5", b: [{n:"ÌååÎ•¥Î∞î", r:120}, {n:"ÏÖÄÎ°úÎπÑÏïÑ", r:720}, {n:"ÌùêÎãàÎ•¥", r:720}, {n:"ÌéòÌã∞", r:720}, {n:"Î∞îÏö∞Ìã∞", r:120}, {n:"ÎãàÎìúÌò∏Í∑∏", r:1440}, {n:"ÏïºÎ£¨", r:240}, {n:"Ìã∞Î•¥", r:1440}] },
        { w: "ÎãàÎã§Î≤®Î¶¨Î•¥", c: "#43a047", b: [{n:"ÎùºÏù¥ÎÖ∏Î•¥", r:720}, {n:"ÎπÑÏöîÎ•∏", r:720}, {n:"Ìó§Î•¥Î™®Îìú", r:240}, {n:"Ïä§ÏπºÎùºÎãàÎ•¥", r:120}, {n:"Î∏åÎ•ÄÌûêÎìú", r:720}, {n:"ÎùºÌÉÄÌÜ†Ïä§ÌÅ¨", r:240}, {n:"ÏàòÎìúÎ¶¨", r:720}, {n:"ÌÜ†Î•¥", r:1440}] },
        { w: "ÏïåÎ∏åÌó§ÏûÑ", c: "#ef6c00", b: [{n:"Ïä§Î∞îÎ•¥Ìä∏", r:240}, {n:"ÎëêÎùºÏä§Î°úÎ•¥", r:480}, {n:"Î™®ÎÑ§Í∞ÄÎ¶Ñ", r:120}, {n:"ÎìúÎùºÏö∞Í∑∏", r:240}, {n:"Íµ¥Î≤†Ïù¥Í∑∏", r:480}, {n:"Ïò§Îîò", r:1440}] },
        { w: "Î¨¥Ïä§Ìé†ÌïòÏûÑ", c: "#c62828", b: [{n:"Î©îÍ∏∞Î•¥", r:120}, {n:"Ïã†ÎßàÎùº", r:720}, {n:"Ìó§Î•¥Í∞ÄÎ¶Ñ", r:120}, {n:"ÌÉïÍ∑∏Î¶¨Ïä§ÎãàÎ•¥", r:240}, {n:"ÏóòÎìúÎ£¨", r:720}, {n:"Ïö∞Î°úÎ≥¥Î°úÏä§", r:1440}, {n:"ÏàòÎ•¥Ìä∏", r:1440}] },
        { w: "ÏïÑÏä§Í∞ÄÎ•¥Îìú", c: "#7b1fa2", b: [{n:"Î∞úÎ¶¨", r:120}, {n:"ÎÖ∏Ìä∏", r:480}, {n:"ÏÉ§Î¨¥ÌÅ¨", r:120}, {n:"Ïä§ÏπºÎìúÎ©îÎ•¥", r:120}, {n:"ÌôîÏã†Í∑∏Î°úÏïÑ", r:1440}, {n:"ÎØ∏ÎØ∏Î•¥", r:240}] },
        { w: "ÎãàÌîåÌïòÏûÑ", c: "#0097a7", b: [{n:"ÌûàÎ°úÌÇ®", r:1440}, {n:"Ìò∏Îìú", r:1440}, {n:"Ìó§Ïù¥Îìú", r:1440}, {n:"ÎåÄÍµêÏ£º", r:1440}, {n:"ÌîÑÎ†àÏù¥", r:1440}, {n:"Ïù¥ÎØ∏Î•¥", r:1440}] },
        { w: "Î∞îÎÇòÌïòÏûÑ", c: "#689f38", b: [{n:"ÏóòÎîîÎ•¥", r:1440}, {n:"ÏïàÎÇòÎ•¥ÏóòÎîîÎ•¥", r:1440}, {n:"Ïä§Ïø®Îìú", r:1440}, {n:"Ïä§Ïπ¥Îîî", r:1440}, {n:"ÏóêÍ∏∞Î•¥", r:1440}] },
        { w: "ÎçòÏ†Ñ", c: "#455a64", b: [{n:"ÏßÄÍ∞ê7Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê4Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê10Ï∏µ", r:480}, {n:"ÏµúÌïòÏ∏µ Íµ¥Î≤†Ïù¥Í∑∏", r:480}] }
    ];

    const BOSS_WORLD_MAP = {};
    bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));

    let st = { 
        on: true, timers: JSON.parse(localStorage.getItem('v28_timers')) || [], 
        battle: { s: null, k: null, est: 0 },
        foldState: JSON.parse(localStorage.getItem('v29_fold_state')) || {},
        searchTerm: '', wakeLock: null
    };

    function init() {
        renderSched(); syncTxt();
        const zcSel = document.getElementById('zc-sel');
        bosses.forEach(g => g.b.forEach(b => zcSel.innerHTML += `<option value="${b.n}">${b.n}</option>`));
        document.getElementById('zc-in').addEventListener('input', (e) => {
            const sec = parseMinSec(e.target.value);
            document.getElementById('zc-preview').innerText = sec > 0 ? new Date(Date.now() + sec*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:--";
        });
        document.addEventListener('visibilitychange', () => { if (st.wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(true); });
        setInterval(loop, 500);
        addLog("Î∞∞ÌãÄ Ïä§ÌÖåÏù¥ÏÖò Í∏∞Îèô ÏÑ±Í≥µ");
    }

    function tab(id, el) {
        document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        document.getElementById('page-title-label').innerText = el.innerText.split(' ').slice(1).join(' ');
        if(id==='set-txt') syncTxt();
    }

    function handleEnterNav(el, idx) {
        const inputs = Array.from(document.querySelectorAll('.v-in'));
        const sec = parseSmart(el.value);
        if(sec > 0) setTimer(el.dataset.name, sec, el.value);
        for(let i = idx + 1; i < inputs.length; i++) {
            if(inputs[i].offsetParent !== null) { inputs[i].focus(); inputs[i].select(); break; }
        }
    }

    function loop() {
        if(!st.on) return;
        const now = Date.now();
        st.timers = st.timers.filter(t => (now - t.t) < 600000);
        st.timers.forEach(tm => {
            const d = Math.floor((tm.t - now) / 1000);
            if(d <= 300 && d > 295 && !tm.m5) { playTTS(`${tm.n} 5Î∂Ñ Ï†Ñ.`); tm.m5 = true; addLog(`${tm.n} T-300 ÏïåÎ¶º Î∞úÏÜ°`); }
            if(d <= 60 && d > 55 && !tm.m1) { playTTS(`${tm.n} 1Î∂Ñ Ï†Ñ.`); tm.m1 = true; addLog(`${tm.n} T-60 ÏïåÎ¶º Î∞úÏÜ°`); }
        });
        const list = [...st.timers].sort((a,b) => a.t - b.t);
        const upcoming = list.filter(t => t.t > now);
        const next = upcoming.length > 0 ? upcoming[0] : null;
        
        document.getElementById('d-name').innerText = next ? next.n : "No Active Mission";
        document.getElementById('d-timer').innerText = next ? formatTimer(next.t - now) : "00:00:00";
        document.getElementById('d-sub-info').innerText = next ? `SPAWN AT: ${new Date(next.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} (${BOSS_WORLD_MAP[next.n]})` : "-";
        document.getElementById('hero-card').className = (next && (next.t - now < 300000)) ? 'card target-hero imminent' : 'card target-hero';

        st.timers.forEach(tm => {
            const el = document.getElementById(`zen-${tm.n}`);
            if(el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
        });

        document.getElementById('top3-list').innerHTML = upcoming.slice(0, 3).map(t => `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;"><span>${t.n}</span><b style="color:var(--primary);">${formatTimer(t.t - now).substring(3)}</b></div>`).join('') || '<div style="color:#aaa; text-align:center;">Î¶¨Ï†† ÎåÄÍ∏∞ Î≥¥Ïä§ ÏóÜÏùå</div>';

        if(st.battle.s && !st.battle.k) document.getElementById('b-elap').innerText = formatSimple((now - st.battle.s)/1000);
        if(st.battle.k) {
            const rem = st.battle.est - Math.floor((now - st.battle.k)/1000);
            document.getElementById('b-timer').innerText = (rem >= 0 ? "" : "+") + formatSimple(Math.abs(rem));
        }
        drawPIP(upcoming);
    }

    function renderSched() {
        const c = document.getElementById('sched-cont'); let h = '';
        bosses.forEach(g => {
            const isFolded = st.foldState[g.w] === true;
            h += `<div class="world-section ${isFolded ? 'is-folded' : ''}" data-world="${g.w}">
                <div class="world-banner" style="border-left-color:${g.c}" onclick="if(event.target==this) toggleFold('${g.w}')">
                    <span>${isFolded ? '‚ñ∂' : '‚ñº'} ${g.w}</span>
                    <button class="world-del-btn" style="background:${g.c}; filter:brightness(0.8);" onclick="clearWorldTimers('${g.w}')">World Clear</button>
                </div>
                <div class="fold-content">`;
            g.b.forEach(b => {
                const sv = localStorage.getItem(`v28_in_${b.n}`) || '';
                const ex = st.timers.find(t => t.n === b.n);
                const zen = ex ? new Date(ex.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}) : '--:--';
                h += `<div class="boss-row" data-name="${b.n}">
                    <div class="row-name">${b.n}</div>
                    <input type="text" class="v-in" data-name="${b.n}" value="${sv}" placeholder="Î∂Ñ ÏûÖÎ†•">
                    <div id="zen-${b.n}" class="row-zen">${zen}</div>
                    <button class="btn-row-kill" onclick="setTimer('${b.n}',${b.r*60},'ÏûêÎèô')">Killed</button>
                    <button class="btn-row-del" onclick="delTimer('${b.n}')">√ó</button>
                </div>`;
            });
            h += `</div></div>`;
        });
        c.innerHTML = h;
        document.querySelectorAll('.v-in').forEach((el, i, ins) => el.onkeydown = (e) => { if(e.key === 'Enter') handleEnterNav(el, i); });
        applyFilters();
    }

    // üí° Battle logic
    function btl(type) {
        if(!st.on) return;
        const now = Date.now();
        if(type === 'start') { st.battle = { s: now, k: null, est: 0 }; document.getElementById('btl-res').style.display='none'; addLog("ÍµêÏ†Ñ Í∞úÏãú"); }
        else if(type === 'kwang') { if(!st.battle.s) return; st.battle.k = now; st.battle.est = Math.floor(((now - st.battle.s)/1000) * 0.51); addLog("Í¥ëÌè≠Ìôî Î∞úÏÉù (HP 33.8%)"); }
        else if(type === 'kill') { 
            if(st.battle.s) {
                const elap = Math.floor((now-st.battle.s)/1000);
                document.getElementById('btl-res').innerText = `Ï†ÑÌà¨ Ï¢ÖÎ£å: ${elap}Ï¥à ÏÜåÏöî`;
                document.getElementById('btl-res').style.display='block';
            }
            addLog("ÌÉÄÍ≤ü Ï≤òÏπò ÏôÑÎ£å"); st.battle = { s: null, k: null, est: 0 }; 
        }
    }

    // [Utility & Storage]
    function toggleFold(w) { st.foldState[w] = !st.foldState[w]; localStorage.setItem('v29_fold_state', JSON.stringify(st.foldState)); renderSched(); }
    function toggleAllFolds(s) { bosses.forEach(g => st.foldState[g.w] = s); localStorage.setItem('v29_fold_state', JSON.stringify(st.foldState)); renderSched(); }
    function setTimer(n, s, raw) { const t = Date.now() + (s * 1000); const i = st.timers.findIndex(x => x.n === n); const entry = { n, t, m5: false, m1: false }; if(i > -1) st.timers[i] = entry; else st.timers.push(entry); if(raw !== "ÏûêÎèô") localStorage.setItem(`v28_in_${n}`, raw); saveStore(); addLog(`${n} Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•Îê®`); }
    function delTimer(n) { st.timers = st.timers.filter(t => t.n !== n); localStorage.removeItem(`v28_in_${n}`); saveStore(); renderSched(); addLog(`${n} ÏÇ≠Ï†úÎê®`); }
    function saveStore() { localStorage.setItem('v28_timers', JSON.stringify(st.timers)); syncTxt(); }
    function handleSearch(v) { st.searchTerm = v.toLowerCase(); applyFilters(); }
    function applyFilters() {
        const activeOnly = document.getElementById('active-only').checked; const now = Date.now();
        document.querySelectorAll('.world-section').forEach(sec => {
            let visible = 0; sec.querySelectorAll('.boss-row').forEach(row => {
                const name = row.dataset.name.toLowerCase(); const timer = st.timers.find(t => t.n === row.dataset.name);
                const show = name.includes(st.searchTerm) && (!activeOnly || (timer && timer.t > now));
                row.style.display = show ? 'grid' : 'none'; if(show) visible++;
            });
            sec.style.display = visible > 0 ? 'block' : 'none';
        });
    }
    function addLog(m) { const box = document.getElementById('logs'); const div = document.createElement('div'); div.innerHTML = `<span style="color:#aaa;">[${new Date().toLocaleTimeString()}]</span> ${m}`; box.appendChild(div); }
    function parseSmart(s) { if(!s) return 0; const kor = s.match(/(\d+)ÏãúÍ∞Ñ\s*(\d+)Î∂Ñ/) || s.match(/(\d+)Î∂Ñ/); if(kor) return kor.length === 3 ? (parseInt(kor[1])*3600)+(parseInt(kor[2])*60) : parseInt(kor[1])*60; const p = s.split(/[:\s]+/).map(Number); if(p.length===3) return p[0]*3600+p[1]*60+p[2]; if(p.length===2) return p[0]*60+p[1]; return p[0]*60; }
    function parseMinSec(s) { if(!s) return 0; const p = s.split(/[:\s]+/).filter(x => x !== "").map(Number); return p.length >= 2 ? (p[0]*60)+p[1] : (p.length===1 ? p[0]*60 : 0); }
    function formatTimer(ms) { if(ms < 0) return "00:00:00"; const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000); const s = Math.floor((ms%60000)/1000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(Math.floor(s%60)).toString().padStart(2,'0')}`; }
    function playTTS(m) { if(st.on) { const u = new SpeechSynthesisUtterance(m); u.lang = 'ko-KR'; window.speechSynthesis.speak(u); } }
    function togglePwr() { st.on = !st.on; document.getElementById('pwr').classList.toggle('is-on', st.on); document.body.classList.toggle('system-off', !st.on); addLog(`System Power ${st.on?'ON':'OFF'}`); }
    function syncTxt() { const n = new Date(); let txt = `${n.getMonth()+1}.${n.getDate()}\n`; st.timers.sort((a,b)=>a.t-b.t).forEach(tm => { txt += `${new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} ${tm.n}\n`; }); document.getElementById('txt-ed').value = txt; }
    function saveText() { const lines = document.getElementById('txt-ed').value.split('\n'); let dl = ""; const nt = []; lines.forEach(l => { if(l.includes('.')) dl = l.trim(); const m = l.match(/(\d{2}:\d{2})\s+(.+)/); if(m && dl) { const [mon, day] = dl.split('.').map(Number); const [hh, mm] = m[1].split(':').map(Number); nt.push({ n: m[2].trim(), t: new Date(new Date().getFullYear(), mon-1, day, hh, mm).getTime(), m5:false, m1:false }); } }); st.timers = nt; saveStore(); renderSched(); tab('dash', document.querySelectorAll('.nav-item')[0]); addLog(" Ops Sync Complete"); }
    function copyKakao(mode) { const now = Date.now(); const list = mode === 'top3' ? st.timers.filter(t => t.t > now).sort((a,b) => a.t - b.t).slice(0, 3) : st.timers.sort((a,b) => a.t - b.t); if (list.length === 0) return alert("Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"); const dH = `[${new Date().toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short' })} Ïò§Îîò Î≥¥Ïä§ Ï††]`; let txt = mode === 'top3' ? dH + '\n' : `${new Date().getMonth()+1}.${new Date().getDate()}\n`; list.forEach((t, i) => { const zT = new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); if (mode === 'top3') txt += `${i+1}) ${zT} ${t.n} (${BOSS_WORLD_MAP[t.n] || "-"}) - ÎÇ®ÏùÄ ${formatTimer(t.t - now).substring(3)}\n`; else txt += `${zT} ${t.n}\n`; }); navigator.clipboard.writeText(txt.trim()).then(() => alert("Î≥µÏÇ¨ ÏôÑÎ£å")); }
    function applyShift(dir) { const mins = parseInt(document.getElementById('shift-min').value) || 0; if (mins <= 0) return; const now = Date.now(); st.timers = st.timers.map(t => { if (t.t > now) t.t += mins * 60000 * dir; return t; }); saveStore(); renderSched(); addLog(`Ï†ÑÏ≤¥ ÌÉÄÏù¥Î®∏ ${dir>0?'+':'-'}${mins}Î∂Ñ Ïù¥Îèô`); }
    function clearAllTimers() { if(confirm("Ï¥àÍ∏∞Ìôî?")) { st.timers = []; saveStore(); renderSched(); } }
    function clearWorldTimers(w) { if(confirm(`${w} Ï¥àÍ∏∞Ìôî?`)) { const bL = bosses.find(g => g.w === w).b.map(b => b.n); st.timers = st.timers.filter(t => !bL.includes(t.n)); saveStore(); renderSched(); } }
    function openBackup() { document.getElementById('backup-data').value = JSON.stringify({timers:st.timers, folds:st.foldState}); document.getElementById('backup-modal').style.display='flex'; }
    function copyBackup() { const t = document.getElementById('backup-data'); t.select(); document.execCommand('copy'); alert("Î≥µÏÇ¨Îê®"); }
    function importData() { try { const d = JSON.parse(document.getElementById('backup-data').value); st.timers = d.timers || []; st.foldState = d.folds || {}; saveStore(); renderSched(); closeBackup(); } catch(e) { alert("JSON Ïò§Î•ò"); } }
    function closeBackup() { document.getElementById('backup-modal').style.display='none'; }
    async function toggleWakeLock() { if(!('wakeLock' in navigator)) return; if(st.wakeLock) { await st.wakeLock.release(); st.wakeLock=null; document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ OFF"; document.getElementById('wl-btn').classList.remove('on'); } else { requestWakeLock(false); } }
    async function requestWakeLock(s) { try { st.wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ ON"; document.getElementById('wl-btn').classList.add('on'); } catch(e){} }
    function drawPIP(list) { const ctx = document.getElementById('pip-canvas').getContext('2d'); ctx.fillStyle = "#fff"; ctx.fillRect(0,0,220,120); ctx.fillStyle = "#2d3436"; ctx.fillRect(0,0,220,35); ctx.fillStyle = "#fff"; ctx.font = "bold 13px Arial"; ctx.fillText("B-CONTROL PiP", 15, 23); if(list.length > 0) { const n = list[0]; const d = n.t - Date.now(); ctx.fillStyle = "#1a237e"; ctx.font = "bold 22px 'Noto Sans KR'"; ctx.textAlign = "center"; ctx.fillText(n.n, 110, 75); ctx.fillStyle = "#000"; ctx.font = "bold 32px Orbitron"; ctx.fillText(formatTimer(d).substring(3), 110, 108); } }
    async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }

    init();
</script>
</body>
</html>
