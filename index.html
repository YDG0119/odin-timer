<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ìŠ¤ ì•Œë¦¬ë¯¸ V29 - ì•„í‚¤í…íŠ¸ ì»¤ìŠ¤í…€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8e24aa; --accent: #1e88e5; --bg: #f8f9fa;
            --danger: #d32f2f; --warning: #ffa000; --sidebar-w: 75px;
            --success: #44bd32; --black: #2d3436; --border: #dee2e6;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        body.system-off { filter: grayscale(1) brightness(0.8); pointer-events: none; }
        body.system-off header, body.system-off .global-pwr, body.system-off nav { pointer-events: auto !important; filter: none !important; }

        nav { width: var(--sidebar-w); background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 15px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .nav-item { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; color: #777; font-size: 22px; transition: 0.2s; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(142, 36, 170, 0.3); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; font-size: 1.2em; color: var(--primary); }
        .header-btns { position: absolute; right: 20px; display: flex; align-items: center; gap: 15px; }
        .wakelock-btn { font-size: 0.7em; padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; font-weight: bold; background: #fff; transition: 0.2s; }
        .wakelock-btn.on { background: var(--success); color: white; border-color: var(--success); }
        .global-pwr { font-size: 1.5em; cursor: pointer; color: var(--danger); }
        .global-pwr.is-on { color: var(--success); }

        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .pane { display: none; max-width: 1200px; margin: 0 auto; }
        .pane.active { display: block; animation: fadeIn 0.3s ease; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* ë„êµ¬ë°” ìŠ¤íƒ€ì¼ (V29 ì¶”ê°€) */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 10px; }
        .toolbar input[type="text"], .toolbar input[type="number"] { padding: 8px; border-radius: 5px; border: 1px solid var(--border); }
        .tool-btn { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; font-size: 0.85em; transition: 0.1s; }
        .tool-btn:active { transform: scale(0.95); }

        /* ì›”ë“œ ë°°ë„ˆ ë° í…Œì´ë¸” ì ‘ê¸° */
        .banner { padding: 12px 15px; color: white; font-weight: bold; font-size: 0.9em; border-radius: 8px; margin-top: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .banner:hover { opacity: 0.9; }
        .banner-btns { display: flex; gap: 8px; align-items: center; }
        .world-del-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer; }
        .world-del-btn:hover { background: var(--danger); }
        .fold-content { transition: max-height 0.3s ease-out; overflow: hidden; }
        .is-folded .fold-content { display: none; }

        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 5px; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f3f5; }
        .v-in { width: 130px; padding: 8px; border: 2px solid #eee; border-radius: 8px; text-align: center; font-family: 'Orbitron'; font-weight: bold; font-size: 1.1em; }
        .btn-killed { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #636e72; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 5px; }

        /* âš”ï¸ ë°°í‹€ ë³´ë“œ */
        .battle-grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 15px; }
        .battle-box { background: #f9fafb; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid #eee; }
        .val-txt { font-family: 'Orbitron'; font-size: 3.5em; display: block; line-height: 1.1; }
        .over-mode { color: var(--danger) !important; }

        /* ëª¨ë‹¬ (ë°±ì—…/ë³µì›ìš©) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; }
        .modal-card textarea { width: 100%; height: 200px; margin: 10px 0; font-family: monospace; font-size: 0.8em; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        #pip-video { position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<nav id="sidebar">
    <div class="nav-item active" onclick="tab('dash', this)">ğŸ </div>
    <div class="nav-item" onclick="tab('set-txt', this)">ğŸ•’</div>
    <div class="nav-item" onclick="tab('sched', this)">ğŸ“…</div>
    <div class="nav-item" onclick="tab('battle', this)">âš”ï¸</div>
    <div class="nav-item" onclick="tab('zen-calc', this)">ğŸ§®</div>
    <div class="nav-item" onclick="togglePIP()">ğŸ“º</div>
</nav>

<main>
    <header>
        ë³´ìŠ¤ ê´€ì œ ì‚¬ë ¹ë¶€ V29
        <div class="header-btns">
            <div id="wl-btn" class="wakelock-btn" onclick="toggleWakeLock()">ğŸ›¡ í™”ë©´ ìœ ì§€ OFF</div>
            <div id="pwr" class="global-pwr is-on" onclick="togglePwr()">â»</div>
        </div>
    </header>
    <div class="content">
        <div id="dash" class="pane active">
            <div style="display:grid; grid-template-columns: 1fr 380px; gap: 20px;">
                <div class="card" style="text-align:center; border-top:6px solid var(--accent);">
                    <div style="font-weight:bold; color:#888;">CURRENT TARGET</div>
                    <div id="d-name" style="font-size:2.5em; font-weight:bold; margin:10px 0;">ëŒ€ê¸° ì¤‘</div>
                    <div id="d-timer" style="font-family:Orbitron; font-size:6em; color:var(--accent); margin-bottom: 5px;">00:00:00</div>
                    <div id="top3-preview" style="margin: 15px auto; max-width: 320px; font-size: 0.9em; text-align: left;"></div>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="copyKakao('top3')" style="background:#fee500; border:none; padding:12px 20px; border-radius:10px; font-weight:bold; cursor:pointer;">Top3 ë³µì‚¬</button>
                        <button onclick="copyKakao('all')" style="background:#eee; border:none; padding:12px 20px; border-radius:10px; font-weight:bold; cursor:pointer;">ì „ì²´ ë³µì‚¬</button>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-top:0;">ğŸ”” ì´ë²¤íŠ¸ ë¡œê·¸</h3>
                    <div id="logs" style="font-size:0.85em; line-height:1.7; height:350px; overflow-y:auto; display:flex; flex-direction:column-reverse;"></div>
                </div>
            </div>
        </div>

        <div id="set-txt" class="pane">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2 style="margin:0;">ê³µì§€ í…ìŠ¤íŠ¸ ë™ê¸°í™”</h2>
                <button style="background:var(--primary); color:white; border:none; padding:10px 30px; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="saveText()">ì €ì¥ í›„ ì ìš©</button>
            </div>
            <textarea id="txt-ed" class="text-editor" style="width:100%; height:500px; padding:20px; border-radius:10px; border:1px solid #ddd;"></textarea>
        </div>

        <div id="sched" class="pane">
            <div class="toolbar">
                <input type="text" id="search-boss" placeholder="ë³´ìŠ¤ ê²€ìƒ‰..." oninput="handleSearch(this.value)">
                <label style="font-size:0.85em; font-weight:bold;"><input type="checkbox" id="active-only" onchange="applyFilters()"> í™œì„± íƒ€ì´ë¨¸ë§Œ</label>
                <div style="width:1px; height:20px; background:#ccc; margin:0 10px;"></div>
                <button class="tool-btn" onclick="toggleAllFolds(false)">ì „ì²´ í¼ì¹˜ê¸°</button>
                <button class="tool-btn" onclick="toggleAllFolds(true)">ì „ì²´ ì ‘ê¸°</button>
                <div style="width:1px; height:20px; background:#ccc; margin:0 10px;"></div>
                <button class="tool-btn" style="background:var(--danger); color:white;" onclick="clearAllTimers()">ì „ì²´ íƒ€ì´ë¨¸ ì‚­ì œ</button>
                <button class="tool-btn" style="background:var(--accent); color:white;" onclick="openBackup()">ë°±ì—…/ë³µì›</button>
            </div>
            
            <div class="toolbar">
                <span style="font-size:0.85em; font-weight:bold;">ì‹œê°„ ì¼ê´„ ì´ë™(Shift):</span>
                <input type="number" id="shift-min" style="width:60px;" value="0"> ë¶„
                <button class="tool-btn" onclick="applyShift(1)">+ ì ìš©</button>
                <button class="tool-btn" onclick="applyShift(-1)">- ì ìš©</button>
                <small style="color:#666;">(í™œì„± íƒ€ì´ë¨¸ ëŒ€ìƒ)</small>
            </div>

            <div id="sched-cont"></div>
        </div>

        <div id="battle" class="pane">
            <div class="card">
                <h2 style="text-align:center; margin:0 0 20px 0;">âš”ï¸ ì „ìˆ  ë°°í‹€ ì¶”ì </h2>
                <div class="battle-grid">
                    <div class="battle-box"><span class="label-sm">ì „íˆ¬ ê²½ê³¼</span><span class="val-txt" id="b-elap">00:00</span></div>
                    <div class="battle-box"><span class="label-sm" id="b-label">ì¡í˜ ì˜ˆìƒ (HP 33.8%)</span><span class="val-txt" id="b-timer">--:--</span></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                    <button class="c-btn" style="background:#455a64;" onclick="btl('start')">ì‹œì‘</button>
                    <button class="c-btn" style="background:var(--warning);" onclick="btl('kwang')">ê´‘</button>
                    <button class="c-btn" style="background:var(--danger);" onclick="btl('kill')">ì¡í˜</button>
                </div>
            </div>
        </div>

        <div id="zen-calc" class="pane">
            <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                <div>
                    <h3>ğŸ”„ ì   ì‹œê°„ ì—…ë°ì´íŠ¸</h3>
                    <select id="zc-sel" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; font-weight:bold; margin-bottom:15px;"></select>
                    <input type="text" id="zc-in" class="v-in" style="width:100%; box-sizing:border-box; border:2px solid var(--accent);" placeholder="ë¶„ ì´ˆ (ì˜ˆ: 8 44)">
                    <button class="btn-apply" style="background:var(--accent); color:white; border:none; padding:18px; border-radius:10px; font-weight:bold; width:100%; margin-top:15px; cursor:pointer;" onclick="applyZenCalc()">ê°•ì œ ì—…ë°ì´íŠ¸ ì‹¤í–‰</button>
                </div>
                <div style="background:#f0f7ff; border:2px dashed var(--accent); border-radius:15px; padding:25px; text-align:center;">
                    <span style="font-weight:bold; color:var(--accent);">ì—…ë°ì´íŠ¸ ì˜ˆì • ì   ì‹œê°„</span>
                    <span class="val-txt" id="zc-preview" style="color:var(--accent); font-size:3em; margin:10px 0;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="backup-modal" class="modal">
    <div class="modal-card">
        <h3>ğŸ“¦ ë°ì´í„° ë°±ì—… ë° ë³µì›</h3>
        <p style="font-size:0.8em; color:#666;">ì•„ë˜ JSON ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì—¬ ë³´ê´€í•˜ê±°ë‚˜, ë°±ì—…ëœ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ë³µì›í•˜ì„¸ìš”.</p>
        <textarea id="backup-data"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="tool-btn" onclick="copyBackup()">í´ë¦½ë³´ë“œ ë³µì‚¬</button>
            <button class="tool-btn" style="background:var(--primary); color:white;" onclick="importData()">ë³µì› ì‹¤í–‰</button>
            <button class="tool-btn" onclick="closeBackup()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<canvas id="pip-canvas" width="220" height="120" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline></video>

<script>
    const bosses = [
        { w: "ìš”íˆ°í—¤ì„", c: "#3f51b5", b: [{n:"íŒŒë¥´ë°”", r:120}, {n:"ì…€ë¡œë¹„ì•„", r:720}, {n:"íë‹ˆë¥´", r:720}, {n:"í˜í‹°", r:720}, {n:"ë°”ìš°í‹°", r:120}, {n:"ë‹ˆë“œí˜¸ê·¸", r:1440}, {n:"ì•¼ë£¬", r:240}, {n:"í‹°ë¥´", r:1440}] },
        { w: "ë‹ˆë‹¤ë²¨ë¦¬ë¥´", c: "#43a047", b: [{n:"ë¼ì´ë…¸ë¥´", r:720}, {n:"ë¹„ìš”ë¥¸", r:720}, {n:"í—¤ë¥´ëª¨ë“œ", r:240}, {n:"ìŠ¤ì¹¼ë¼ë‹ˆë¥´", r:120}, {n:"ë¸Œë¥€íë“œ", r:720}, {n:"ë¼íƒ€í† ìŠ¤í¬", r:240}, {n:"ìˆ˜ë“œë¦¬", r:720}, {n:"í† ë¥´", r:1440}] },
        { w: "ì•Œë¸Œí—¤ì„", c: "#ef6c00", b: [{n:"ìŠ¤ë°”ë¥´íŠ¸", r:240}, {n:"ë‘ë¼ìŠ¤ë¡œë¥´", r:480}, {n:"ëª¨ë„¤ê°€ë¦„", r:120}, {n:"ë“œë¼ìš°ê·¸", r:240}, {n:"êµ´ë² ì´ê·¸", r:480}, {n:"ì˜¤ë”˜", r:1440}] },
        { w: "ë¬´ìŠ¤í í•˜ì„", c: "#c62828", b: [{n:"ë©”ê¸°ë¥´", r:120}, {n:"ì‹ ë§ˆë¼", r:720}, {n:"í—¤ë¥´ê°€ë¦„", r:120}, {n:"íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´", r:240}, {n:"ì—˜ë“œë£¬", r:720}, {n:"ìš°ë¡œë³´ë¡œìŠ¤", r:1440}, {n:"ìˆ˜ë¥´íŠ¸", r:1440}] },
        { w: "ì•„ìŠ¤ê°€ë¥´ë“œ", c: "#7b1fa2", b: [{n:"ë°œë¦¬", r:120}, {n:"ë…¸íŠ¸", r:480}, {n:"ìƒ¤ë¬´í¬", r:120}, {n:"ìŠ¤ì¹¼ë“œë©”ë¥´", r:120}, {n:"í™”ì‹ ê·¸ë¡œì•„", r:1440}, {n:"ë¯¸ë¯¸ë¥´", r:240}] },
        { w: "ë‹ˆí”Œí•˜ì„", c: "#0097a7", b: [{n:"íˆë¡œí‚¨", r:1440}, {n:"í˜¸ë“œ", r:1440}, {n:"í—¤ì´ë“œ", r:1440}, {n:"ëŒ€êµì£¼", r:1440}, {n:"í”„ë ˆì´", r:1440}, {n:"ì´ë¯¸ë¥´", r:1440}] },
        { w: "ë°”ë‚˜í•˜ì„", c: "#689f38", b: [{n:"ì—˜ë””ë¥´", r:1440}, {n:"ì•ˆë‚˜ë¥´ì—˜ë””ë¥´", r:1440}, {n:"ìŠ¤ì¿¨ë“œ", r:1440}, {n:"ìŠ¤ì¹´ë””", r:1440}, {n:"ì—ê¸°ë¥´", r:1440}] },
        { w: "ë˜ì „", c: "#455a64", b: [{n:"ì§€ê°7ì¸µ", r:480}, {n:"ì§€ê°4ì¸µ", r:480}, {n:"ì§€ê°10ì¸µ", r:480}, {n:"ìµœí•˜ì¸µ êµ´ë² ì´ê·¸", r:480}] }
    ];

    const BOSS_WORLD_MAP = {};
    bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));

    let st = { 
        on: true, 
        timers: JSON.parse(localStorage.getItem('v28_timers')) || [], 
        battle: { s: null, k: null, est: 0 },
        foldState: JSON.parse(localStorage.getItem('v29_fold_state')) || {},
        searchTerm: '',
        activeOnly: false,
        wakeLock: null
    };

    function init() {
        renderSched(); syncTxt();
        const zcSel = document.getElementById('zc-sel');
        bosses.forEach(g => g.b.forEach(b => zcSel.innerHTML += `<option value="${b.n}">${b.n}</option>`));
        
        document.getElementById('zc-in').addEventListener('input', (e) => {
            const sec = parseMinSec(e.target.value);
            document.getElementById('zc-preview').innerText = sec > 0 ? new Date(Date.now() + sec*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:--";
        });

        // ğŸ›¡ í™”ë©´ êº¼ì§ ë°©ì§€ ì¬í™œì„±í™”
        document.addEventListener('visibilitychange', () => { if (st.wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(true); });
        
        setInterval(loop, 500);
        addLog("V29 í¸ì˜ê¸°ëŠ¥ íŒ¨í‚¤ì§€ ê°€ë™ ì™„ë£Œ");
    }

    // 1) ì›”ë“œ ë‹¨ìœ„ ì ‘ê¸°/í¼ì¹˜ê¸°
    function toggleFold(world) {
        st.foldState[world] = !st.foldState[world];
        localStorage.setItem('v29_fold_state', JSON.stringify(st.foldState));
        renderSched();
    }
    function toggleAllFolds(shouldFold) {
        bosses.forEach(g => st.foldState[g.w] = shouldFold);
        localStorage.setItem('v29_fold_state', JSON.stringify(st.foldState));
        renderSched();
        addLog(`ì „ì²´ ì›”ë“œ ${shouldFold ? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°'}`);
    }

    // 2) ê²€ìƒ‰ ë° í•„í„°
    let searchTimeout;
    function handleSearch(val) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            st.searchTerm = val.toLowerCase();
            applyFilters();
        }, 250);
    }
    function applyFilters() {
        st.activeOnly = document.getElementById('active-only').checked;
        const now = Date.now();
        document.querySelectorAll('.world-container').forEach(container => {
            const world = container.dataset.world;
            let visibleInWorld = 0;
            container.querySelectorAll('tr').forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const timer = st.timers.find(t => t.n === row.dataset.name);
                const isActive = timer && (timer.t - now > 0);
                
                const matchesSearch = name.includes(st.searchTerm);
                const matchesActive = !st.activeOnly || isActive;
                
                if (matchesSearch && matchesActive) { row.style.display = ''; visibleInWorld++; }
                else { row.style.display = 'none'; }
            });
            container.style.display = (visibleInWorld > 0) ? '' : 'none';
        });
    }

    // 3) ì¼ê´„ ì‚­ì œ
    function clearAllTimers() {
        if (!confirm("ëª¨ë“  íƒ€ì´ë¨¸ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”? (ì…ë ¥ê°’ì€ ìœ ì§€ë©ë‹ˆë‹¤)")) return;
        st.timers = [];
        saveStorage();
        renderSched();
        addLog("ì „ì²´ íƒ€ì´ë¨¸ ì¼ê´„ ì‚­ì œ");
    }
    function clearWorldTimers(world) {
        if (!confirm(`${world}ì˜ ëª¨ë“  íƒ€ì´ë¨¸ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
        const bossesInWorld = bosses.find(g => g.w === world).b.map(b => b.n);
        st.timers = st.timers.filter(t => !bossesInWorld.includes(t.n));
        saveStorage();
        renderSched();
        addLog(`${world} íƒ€ì´ë¨¸ ì‚­ì œ`);
    }

    // 4) ì‹œê°„ ì¼ê´„ ì´ë™ (Shift)
    function applyShift(direction) {
        const mins = parseInt(document.getElementById('shift-min').value) || 0;
        if (mins <= 0) return;
        const now = Date.now();
        const offset = mins * 60000 * direction;
        let count = 0;
        st.timers = st.timers.map(t => {
            if (t.t - now > 0) { t.t += offset; t.m5 = false; t.m1 = false; count++; }
            return t;
        });
        saveStorage();
        renderSched();
        addLog(`í™œì„± ë³´ìŠ¤ ${count}ê°œ ì‹œê°„ ${direction > 0 ? '+' : '-'}${mins}ë¶„ ì´ë™`);
    }

    // 5) ë°±ì—… ë° ë³µì›
    function openBackup() {
        const data = {
            timers: st.timers,
            inputs: {},
            folds: st.foldState
        };
        bosses.forEach(g => g.b.forEach(b => {
            const val = localStorage.getItem(`v28_in_${b.n}`);
            if (val) data.inputs[b.n] = val;
        }));
        document.getElementById('backup-data').value = JSON.stringify(data);
        document.getElementById('backup-modal').style.display = 'flex';
    }
    function copyBackup() {
        const ta = document.getElementById('backup-data');
        ta.select();
        document.execCommand('copy');
        alert("ë°±ì—… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    function importData() {
        try {
            const data = JSON.parse(document.getElementById('backup-data').value);
            if (confirm("ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  ë³µì›í• ê¹Œìš”?")) {
                st.timers = data.timers || [];
                st.foldState = data.folds || {};
                Object.keys(data.inputs || {}).forEach(name => localStorage.setItem(`v28_in_${name}`, data.inputs[name]));
                saveStorage();
                renderSched();
                tab('dash', document.querySelector('.nav-item'));
                closeBackup();
                addLog("ë°ì´í„° ë³µì› ì„±ê³µ");
            }
        } catch (e) { alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
    }
    function closeBackup() { document.getElementById('backup-modal').style.display = 'none'; }

    // 6) Wake Lock
    async function toggleWakeLock() {
        if (!('wakeLock' in navigator)) return alert("ì´ ë¸Œë¼ìš°ì €ëŠ” í™”ë©´ ìœ ì§€ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        if (st.wakeLock) {
            await st.wakeLock.release();
            st.wakeLock = null;
            addLog("í™”ë©´ ìœ ì§€ í•´ì œ");
        } else {
            requestWakeLock(false);
        }
    }
    async function requestWakeLock(silent) {
        try {
            st.wakeLock = await navigator.wakeLock.request('screen');
            document.getElementById('wl-btn').innerText = "ğŸ›¡ í™”ë©´ ìœ ì§€ ON";
            document.getElementById('wl-btn').classList.add('on');
            if (!silent) addLog("í™”ë©´ ìœ ì§€ ê°€ë™");
        } catch (err) { console.error(`${err.name}, ${err.message}`); }
    }

    // [í‘œì¤€ ì—”ì§„ ë° ë Œë”ë§]
    function loop() {
        if(!st.on) return;
        const now = Date.now();
        st.timers = st.timers.filter(t => (now - t.t) < 600000);
        st.timers.forEach(tm => {
            const d = Math.floor((tm.t - now) / 1000);
            if(d <= 300 && d > 295 && !tm.m5) { playTTS(`${tm.n} 5ë¶„ ì „.`); tm.m5 = true; addLog(`${tm.n} 5ë¶„ ì „ ì•Œë¦¼`); }
            if(d <= 60 && d > 55 && !tm.m1) { playTTS(`${tm.n} 1ë¶„ ì „.`); tm.m1 = true; addLog(`${tm.n} 1ë¶„ ì „ ì•Œë¦¼`); }
        });
        const list = [...st.timers].sort((a,b) => a.t - b.t);
        const upcoming = list.filter(t => t.t > now);
        const next = upcoming.length > 0 ? upcoming[0] : null;
        document.getElementById('d-name').innerText = next ? next.n : "ëŒ€ê¸° ì¤‘";
        document.getElementById('d-timer').innerText = next ? formatTimer(next.t - now) : "00:00:00";
        st.timers.forEach(tm => { const el = document.getElementById(`zen-${tm.n}`); if(el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); });
        updateDashPreview(upcoming);
        drawPIP(upcoming);
    }

    function renderSched() {
        const c = document.getElementById('sched-cont'); let h = '';
        bosses.forEach(g => {
            const isFolded = st.foldState[g.w] === true;
            h += `<div class="world-container ${isFolded ? 'is-folded' : ''}" data-world="${g.w}">
                <div class="banner" style="background:${g.c}" onclick="if(event.target==this) toggleFold('${g.w}')">
                    <span>${isFolded ? 'â–¶' : 'â–¼'} ${g.w}</span>
                    <div class="banner-btns">
                        <button class="world-del-btn" onclick="clearWorldTimers('${g.w}')">ì´ ì›”ë“œ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="fold-content"><table><tbody>`;
            g.b.forEach(b => {
                const sv = localStorage.getItem(`v28_in_${b.n}`) || '';
                const ex = st.timers.find(t => t.n === b.n);
                const zen = ex ? new Date(ex.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}) : '--:--';
                h += `<tr data-name="${b.n}"><td width="140"><strong>${b.n}</strong></td><td><input type="text" class="v-in" value="${sv}" onkeydown="if(event.key==='Enter') setTimer('${b.n}', parseSmart(this.value), this.value)" placeholder="ë¶„ ì…ë ¥"></td><td id="zen-${b.n}" style="font-family:Orbitron;font-weight:bold;color:#555;text-align:center;">${zen}</td><td width="130"><button class="btn-killed" onclick="setTimer('${b.n}',${b.r*60},'ìë™')">ì¡ìŒ</button><button class="btn-del" onclick="delTimer('${b.n}')">ì‚­ì œ</button></td></tr>`;
            });
            h += `</tbody></table></div></div>`;
        });
        c.innerHTML = h;
        applyFilters();
    }

    // [ìœ í‹¸ë¦¬í‹°]
    function setTimer(n, s, raw) {
        const t = Date.now() + (s * 1000); const i = st.timers.findIndex(x => x.n === n);
        const entry = { n, t, m5: false, m1: false };
        if(i > -1) st.timers[i] = entry; else st.timers.push(entry);
        if(raw !== "ìë™") localStorage.setItem(`v28_in_${n}`, raw);
        saveStorage(); addLog(`${n} ì‹œê°„ ì„¤ì •`);
    }
    function delTimer(n) { st.timers = st.timers.filter(t => t.n !== n); localStorage.removeItem(`v28_in_${n}`); saveStorage(); renderSched(); addLog(`${n} ì‚­ì œ`); }
    function saveStorage() { localStorage.setItem('v28_timers', JSON.stringify(st.timers)); syncTxt(); }
    function addLog(m) { const box = document.getElementById('logs'); const div = document.createElement('div'); div.innerHTML = `<span style="color:#888;">[${new Date().toLocaleTimeString()}]</span> ${m}`; box.appendChild(div); }
    function parseSmart(s) { if(!s) return 0; const kor = s.match(/(\d+)ì‹œê°„\s*(\d+)ë¶„/) || s.match(/(\d+)ë¶„/); if(kor) return kor.length === 3 ? (parseInt(kor[1])*3600)+(parseInt(kor[2])*60) : parseInt(kor[1])*60; const p = s.split(/[:\s]+/).map(Number); if(p.length===3) return p[0]*3600+p[1]*60+p[2]; if(p.length===2) return p[0]*60+p[1]; return p[0]*60; }
    function parseMinSec(s) { if(!s) return 0; const p = s.split(/[:\s]+/).filter(x => x !== "").map(Number); return p.length >= 2 ? (p[0]*60)+p[1] : (p.length===1 ? p[0]*60 : 0); }
    function formatTimer(ms) { if(ms < 0) return "00:00:00"; const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000); const s = Math.floor((ms%60000)/1000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(Math.floor(s%60)).toString().padStart(2,'0')}`; }
    function playTTS(m) { if(st.on) { const u = new SpeechSynthesisUtterance(m); u.lang = 'ko-KR'; window.speechSynthesis.speak(u); } }
    function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(el) el.classList.add('active'); if(id==='set-txt') syncTxt(); }
    function togglePwr() { st.on = !st.on; document.getElementById('pwr').classList.toggle('is-on', st.on); document.body.classList.toggle('system-off', !st.on); addLog(`ì‹œìŠ¤í…œ ${st.on?'ê°€ë™':'ì •ì§€'}`); }
    function syncTxt() { const n = new Date(); let txt = `${n.getMonth()+1}.${n.getDate()}\n`; st.timers.sort((a,b)=>a.t-b.t).forEach(tm => { txt += `${new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} ${tm.n}\n`; }); document.getElementById('txt-ed').value = txt; }
    function saveText() { const lines = document.getElementById('txt-ed').value.split('\n'); let dl = ""; const nt = []; lines.forEach(l => { if(l.includes('.')) dl = l.trim(); const m = l.match(/(\d{2}:\d{2})\s+(.+)/); if(m && dl) { const [mon, day] = dl.split('.').map(Number); const [hh, mm] = m[1].split(':').map(Number); nt.push({ n: m[2].trim(), t: new Date(new Date().getFullYear(), mon-1, day, hh, mm).getTime(), m5:false, m1:false }); } }); st.timers = nt; saveStorage(); renderSched(); tab('dash', document.querySelector('.nav-item')); addLog("í…ìŠ¤íŠ¸ ë™ê¸°í™” ì™„ë£Œ"); }
    function copyKakao(mode) {
        const now = Date.now();
        const activeTimers = st.timers.sort((a,b) => a.t - b.t);
        if (activeTimers.length === 0) return alert("í˜„ì¬ ë“±ë¡ëœ ì   íƒ€ì´ë¨¸ ì—†ìŒ");
        const dateHeader = `[${new Date().toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short' })} ì˜¤ë”˜ ë³´ìŠ¤ ì   ì•Œë¦¼]`;
        let txt = mode === 'top3' ? dateHeader + '\n' : `${new Date().getMonth()+1}.${new Date().getDate()}\n`;
        const list = mode === 'top3' ? activeTimers.filter(t => t.t > now).slice(0, 3) : activeTimers;
        list.forEach((t, i) => {
            const zTime = new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            if (mode === 'top3') txt += `${i+1}) ${zTime} ${t.n} (${BOSS_WORLD_MAP[t.n] || "-"}) - ë‚¨ì€ ${formatTimer(t.t - now).substring(3)}\n`;
            else txt += `${zTime} ${t.n}\n`;
        });
        navigator.clipboard.writeText(txt.trim()).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
    }
    function updateDashPreview(upcoming) {
        const area = document.getElementById('top3-preview');
        area.innerHTML = upcoming.slice(0, 3).map(t => `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:5px 0;"><span>${t.n}</span><b style="color:var(--accent)">${formatTimer(t.t - Date.now()).substring(3)}</b></div>`).join('') || '<div style="color:#aaa; text-align:center;">ë¦¬ì   ì˜ˆì • ë³´ìŠ¤ ì—†ìŒ</div>';
    }
    function applyZenCalc() { const name = document.getElementById('zc-sel').value; const val = document.getElementById('zc-in').value; const sec = parseMinSec(val); if(sec > 0) { setTimer(name, sec, val); document.getElementById('zc-in').value = ""; renderSched(); } }
    function btl(type) { if(!st.on) return; const now = Date.now(); if(type === 'start') { st.battle = { s: now, k: null, est: 0 }; addLog("ì „íˆ¬ ì‹œì‘"); } else if(type === 'kwang') { if(!st.battle.s) return; st.battle.k = now; st.battle.est = Math.floor(((now - st.battle.s)/1000) * 0.51); addLog("ê´‘í­í™”"); } else if(type === 'kill') { addLog("ì²˜ì¹˜ ì™„ë£Œ"); st.battle = { s: null, k: null, est: 0 }; } }
    function drawPIP(list) { const ctx = document.getElementById('pip-canvas').getContext('2d'); ctx.fillStyle = "#fff"; ctx.fillRect(0,0,220,120); ctx.fillStyle = "#2d3436"; ctx.fillRect(0,0,220,35); ctx.fillStyle = "#fff"; ctx.font = "bold 13px Arial"; ctx.fillText("ë³´ìŠ¤ ì•Œë¦¬ë¯¸ PRO", 15, 23); if(list.length > 0) { const n = list[0]; const d = n.t - Date.now(); ctx.fillStyle = "#0984e3"; ctx.font = "bold 22px 'Noto Sans KR'"; ctx.textAlign = "center"; ctx.fillText(n.n, 110, 75); ctx.fillStyle = "#000"; ctx.font = "bold 32px Orbitron"; ctx.fillText(formatTimer(d).substring(3), 110, 108); } }
    async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }
    init();
</script>
</body>
</html>
