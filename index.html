<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f5f7; --bg-card: #ffffff; --border: #dee2e6;
            --primary: #1a237e; --primary-light: #e8eaf6;
            --text-main: #212529; --text-sub: #6c757d;
            --danger: #d32f2f; --warning: #ef6c00; --success: #2e7d32;
            --sidebar-w: 220px; --header-h: 60px;
        }

        /* Base Setup */
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-page); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        body.system-off { filter: grayscale(1) brightness(0.9); pointer-events: none; }
        body.system-off header, body.system-off .global-controls, body.system-off nav { pointer-events: auto !important; filter: none !important; }

        /* Sidebar Î¶¨ÎîîÏûêÏù∏ (Icon + Text Label) */
        nav { width: var(--sidebar-w); background: #ffffff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; flex-shrink: 0; }
        .nav-brand { padding: 0 25px 20px; font-weight: 700; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: var(--text-sub); transition: 0.2s; gap: 12px; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: #f8f9fa; color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { height: var(--header-h); background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        
        /* Î©ÄÌã∞ ÌîÑÎ°úÌïÑ Ï°∞ÏûëÎ∂Ä */
        .profile-group { display: flex; gap: 5px; background: #f1f3f5; padding: 4px; border-radius: 8px; }
        .p-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 11px; transition: 0.2s; }
        .p-btn.active { background: var(--primary); color: #fff; }

        .content { flex: 1; padding: 25px; overflow-y: auto; }
        .pane { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.15s ease; }
        .pane.active { display: block; }
        .card { background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }

        /* ÎåÄÏãúÎ≥¥Îìú Î∞è Î¶¨Ïä§Ìä∏ Ïª¥Ìè¨ÎÑåÌä∏ */
        .dash-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .hero-section { text-align: center; padding: 20px 0; border-bottom: 1px solid #f8f9fa; margin-bottom: 20px; }
        .timer-big { font-family: 'Orbitron'; font-size: 56px; font-weight: 700; color: var(--primary); margin: 10px 0; }
        .imminent .timer-big { color: var(--danger); }
        
        .row-list { display: flex; flex-direction: column; }
        .boss-row { display: grid; grid-template-columns: 40px 1fr 140px 110px 80px 40px; align-items: center; padding: 8px 15px; background: #fff; border-bottom: 1px solid #f1f3f5; gap: 10px; }
        .boss-row:hover { background: #fafafa; }
        .world-section { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 12px; }
        .world-banner { height: 44px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; cursor: pointer; font-weight: 700; border-left: 5px solid var(--primary); }
        .is-folded .world-content { display: none; }

        .v-in { height: 32px; width: 100%; border-radius: 4px; border: 1px solid #ced4da; text-align: center; font-family: 'Orbitron'; font-weight: 600; font-size: 13px; }
        .v-in:focus { border-color: var(--primary); outline: none; background: #f0f4ff; }
        .zen-time-display { font-family: 'Orbitron'; font-weight: 600; text-align: center; color: var(--text-sub); }
        
        /* ÌÄµ Ïï°ÏÖò & Ïπ© */
        .fav-recent-bar { display: flex; flex-wrap: wrap; gap: 6px; margin: 15px 0; justify-content: center; }
        .chip { padding: 5px 12px; border-radius: 20px; background: #f1f3f5; border: 1px solid #e2e8f0; cursor: pointer; font-size: 11px; font-weight: 500; transition: 0.1s; }
        .chip.is-fav { border-color: #ffd700; background: #fffdf0; }
        .chip:hover { border-color: var(--primary); color: var(--primary); }

        /* Undo Toast */
        #undo-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2d3436; color: #fff; padding: 12px 25px; border-radius: 30px; display: none; align-items: center; gap: 15px; z-index: 5000; box-shadow: 0 8px 20px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        .undo-btn { color: #55efc4; font-weight: 700; cursor: pointer; text-decoration: underline; }

        .log-box { font-size: 12px; height: 380px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #fafafa; padding: 12px; border: 1px solid #eee; border-radius: 4px; line-height: 1.7; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } }
        #pip-video { position: fixed; opacity: 0; pointer-events: none; width: 1px; height: 1px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            nav { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 5px; }
            .nav-brand { display: none; }
            .dash-grid { grid-template-columns: 1fr; }
            .boss-row { grid-template-columns: 35px 1fr 100px 50px 35px; }
            .boss-row > div:nth-child(4) { display: none; }
        }
    </style>
</head>
<body onkeydown="handleKeys(event)">

<nav id="sidebar">
    <div class="nav-brand">B-OPS Desk</div>
    <div class="nav-item active" onclick="tab('dash', this)">üè† Dashboard</div>
    <div class="nav-item" onclick="tab('set-txt', this)">üïí Text Ops</div>
    <div class="nav-item" onclick="tab('sched', this)">üìÖ Schedule</div>
    <div class="nav-item" onclick="tab('battle', this)">‚öî Battle Ops</div>
    <div class="nav-item" onclick="tab('zen-calc', this)">üßÆ Forced Update</div>
    <div class="nav-item" onclick="togglePIP()">üì∫ Toggle PIP</div>
</nav>

<main>
    <header>
        <div class="profile-group">
            <button class="p-btn active" data-p="A" onclick="switchProfile('A')">PROFILE A</button>
            <button class="p-btn" data-p="B" onclick="switchProfile('B')">PROFILE B</button>
            <button class="p-btn" data-p="C" onclick="switchProfile('C')">PROFILE C</button>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <button class="p-btn" style="background:#fff; border:1px solid var(--border);" onclick="testAlert()">üîî Test Alert</button>
            <button id="wl-btn" class="p-btn" style="background:#fff; border:1px solid var(--border);" onclick="toggleWakeLock()">üõ° ÌôîÎ©¥ Ïú†ÏßÄ OFF</button>
            <div id="pwr" style="cursor:pointer; font-size:24px; color:var(--success);" onclick="togglePwr()">‚èª</div>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="dash-grid">
                <div>
                    <div class="card hero-section" id="hero-card">
                        <div style="font-weight:700; color:var(--text-sub); font-size:12px; letter-spacing:1px;">ACTIVE MISSION</div>
                        <div id="d-name" style="font-size:26px; font-weight:700; margin-top:12px;">ÎåÄÍ∏∞ Ï§ë</div>
                        <div id="d-timer" class="timer-big">00:00:00</div>
                        <div id="d-meta" style="color:var(--text-sub); font-weight:500;">-</div>

                        <div style="display:flex; gap:10px; margin: 20px 0; background:#f8f9fa; padding:10px; border-radius:8px;">
                            <select id="quick-sel" style="flex:1; height:38px; border-radius:6px; border:1px solid var(--border); font-weight:700; padding:0 10px;"></select>
                            <button class="p-btn active" style="height:38px; padding:0 20px; font-size:12px;" onclick="quickKill()">KILLED</button>
                        </div>
                        
                        <div id="fav-panel" class="fav-recent-bar"></div>

                        <div id="top3-list" style="margin-top:20px; text-align:left; background:#f4f5f7; padding:15px; border-radius:8px;"></div>

                        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                            <button class="p-btn active" style="height:40px; padding:0 25px;" onclick="copyKakao('top3')">üì¢ Top3 Î≥µÏÇ¨</button>
                            <button class="p-btn" style="height:40px; padding:0 25px; background:#eee; color:#333;" onclick="copyKakao('all')">üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:12px; color:var(--primary); font-size:14px;">MISSION COMMAND LOGS</div>
                    <div id="logs" class="log-box"></div>
                </div>
            </div>
        </div>

        <div id="set-txt" class="pane">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Manual Ops Synchronization</h3>
                    <button class="p-btn active" style="height:36px;" onclick="saveText()">Ï†ÄÏû• ÌõÑ Ï†ÅÏö©</button>
                </div>
                <textarea id="txt-ed" style="width:100%; height:550px; border:1px solid var(--border); padding:20px; font-family:monospace; line-height:1.8; border-radius:8px; resize:none;"></textarea>
            </div>
        </div>

        <div id="sched" class="pane">
            <div class="card" style="padding:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:#f8f9fa; margin-bottom:15px;">
                <input type="text" id="search-boss" placeholder="Î≥¥Ïä§ ÌïÑÌÑ∞..." style="width:180px; height:34px; padding:0 10px; border:1px solid #ddd; border-radius:6px;" oninput="handleSearch(this.value)">
                <label style="display:flex; align-items:center; gap:5px; font-weight:700; font-size:12px;"><input type="checkbox" id="active-only" onchange="applyFilters()"> ÌôúÏÑ±Îßå</label>
                <div style="flex:1;"></div>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="toggleAllFolds(false)">Î™®Îëê ÌéºÏπòÍ∏∞</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="toggleAllFolds(true)">Î™®Îëê Ï†ëÍ∏∞</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd; color:var(--danger);" onclick="confirmClear()">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="openBackup()">JSON Backup</button>
            </div>
            
            <div class="card" style="padding:12px; display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                <span style="font-weight:700; font-size:12px;">Batch Time Shift:</span>
                <input type="number" id="shift-min" style="width:60px; height:32px; text-align:center; border:1px solid #ddd; border-radius:4px;" value="0">
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="applyShift(1)">+ Î∂Ñ Ï∂îÍ∞Ä</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="applyShift(-1)">- Î∂Ñ Ï∞®Í∞ê</button>
            </div>

            <div id="sched-cont"></div>
        </div>

        <div id="battle" class="pane">
            <div class="card" style="max-width:600px; margin: 0 auto;">
                <h3 style="text-align:center;">Tactical Battle Tracker</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:25px 0;">
                    <div style="background:#f8f9fa; padding:25px; border-radius:12px; text-align:center; border:1px solid #eee;">
                        <small style="font-weight:700; color:#888;">ELAPSED TIME</small>
                        <div id="b-elap" style="font-family:Orbitron; font-size:36px; font-weight:700; margin-top:5px;">00:00</div>
                    </div>
                    <div style="background:#f8f9fa; padding:25px; border-radius:12px; text-align:center; border:1px solid #eee;">
                        <small style="font-weight:700; color:#888;">HP 33.8% PREDICTED</small>
                        <div id="b-timer" style="font-family:Orbitron; font-size:36px; font-weight:700; color:var(--danger); margin-top:5px;">--:--</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                    <button class="p-btn" style="height:50px; background:#455a64; color:#fff;" onclick="btl('start')">START</button>
                    <button class="p-btn" style="height:50px; background:var(--warning); color:#fff;" onclick="btl('kwang')">BERSERK</button>
                    <button class="p-btn active" style="height:50px;" onclick="btl('kill')">KILLED</button>
                </div>
            </div>
        </div>

        <div id="zen-calc" class="pane">
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div>
                    <h3>Mission Force Update</h3>
                    <select id="zc-sel" style="width:100%; height:42px; border-radius:8px; border:1px solid var(--border); margin-bottom:15px; font-weight:700; padding:0 10px;"></select>
                    <input type="text" id="zc-in" style="width:100%; height:50px; text-align:center; font-family:Orbitron; font-size:24px; border:2px solid var(--primary); border-radius:8px;" placeholder="Î∂Ñ Ï¥à ÏûÖÎ†• (Ïòà: 8 44)">
                    <button class="p-btn active" style="width:100%; height:50px; margin-top:20px; font-size:14px;" onclick="applyZenCalc()">UPDATE MISSION TIME</button>
                </div>
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--primary-light); border-radius:12px; border:1px dashed var(--primary);">
                    <span style="font-weight:700; color:var(--primary); font-size:14px;">SPAWN AT (PREVIEW)</span>
                    <span id="zc-preview" style="font-family:Orbitron; font-size:42px; color:var(--primary); margin:15px 0;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="undo-toast">
    <span id="undo-msg">Action processed.</span>
    <span class="undo-btn" onclick="executeUndo()">ÎêòÎèåÎ¶¨Í∏∞ (Undo)</span>
</div>

<canvas id="pip-canvas" width="220" height="120" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline></video>

<script>
    const bosses = [
        { w: "ÏöîÌà∞Ìó§ÏûÑ", c: "#3f51b5", b: [{n:"ÌååÎ•¥Î∞î", r:120}, {n:"ÏÖÄÎ°úÎπÑÏïÑ", r:720}, {n:"ÌùêÎãàÎ•¥", r:720}, {n:"ÌéòÌã∞", r:720}, {n:"Î∞îÏö∞Ìã∞", r:120}, {n:"ÎãàÎìúÌò∏Í∑∏", r:1440}, {n:"ÏïºÎ£¨", r:240}, {n:"Ìã∞Î•¥", r:1440}] },
        { w: "ÎãàÎã§Î≤®Î¶¨Î•¥", c: "#43a047", b: [{n:"ÎùºÏù¥ÎÖ∏Î•¥", r:720}, {n:"ÎπÑÏöîÎ•∏", r:720}, {n:"Ìó§Î•¥Î™®Îìú", r:240}, {n:"Ïä§ÏπºÎùºÎãàÎ•¥", r:120}, {n:"Î∏åÎ•ÄÌûêÎìú", r:720}, {n:"ÎùºÌÉÄÌÜ†Ïä§ÌÅ¨", r:240}, {n:"ÏàòÎìúÎ¶¨", r:720}, {n:"ÌÜ†Î•¥", r:1440}] },
        { w: "ÏïåÎ∏åÌó§ÏûÑ", c: "#ef6c00", b: [{n:"Ïä§Î∞îÎ•¥Ìä∏", r:240}, {n:"ÎëêÎùºÏä§Î°úÎ•¥", r:480}, {n:"Î™®ÎÑ§Í∞ÄÎ¶Ñ", r:120}, {n:"ÎìúÎùºÏö∞Í∑∏", r:240}, {n:"Íµ¥Î≤†Ïù¥Í∑∏", r:480}, {n:"Ïò§Îîò", r:1440}] },
        { w: "Î¨¥Ïä§Ìé†ÌïòÏûÑ", c: "#c62828", b: [{n:"Î©îÍ∏∞Î•¥", r:120}, {n:"Ïã†ÎßàÎùº", r:720}, {n:"Ìó§Î•¥Í∞ÄÎ¶Ñ", r:120}, {n:"ÌÉïÍ∑∏Î¶¨Ïä§ÎãàÎ•¥", r:240}, {n:"ÏóòÎìúÎ£¨", r:720}, {n:"Ïö∞Î°úÎ≥¥Î°úÏä§", r:1440}, {n:"ÏàòÎ•¥Ìä∏", r:1440}] },
        { w: "ÏïÑÏä§Í∞ÄÎ•¥Îìú", c: "#7b1fa2", b: [{n:"Î∞úÎ¶¨", r:120}, {n:"ÎÖ∏Ìä∏", r:480}, {n:"ÏÉ§Î¨¥ÌÅ¨", r:120}, {n:"Ïä§ÏπºÎìúÎ©îÎ•¥", r:120}, {n:"ÌôîÏã†Í∑∏Î°úÏïÑ", r:1440}, {n:"ÎØ∏ÎØ∏Î•¥", r:240}] },
        { w: "ÎãàÌîåÌïòÏûÑ", c: "#0097a7", b: [{n:"ÌûàÎ°úÌÇ®", r:1440}, {n:"Ìò∏Îìú", r:1440}, {n:"Ìó§Ïù¥Îìú", r:1440}, {n:"ÎåÄÍµêÏ£º", r:1440}, {n:"ÌîÑÎ†àÏù¥", r:1440}, {n:"Ïù¥ÎØ∏Î•¥", r:1440}] },
        { w: "Î∞îÎÇòÌïòÏûÑ", c: "#689f38", b: [{n:"ÏóòÎîîÎ•¥", r:1440}, {n:"ÏïàÎÇòÎ•¥ÏóòÎîîÎ•¥", r:1440}, {n:"Ïä§Ïø®Îìú", r:1440}, {n:"Ïä§Ïπ¥Îîî", r:1440}, {n:"ÏóêÍ∏∞Î•¥", r:1440}] },
        { w: "ÎçòÏ†Ñ", c: "#455a64", b: [{n:"ÏßÄÍ∞ê7Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê4Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê10Ï∏µ", r:480}, {n:"ÏµúÌïòÏ∏µ Íµ¥Î≤†Ïù¥Í∑∏", r:480}] }
    ];

    const BOSS_WORLD_MAP = {};
    bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));

    let st = {
        on: true, profile: 'A', timers: [], favs: [], recent: [],
        battle: { s: null, k: null, est: 0 },
        foldState: {}, searchTerm: '', wakeLock: null,
        undoStack: null, undoT: null
    };

    function init() {
        const lastP = localStorage.getItem('v29_current_p') || 'A';
        switchProfile(lastP);

        const qSel = document.getElementById('quick-sel');
        const zSel = document.getElementById('zc-sel');
        bosses.forEach(g => g.b.forEach(b => {
            const opt = `<option value="${b.n}">${b.n}</option>`;
            qSel.innerHTML += opt; zSel.innerHTML += opt;
        }));

        document.getElementById('zc-in').addEventListener('input', (e) => {
            const sec = parseMinSec(e.target.value);
            document.getElementById('zc-preview').innerText = sec > 0 ? new Date(Date.now() + sec*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:--";
        });

        document.addEventListener('visibilitychange', () => { if(st.wakeLock && document.visibilityState === 'visible') requestWakeLock(true); });
        setInterval(loop, 500);
        addLog("Mission Desk Initialized");
    }

    /* ---------------------------------------------------------
       V29 PATCH PACK LOGIC INTEGRATED
       --------------------------------------------------------- */

    function normalizeTimers() {
      const now = Date.now();
      st.timers = (st.timers || []).map(x => {
        const t = typeof x.t === 'number' ? x.t : Number(x.t);
        const d = Math.floor((t - now) / 1000);
        return { n: x.n, t, m5: !!x.m5, m1: !!x.m1, lastD: (typeof x.lastD === 'number') ? x.lastD : d };
      });
    }

    function switchProfile(p) {
      st.profile = p;
      localStorage.setItem('v29_current_p', p);
      document.querySelectorAll('.p-btn[data-p]').forEach(b => b.classList.toggle('active', b.dataset.p === p));

      const stored = localStorage.getItem(`v29_${p}_timers`);
      if (!stored && p === 'A') st.timers = JSON.parse(localStorage.getItem('v28_timers')) || [];
      else st.timers = JSON.parse(stored) || [];

      st.favs = JSON.parse(localStorage.getItem(`v29_${p}_favs`)) || [];
      st.recent = JSON.parse(localStorage.getItem(`v29_${p}_recent`)) || [];
      st.foldState = JSON.parse(localStorage.getItem(`v29_${p}_fold`)) || {};

      normalizeTimers();
      renderSched(); renderFavs(); syncTxt();
      addLog(`Profile ${p} Loaded`);
    }

    function pushUndo(msg) {
      st.undoStack = { timers: JSON.parse(JSON.stringify(st.timers || [])), recent: JSON.parse(JSON.stringify(st.recent || [])) };
      const toast = document.getElementById('undo-toast');
      document.getElementById('undo-msg').innerText = msg;
      toast.style.display = 'flex';
      if (st.undoT) clearTimeout(st.undoT);
      st.undoT = setTimeout(() => { toast.style.display = 'none'; st.undoStack = null; }, 5000);
    }

    function executeUndo() {
      if (!st.undoStack) return;
      st.timers = st.undoStack.timers || [];
      st.recent = st.undoStack.recent || [];
      saveStore(); renderSched(); renderFavs();
      document.getElementById('undo-toast').style.display = 'none';
      addLog("Undo executed");
    }

    function applyZenCalc() {
      const name = document.getElementById('zc-sel').value;
      const raw = (document.getElementById('zc-in').value || "").trim();
      const sec = parseMinSec(raw);
      if (sec <= 0) return alert("Please enter min sec. e.g., 8 44");
      setTimer(name, sec, raw);
      document.getElementById('zc-in').value = "";
      document.getElementById('zc-preview').innerText = "--:--:--";
      addLog(`[FORCE] ${name} forced sync (${raw})`);
    }

    function btl(type) {
      if (!st.on) return;
      const now = Date.now();
      if (type === 'start') { st.battle = { s: now, k: null, est: 0 }; addLog("Engagement Started"); }
      else if (type === 'kwang') {
        if (!st.battle.s) return;
        st.battle.k = now;
        st.battle.est = Math.floor(((now - st.battle.s) / 1000) * 0.51);
        addLog("Berserk Triggered");
      } else if (type === 'kill') { addLog("Target Neutralized"); st.battle = { s: null, k: null, est: 0 }; }
    }

    function setTimer(n, s, raw) {
      pushUndo(`${n} update`);
      const t = Date.now() + (s * 1000);
      const now = Date.now();
      const d0 = Math.floor((t - now) / 1000);
      const entry = { n, t, m5: false, m1: false, lastD: d0 };
      const i = (st.timers || []).findIndex(x => x.n === n);
      if (i > -1) st.timers[i] = entry; else st.timers.push(entry);
      st.recent = [n, ...st.recent.filter(x => x !== n)].slice(0, 5);
      if (raw !== "ÏûêÎèô") localStorage.setItem(`v29_${st.profile}_in_${n}`, raw);
      saveStore(); renderFavs(); addLog(`${n} mission set`);
    }

    function loop() {
      if (!st.on) return;
      const now = Date.now();
      st.timers = (st.timers || []).filter(t => (now - t.t) < 600000); // 10 min expiry

      st.timers.forEach(tm => {
        const d = Math.floor((tm.t - now) / 1000);
        const prev = (typeof tm.lastD === 'number') ? tm.lastD : d;
        if (!tm.m5 && prev > 300 && d <= 300) { triggerAlert(tm.n, "5Î∂Ñ Ï†Ñ"); tm.m5 = true; }
        if (!tm.m1 && prev > 60 && d <= 60) { triggerAlert(tm.n, "1Î∂Ñ Ï†Ñ"); tm.m1 = true; }
        tm.lastD = d;
      });

      const list = [...st.timers].sort((a, b) => a.t - b.t);
      const upcoming = list.filter(t => t.t > now);
      const next = upcoming.length ? upcoming[0] : null;

      document.getElementById('d-name').innerText = next ? next.n : "ÎåÄÍ∏∞ Ï§ë";
      document.getElementById('d-timer').innerText = next ? formatTimer(next.t - now) : "00:00:00";
      document.getElementById('d-meta').innerText = next ? `${new Date(next.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} (${BOSS_WORLD_MAP[next.n]})` : "-";
      document.getElementById('hero-card').className = (next && (next.t - now < 300000)) ? 'card hero-section imminent' : 'card hero-section';

      st.timers.forEach(tm => {
        const el = document.getElementById(`zen-${tm.n}`);
        if (el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
      });

      document.getElementById('top3-list').innerHTML = upcoming.slice(0, 3).map((t, i) => `
          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;">
            <span><b>${i+1}.</b> ${t.n}</span>
            <span style="color:var(--primary); font-family:Orbitron; font-weight:700;">${formatTimer(t.t - now).substring(3)}</span>
          </div>`).join('') || '<div style="color:#aaa; text-align:center;">Î¶¨Ï†† ÏòàÏ†ï Î≥¥Ïä§ ÏóÜÏùå</div>';

      if (st.battle.s && !st.battle.k) document.getElementById('b-elap').innerText = formatSimple((now - st.battle.s) / 1000);
      if (st.battle.k) {
        const rem = st.battle.est - Math.floor((now - st.battle.k) / 1000);
        document.getElementById('b-timer').innerText = (rem >= 0 ? "" : "+") + formatSimple(Math.abs(rem));
      }
      drawPIP(upcoming);
    }

    function renderSched() {
      const c = document.getElementById('sched-cont'); let h = '';
      bosses.forEach(g => {
        const folded = st.foldState[g.w] === true;
        h += `<div class="world-section ${folded ? 'is-folded' : ''}" data-world="${g.w}">
            <div class="world-banner" style="border-left-color:${g.c}" onclick="toggleFold('${g.w}')">
              <span>${folded ? '‚ñ∂' : '‚ñº'} ${g.w}</span>
              <button class="p-btn" style="height:28px; font-size:10px; background:#f8f9fa;" onclick="event.stopPropagation(); clearWorldTimers('${g.w}')">World Clear</button>
            </div>
            <div class="world-content">`;
        g.b.forEach(b => {
          const v29 = localStorage.getItem(`v29_${st.profile}_in_${b.n}`);
          const sv = (v29 !== null && v29 !== undefined) ? v29 : (localStorage.getItem(`v28_in_${b.n}`) || '');
          const isFav = st.favs.includes(b.n);
          h += `<div class="boss-row" data-name="${b.n}">
              <div style="cursor:pointer; font-size:18px; color:${isFav ? '#f1c40f' : '#ccc'};" onclick="toggleFav('${b.n}')">${isFav ? '‚òÖ' : '‚òÜ'}</div>
              <div style="font-weight:700;">${b.n}</div>
              <div><input type="text" class="v-in" data-name="${b.n}" value="${sv}" placeholder="Î∂Ñ/Ï¥à" onkeydown="if(event.key==='Enter') handleEnterNav(this, Array.from(document.querySelectorAll('.v-in')).indexOf(this))"></div>
              <div id="zen-${b.n}" class="zen-time-display">--:--</div>
              <button class="p-btn active" style="height:32px; font-size:11px;" onclick="setTimer('${b.n}', ${b.r*60}, 'ÏûêÎèô')">Killed</button>
              <button class="p-btn" style="height:32px; width:32px; padding:0; color:var(--danger); background:#fff;" onclick="delTimer('${b.n}')">√ó</button>
            </div>`;
        });
        h += `</div></div>`;
      });
      c.innerHTML = h; applyFilters();
    }

    function parseSmart(s) {
      if (!s) return 0;
      s = String(s).trim();
      let m = s.match(/(\d+)\s*ÏãúÍ∞Ñ\s*(\d+)\s*Î∂Ñ(?:\s*(\d+)\s*Ï¥à?)?/);
      if (m) return (+m[1]) * 3600 + (+m[2]) * 60 + (m[3] ? +m[3] : 0);
      m = s.match(/(\d+)\s*Î∂Ñ\s*(\d+)\s*Ï¥à/);
      if (m) return (+m[1]) * 60 + (+m[2]);
      m = s.match(/(\d+)\s*Î∂Ñ/);
      if (m) return (+m[1]) * 60;
      const parts = s.split(/[:\s]+/).filter(Boolean).map(Number);
      if (parts.some(v => Number.isNaN(v))) return 0;
      if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
      if (parts.length === 2) return parts[0] * 60 + parts[1];
      if (parts.length === 1) return parts[0] * 60;
      return 0;
    }

    /* ---------------------------------------------------------
       AUXILIARY FUNCTIONS
       --------------------------------------------------------- */

    function saveStore() {
        localStorage.setItem(`v29_${st.profile}_timers`, JSON.stringify(st.timers));
        localStorage.setItem(`v29_${st.profile}_recent`, JSON.stringify(st.recent));
        localStorage.setItem(`v29_${st.profile}_fold`, JSON.stringify(st.foldState));
        syncTxt();
    }

    function handleEnterNav(el, idx) {
        const inputs = Array.from(document.querySelectorAll('.v-in'));
        const sec = parseSmart(el.value);
        if(sec > 0) setTimer(el.dataset.name, sec, el.value);
        for(let i = idx + 1; i < inputs.length; i++) {
            if(inputs[i].offsetParent !== null) { inputs[i].focus(); inputs[i].select(); break; }
        }
    }

    function toggleFold(w) { st.foldState[w] = !st.foldState[w]; saveStore(); renderSched(); }
    function toggleAllFolds(s) { bosses.forEach(g => st.foldState[g.w] = s); saveStore(); renderSched(); }
    function handleSearch(v) { st.searchTerm = v.toLowerCase(); applyFilters(); }
    function applyFilters() {
        const activeOnly = document.getElementById('active-only').checked; const now = Date.now();
        document.querySelectorAll('.world-section').forEach(sec => {
            let visible = 0; sec.querySelectorAll('.boss-row').forEach(row => {
                const name = row.dataset.name.toLowerCase(); const timer = st.timers.find(t => t.n === row.dataset.name);
                const show = name.includes(st.searchTerm) && (!activeOnly || (timer && timer.t > now));
                row.style.display = show ? 'grid' : 'none'; if(show) visible++;
            });
            sec.style.display = visible > 0 ? 'block' : 'none';
        });
    }

    function delTimer(n) { pushUndo(`${n} deleted`); st.timers = st.timers.filter(t => t.n !== n); saveStore(); renderSched(); }
    function confirmClear() { if(confirm("Clear all timers?")) { pushUndo("Full Clear"); st.timers = []; saveStore(); renderSched(); } }
    function clearWorldTimers(w) { if(confirm(`${w} Clear?`)) { const list = bosses.find(g => g.w === w).b.map(b => b.n); st.timers = st.timers.filter(t => !list.includes(t.n)); saveStore(); renderSched(); } }
    function applyShift(dir) { const mins = parseInt(document.getElementById('shift-min').value) || 0; if(mins <= 0) return; pushUndo(`Shift ${mins}m`); const now = Date.now(); st.timers = st.timers.map(t => { if (t.t > now) t.t += mins * 60000 * dir; return t; }); saveStore(); renderSched(); }
    
    function tab(id, el) {
        document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id==='set-txt') syncTxt();
    }

    function triggerAlert(name, msg) {
        addLog(`[ALERT] ${name} ${msg}`);
        playTTS(`${name} ${msg}ÏûÖÎãàÎã§.`);
        try { const ctx = new AudioContext(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); osc.frequency.value = 440; osc.start(); osc.stop(ctx.currentTime + 0.2); } catch(e){}
    }

    function playTTS(m) { if(st.on){ const u = new SpeechSynthesisUtterance(m); u.lang='ko-KR'; window.speechSynthesis.speak(u); } }
    function addLog(m) { const box = document.getElementById('logs'); const div = document.createElement('div'); div.innerHTML = `<span style="color:#aaa;">[${new Date().toLocaleTimeString()}]</span> ${m}`; box.appendChild(div); }
    function syncTxt() { const n = new Date(); let txt = `PROFILE ${st.profile} - ${n.getMonth()+1}.${n.getDate()}\n`; st.timers.sort((a,b)=>a.t-b.t).forEach(tm => { txt += `${new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} ${tm.n}\n`; }); document.getElementById('txt-ed').value = txt; }
    function saveText() { const lines = document.getElementById('txt-ed').value.split('\n'); const nt = []; lines.forEach(l => { const m = l.match(/(\d{2}:\d{2})\s+(.+)/); if(m) nt.push({ n: m[2].trim(), t: new Date(new Date().setHours(m[1].split(':')[0], m[1].split(':')[1], 0, 0)).getTime(), m5:false, m1:false, lastD: 9999 }); }); st.timers = nt; saveStore(); renderSched(); tab('dash', document.querySelectorAll('.nav-item')[0]); }
    function togglePwr() { st.on = !st.on; document.getElementById('pwr').style.color = st.on ? 'var(--success)' : '#ccc'; document.body.classList.toggle('system-off', !st.on); addLog(`System ${st.on?'ON':'OFF'}`); }
    function findBoss(n) { let r = null; bosses.forEach(g => g.b.forEach(b => { if(b.n===n) r=b; })); return r; }
    function parseMinSec(s) { const p = (s||"").split(/[:\s]+/).filter(Boolean).map(Number); return p.length>=2?(p[0]*60)+p[1]:(p.length===1?p[0]*60:0); }
    function formatTimer(ms) { if(ms<0) return "00:00:00"; const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(Math.floor(s%60)).toString().padStart(2,'0')}`; }
    function testAlert() { triggerAlert("ÌÖåÏä§Ìä∏", "ÏïåÎ¶º ÌÖåÏä§Ìä∏"); }
    async function toggleWakeLock() { if(!('wakeLock' in navigator)) return alert("Not supported"); if(st.wakeLock){ await st.wakeLock.release(); st.wakeLock=null; document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ OFF"; } else { requestWakeLock(false); } }
    async function requestWakeLock(silent) { try { st.wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ ON"; } catch(e){} }
    function toggleFav(n) { const i = st.favs.indexOf(n); if(i > -1) st.favs.splice(i, 1); else st.favs.push(n); localStorage.setItem(`v29_${st.profile}_favs`, JSON.stringify(st.favs)); renderSched(); renderFavs(); }
    function renderFavs() { const p = document.getElementById('fav-panel'); let h = ''; st.favs.forEach(n => h += `<div class="chip is-fav" onclick="quickKill('${n}')">‚≠ê ${n}</div>`); st.recent.forEach(n => { if(!st.favs.includes(n)) h += `<div class="chip" onclick="quickKill('${n}')">${n}</div>`; }); p.innerHTML = h; }
    function quickKill(name) { const n = name || document.getElementById('quick-sel').value; const b = findBoss(n); if(b) setTimer(n, b.r * 60, "ÏûêÎèô"); }
    function copyKakao(mode) {
        const now = Date.now(); const list = mode === 'top3' ? st.timers.filter(t => t.t > now).sort((a,b)=>a.t-b.t).slice(0,3) : [...st.timers].sort((a,b)=>a.t-b.t);
        if(!list.length) return alert("No active timers");
        const dH = `[${new Date().toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short' })} Ïò§Îîò Î≥¥Ïä§ Ï††]`;
        let txt = mode==='top3' ? dH+'\n' : `${new Date().getMonth()+1}.${new Date().getDate()}\n`;
        list.forEach((t,i) => {
            const zT = new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            if(mode==='top3') txt += `${i+1}) ${zT} ${t.n} (${BOSS_WORLD_MAP[t.n]||"-"}) - ÎÇ®ÏùÄ ${formatTimer(t.t-now).substring(3)}\n`;
            else txt += `${zT} ${t.n}\n`;
        });
        navigator.clipboard.writeText(txt.trim()).then(()=>alert("Î≥µÏÇ¨ ÏôÑÎ£å"));
    }
    function drawPIP(list) {
        const ctx = document.getElementById('pip-canvas').getContext('2d');
        ctx.fillStyle="#fff"; ctx.fillRect(0,0,220,120);
        ctx.fillStyle="#2d3436"; ctx.fillRect(0,0,220,35);
        ctx.fillStyle="#fff"; ctx.font="bold 13px Arial"; ctx.fillText("B-OPS PiP", 15, 23);
        if(list.length>0){
            const n=list[0], d=n.t-Date.now();
            ctx.fillStyle="#1a237e"; ctx.font="bold 22px 'Noto Sans KR'"; ctx.textAlign="center"; ctx.fillText(n.n, 110, 75);
            ctx.fillStyle="#000"; ctx.font="bold 32px Orbitron"; ctx.fillText(formatTimer(d).substring(3), 110, 108);
        }
    }
    async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }
    function openBackup() { const data = { timers: st.timers, favs: st.favs, folds: st.foldState }; prompt("Backup (Copy JSON):", JSON.stringify(data)); }
    function handleKeys(e) { if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return; if(e.key==='/'){e.preventDefault(); document.getElementById('search-boss').focus();} if(e.ctrlKey && e.key==='z'){e.preventDefault(); executeUndo();} if(e.key>='1'&&e.key<='5'){const items=document.querySelectorAll('.nav-item'); if(items[e.key-1]) items[e.key-1].click();} }

    init();
</script>
</body>
</html>
