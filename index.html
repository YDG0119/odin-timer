<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32.1 MASTER</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f5f7; --bg-card: #ffffff; --border: #dee2e6;
            --primary: #1a237e; --primary-light: #e8eaf6;
            --text-main: #212529; --text-sub: #6c757d;
            --danger: #d32f2f; --warning: #ef6c00; --success: #2e7d32;
            --sidebar-w: 220px; --header-h: 60px;
        }

        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: var(--bg-page); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        body.system-off { filter: grayscale(1) brightness(0.9); pointer-events: none; }
        body.system-off header, body.system-off nav { pointer-events: auto !important; filter: none !important; }

        /* Sidebar */
        nav { width: var(--sidebar-w); background: #ffffff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; flex-shrink: 0; }
        .nav-brand { padding: 0 25px 20px; font-weight: 900; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; letter-spacing: -0.5px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: var(--text-sub); transition: 0.2s; gap: 12px; font-weight: 700; font-size: 13px; }
        .nav-item:hover { background: #f8f9fa; color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { height: var(--header-h); background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        
        /* Ï∞Ω ÏÇ¨Ïù¥Ï¶à ÏµúÏ†ÅÌôî */
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .pane { display: none; width: 100%; max-width: 720px; animation: fadeIn 0.15s ease; }
        .pane.active { display: block; }
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

        /* Dashboard Components */
        .hero-section { text-align: center; padding: 25px 0; border-bottom: 1px solid #f8f9fa; }
        .timer-big { font-family: 'JetBrains Mono'; font-size: 52px; font-weight: 700; color: var(--primary); margin: 10px 0; letter-spacing: -2px; }
        .imminent .timer-big { color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .boss-row { display: grid; grid-template-columns: 35px 90px 1fr 100px 75px 35px; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f1f3f5; gap: 8px; }
        .zen-time-display { font-family: 'JetBrains Mono'; font-weight: 700; text-align: right; color: var(--text-main); font-size: 13px; }
        .prev-time { font-size: 10px; color: var(--warning); font-weight: 700; height: 12px; }

        .v-in { height: 30px; width: 100%; border-radius: 6px; border: 1px solid #dee2e6; text-align: center; font-family: 'JetBrains Mono'; font-weight: 700; font-size: 12px; background: #fdfdfd; }
        .v-in:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }

        .chip { padding: 6px 14px; border-radius: 20px; background: #f1f3f5; border: 1px solid #e2e8f0; cursor: pointer; font-size: 11px; font-weight: 700; }
        .chip.is-fav { border-color: #ffd700; background: #fffdf0; color: #b79500; }
        
        .log-box { font-family: 'JetBrains Mono'; font-size: 11px; height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; line-height: 1.6; }
        
        .profile-group { display: flex; gap: 4px; background: #f1f3f5; padding: 4px; border-radius: 10px; }
        .p-btn { padding: 6px 14px; border-radius: 7px; border: none; cursor: pointer; font-weight: 800; font-size: 10px; transition: 0.2s; }
        .p-btn.active { background: var(--primary); color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        #undo-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2d3436; color: #fff; padding: 12px 25px; border-radius: 30px; display: none; align-items: center; gap: 15px; z-index: 5000; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .undo-btn { color: #55efc4; font-weight: 700; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<nav id="sidebar">
    <div class="nav-brand">B-OPS V32.1</div>
    <div class="nav-item active" onclick="tab('dash', this)">üè† Dashboard</div>
    <div class="nav-item" onclick="tab('sched', this)">üìÖ Boss Schedule</div>
    <div class="nav-item" onclick="tab('set-txt', this)">üïí Text Sync</div>
    <div class="nav-item" onclick="tab('battle', this)">‚öî Battle Ops</div>
    <div class="nav-item" onclick="tab('zen-calc', this)">üßÆ Forced Update</div>
    <div class="nav-item" onclick="togglePIP()">üì∫ Toggle PIP</div>
</nav>

<main>
    <header>
        <div class="profile-group">
            <button class="p-btn active" data-p="A" onclick="switchProfile('A')">PROFILE A</button>
            <button class="p-btn" data-p="B" onclick="switchProfile('B')">PROFILE B</button>
            <button class="p-btn" data-p="C" onclick="switchProfile('C')">PROFILE C</button>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="p-btn" style="background:#fff; border:1px solid var(--border);" onclick="testAlert()">üîî Test</button>
            <button id="wl-btn" class="p-btn" style="background:#fff; border:1px solid var(--border);" onclick="toggleWakeLock()">üõ° ÌôîÎ©¥Ïú†ÏßÄ OFF</button>
            <div id="pwr" style="cursor:pointer; font-size:24px; color:var(--success); margin-left:10px;" onclick="togglePwr()">‚èª</div>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div class="card hero-section" id="hero-card">
                <div style="font-weight:800; color:var(--text-sub); font-size:11px; letter-spacing:1.5px; opacity:0.7;">ACTIVE MISSION</div>
                <div id="d-name" style="font-size:32px; font-weight:900; margin-top:10px; letter-spacing:-1px;">ÎåÄÍ∏∞ Ï§ë</div>
                <div id="d-timer" class="timer-big">00:00:00</div>
                <div id="d-meta" style="color:var(--text-sub); font-weight:700; font-size:13px;">-</div>

                <div style="display:flex; gap:8px; margin: 25px 0; background:var(--primary-light); padding:12px; border-radius:12px;">
                    <select id="quick-sel" style="flex:1; height:40px; border-radius:8px; border:1px solid #cbd5e0; font-weight:700; padding:0 12px;"></select>
                    <button class="p-btn active" style="height:40px; padding:0 25px; font-size:12px;" onclick="quickKill()">KILLED</button>
                </div>
                
                <div id="fav-panel" class="fav-recent-bar"></div>
                <div id="top3-list" style="margin-top:20px; text-align:left; background:#f8f9fa; padding:18px; border-radius:12px; border:1px solid #edf2f7;"></div>

                <div style="display:flex; gap:10px; justify-content:center; margin-top:25px;">
                    <button class="p-btn active" style="height:42px; padding:0 30px; font-size:13px;" onclick="copyKakao('top3')">üì¢ Top3 Î≥µÏÇ¨</button>
                    <button class="p-btn" style="height:42px; padding:0 30px; background:#e2e8f0; color:#475569;" onclick="copyKakao('all')">üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨</button>
                </div>
            </div>
            
            <div class="card">
                <div style="font-weight:800; margin-bottom:12px; color:var(--primary); font-size:12px; letter-spacing:0.5px;">MISSION COMMAND LOGS</div>
                <div id="logs" class="log-box"></div>
            </div>
        </div>

        <div id="sched" class="pane">
            <div class="card" style="padding:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:#f8f9fa; margin-bottom:15px; border-radius:12px;">
                <input type="text" id="search-boss" placeholder="Î≥¥Ïä§Î™Ö ÌïÑÌÑ∞..." style="width:160px; height:34px; padding:0 12px; border:1px solid #ddd; border-radius:8px;" oninput="handleSearch(this.value)">
                <label style="display:flex; align-items:center; gap:6px; font-weight:700; font-size:12px;"><input type="checkbox" id="active-only" onchange="applyFilters()"> ÌôúÏÑ±Îßå</label>
                <div style="flex:1;"></div>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="toggleAllFolds(false)">ÌéºÏπòÍ∏∞</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd;" onclick="toggleAllFolds(true)">Ï†ëÍ∏∞</button>
                <button class="p-btn" style="background:#fff; border:1px solid #ddd; color:var(--danger);" onclick="confirmClear()">Ï¥àÍ∏∞Ìôî</button>
            </div>
            <div id="sched-cont"></div>
        </div>

        <div id="set-txt" class="pane">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; font-weight:900;">Manual Ops Synchronization</h3>
                    <button class="p-btn active" style="height:36px; padding:0 20px;" onclick="saveText()">Ï†ÄÏû• ÌõÑ Ï†ÅÏö©</button>
                </div>
                <textarea id="txt-ed" style="width:100%; height:500px; border:1px solid var(--border); padding:20px; font-family:'JetBrains Mono'; font-size:13px; line-height:1.8; border-radius:10px; resize:none; background:#fcfcfc;"></textarea>
            </div>
        </div>

        <div id="battle" class="pane">
            <div class="card">
                <h3 style="text-align:center; font-weight:900; margin-top:0;">Tactical Battle Tracker</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:25px 0;">
                    <div style="background:#f8f9fa; padding:25px; border-radius:15px; text-align:center; border:1px solid #eee;">
                        <small style="font-weight:800; color:#999; letter-spacing:1px;">ELAPSED</small>
                        <div id="b-elap" style="font-family:Orbitron; font-size:40px; font-weight:700; margin-top:5px; color:#2d3436;">00:00</div>
                    </div>
                    <div style="background:#fff5f5; padding:25px; border-radius:15px; text-align:center; border:1px solid #fed7d7;">
                        <small style="font-weight:800; color:#e53e3e; letter-spacing:1px;">BERSERK PREDICT</small>
                        <div id="b-timer" style="font-family:Orbitron; font-size:40px; font-weight:700; color:var(--danger); margin-top:5px;">--:--</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                    <button class="p-btn" style="height:55px; background:#455a64; color:#fff; font-size:13px;" onclick="btl('start')">START</button>
                    <button class="p-btn" style="height:55px; background:var(--warning); color:#fff; font-size:13px;" onclick="btl('kwang')">BERSERK</button>
                    <button class="p-btn active" style="height:55px; font-size:13px;" onclick="btl('kill')">KILLED</button>
                </div>
            </div>
        </div>

        <div id="zen-calc" class="pane">
            <div class="card" style="display:grid; grid-template-columns: 1fr; gap:20px;">
                <div>
                    <h3 style="margin-top:0; font-weight:900;">Mission Force Update</h3>
                    <select id="zc-sel" style="width:100%; height:45px; border-radius:10px; border:1px solid var(--border); margin-bottom:15px; font-weight:700; padding:0 15px; background:#fff;"></select>
                    <input type="text" id="zc-in" style="width:100%; height:60px; text-align:center; font-family:'JetBrains Mono'; font-size:32px; border:2px solid var(--primary); border-radius:10px; background:#f0f4ff;" placeholder="0 0" oninput="previewCalc(this.value)">
                    <button class="p-btn active" style="width:100%; height:55px; margin-top:20px; font-size:15px; letter-spacing:1px;" onclick="applyZenCalc()">UPDATE MISSION TIME</button>
                </div>
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8faff; border-radius:15px; border:2px dashed var(--primary); padding:30px;">
                    <span style="font-weight:800; color:var(--primary); font-size:12px; letter-spacing:1px; margin-bottom:10px;">SPAWN AT (PREVIEW)</span>
                    <span id="zc-preview" style="font-family:'JetBrains Mono'; font-size:48px; color:var(--primary); font-weight:700;">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="undo-toast">
    <span id="undo-msg">Action processed.</span>
    <span class="undo-btn" onclick="executeUndo()">ÎêòÎèåÎ¶¨Í∏∞ (Undo)</span>
</div>

<canvas id="pip-canvas" width="240" height="135" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline style="display:none;"></video>

<script>
    /* [1] Ï†Ñ ÏßÄÏó≠ Î≥¥Ïä§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© & ÏïºÎ•∏ Î™ÖÏπ≠ ÏàòÏ†ï */
    const bosses = [
        { w: "ÏöîÌà∞ÌïòÏûÑ", c: "#3f51b5", b: [{n:"ÏïºÎ•∏", r:240}, {n:"ÌååÎ•¥Î∞î", r:120}, {n:"ÏÖÄÎ°úÎπÑÏïÑ", r:720}, {n:"ÌùêÎãàÎ•¥", r:720}, {n:"ÌéòÌã∞", r:720}, {n:"Î∞îÏö∞Ìã∞", r:120}, {n:"ÎãàÎìúÌò∏Í∑∏", r:1440}, {n:"Ìã∞Î•¥", r:1440}] },
        { w: "ÎãàÎã§Î≤®Î¶¨Î•¥", c: "#43a047", b: [{n:"ÎùºÏù¥ÎÖ∏Î•¥", r:720}, {n:"ÎπÑÏöîÎ•∏", r:720}, {n:"Ìó§Î•¥Î™®Îìú", r:240}, {n:"Ïä§ÏπºÎùºÎãàÎ•¥", r:120}, {n:"Î∏åÎ•ÄÌûêÎìú", r:720}, {n:"ÎùºÌÉÄÌÜ†Ïä§ÌÅ¨", r:240}, {n:"ÏàòÎìúÎ¶¨", r:720}, {n:"ÌÜ†Î•¥", r:1440}] },
        { w: "ÏïåÎ∏åÌïòÏûÑ", c: "#ef6c00", b: [{n:"Ïä§Î∞îÎ•¥Ìä∏", r:240}, {n:"ÎëêÎùºÏä§Î°úÎ•¥", r:480}, {n:"Î™®ÎÑ§Í∞ÄÎ¶Ñ", r:120}, {n:"ÎìúÎùºÏö∞Í∑∏", r:240}, {n:"Íµ¥Î≤†Ïù¥Í∑∏", r:480}, {n:"Ïò§Îîò", r:1440}] },
        { w: "Î¨¥Ïä§Ìé†ÌïòÏûÑ", c: "#c62828", b: [{n:"Î©îÍ∏∞Î•¥", r:120}, {n:"Ïã†ÎßàÎùº", r:720}, {n:"Ìó§Î•¥Í∞ÄÎ¶Ñ", r:120}, {n:"ÌÉïÍ∑∏Î¶¨Ïä§ÎãàÎ•¥", r:240}, {n:"ÏóòÎìúÎ£¨", r:720}, {n:"Ïö∞Î°úÎ≥¥Î°úÏä§", r:1440}, {n:"ÏàòÎ•¥Ìä∏", r:1440}] },
        { w: "Î∞îÎÇòÌïòÏûÑ", c: "#689f38", b: [{n:"ÏóòÎîîÎ•¥", r:1440}, {n:"ÏïàÎÇòÎ•¥ÏóòÎîîÎ•¥", r:1440}, {n:"Ïä§Ïø®Îìú", r:1440}, {n:"Ïä§Ïπ¥Îîî", r:1440}, {n:"ÏóêÍ∏∞Î•¥", r:1440}, {n:"ÌîºÎ•¥Í∞ÄÎ∏å", r:240}] },
        { w: "ÏïÑÏä§Í∞ÄÎ•¥Îìú", c: "#7b1fa2", b: [{n:"Î∞úÎ¶¨", r:120}, {n:"ÎÖ∏Ìä∏", r:480}, {n:"ÏÉ§Î¨¥ÌÅ¨", r:120}, {n:"Ïä§ÏπºÎìúÎ©îÎ•¥", r:120}, {n:"ÌôîÏã†Í∑∏Î°úÏïÑ", r:1440}, {n:"ÎØ∏ÎØ∏Î•¥", r:240}, {n:"Ïù¥ÎØ∏Î•¥", r:240}, {n:"Î™®Î•¥Í∞ÄÎÇò", r:240}] },
        { w: "ÎãàÌîåÌïòÏûÑ", c: "#0097a7", b: [{n:"ÌûàÎ°úÌÇ®", r:1440}, {n:"Ìò∏Îìú", r:1440}, {n:"Ìó§Ïù¥Îìú", r:1440}, {n:"ÎåÄÍµêÏ£º", r:1440}, {n:"ÌîÑÎ†àÏù¥", r:1440}, {n:"Ïù¥ÎØ∏Î•¥", r:1440}] },
        { w: "ÎçòÏ†Ñ", c: "#455a64", b: [{n:"ÏßÄÍ∞ê7Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê4Ï∏µ", r:480}, {n:"ÏßÄÍ∞ê10Ï∏µ", r:480}, {n:"ÏµúÌïòÏ∏µ Íµ¥Î≤†Ïù¥Í∑∏", r:480}] }
    ];

    const BOSS_WORLD_MAP = {};
    bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));

    let st = {
        on: true, profile: 'A', timers: [], favs: [], recent: [], pins: [],
        battle: { s: null, k: null, est: 0 },
        foldState: {}, searchTerm: '', wakeLock: null,
        undoStack: null, undoT: null, _keyCache: {}
    };

    /* [2] Safe DOM Key (FNV-1a 32-bit Hash) */
    function fnv1a32(str) {
        let h = 0x811c9dc5;
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
        }
        return h >>> 0;
    }
    function safeKey(name) {
        const k = String(name);
        if (st._keyCache[k]) return st._keyCache[k];
        const v = "b" + fnv1a32(k).toString(36);
        st._keyCache[k] = v;
        return v;
    }
    const zenId = (n) => `zen-${safeKey(n)}`;
    const prevId = (n) => `prev-${safeKey(n)}`;

    /* [3] Audio Context Singleton & Leak Fix */
    let __audioCtx = null;
    function getAudioCtx() {
        if (!__audioCtx) __audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        try { if (__audioCtx.state === "suspended") __audioCtx.resume(); } catch (e) {}
        return __audioCtx;
    }

    /* [4] Migration (ÏïºÎ£¨ -> ÏïºÎ•∏) */
    function migrateYarun() {
        const oldN = "ÏïºÎ£¨", newN = "ÏïºÎ•∏";
        st.timers.forEach(t => { if(t.n === oldN) t.n = newN; });
        ["favs", "recent", "pins"].forEach(k => { if(st[k]) st[k] = st[k].map(x => x === oldN ? newN : x); });
        const oldInput = localStorage.getItem(`v29_${st.profile}_in_${oldN}`);
        if(oldInput) {
            localStorage.setItem(`v29_${st.profile}_in_${newN}`, oldInput);
            localStorage.removeItem(`v29_${st.profile}_in_${oldN}`);
        }
    }

    function init() {
        const lastP = localStorage.getItem('v29_current_p') || 'A';
        switchProfile(lastP);

        const qSel = document.getElementById('quick-sel');
        const zSel = document.getElementById('zc-sel');
        bosses.forEach(g => g.b.forEach(b => {
            const opt = `<option value="${b.n}">${b.n}</option>`;
            qSel.innerHTML += opt; zSel.innerHTML += opt;
        }));

        document.addEventListener('visibilitychange', () => { if(st.wakeLock && document.visibilityState === 'visible') requestWakeLock(true); });
        setInterval(loop, 1000);
        addLog("Mission Desk Master V32.1 Ready");
    }

    function switchProfile(p) {
        st.profile = p; localStorage.setItem('v29_current_p', p);
        document.querySelectorAll('.p-btn[data-p]').forEach(b => b.classList.toggle('active', b.dataset.p === p));

        st.timers = JSON.parse(localStorage.getItem(`v29_${p}_timers`)) || [];
        st.favs = JSON.parse(localStorage.getItem(`v29_${p}_favs`)) || [];
        st.recent = JSON.parse(localStorage.getItem(`v29_${p}_recent`)) || [];
        st.foldState = JSON.parse(localStorage.getItem(`v29_${p}_fold`)) || {};
        st.pins = JSON.parse(localStorage.getItem(`v29_${p}_pins`)) || [];

        migrateYarun();
        renderSched(); renderFavs(); syncTxt();
        addLog(`Profile ${p} Loaded`);
    }

    function loop() {
        if (!st.on) return;
        const now = Date.now();
        st.timers = st.timers.filter(t => (now - t.t) < 600000);

        st.timers.forEach(tm => {
            const d = Math.floor((tm.t - now) / 1000);
            const prev = (typeof tm.lastD === 'number') ? tm.lastD : d;
            if (!tm.m5 && prev > 300 && d <= 300) { triggerAlert(tm.n, "5Î∂Ñ Ï†Ñ"); tm.m5 = true; }
            if (!tm.m1 && prev > 60 && d <= 60) { triggerAlert(tm.n, "1Î∂Ñ Ï†Ñ"); tm.m1 = true; }
            tm.lastD = d;

            // Loop Optimization: Only update specific IDs
            const el = document.getElementById(zenId(tm.n));
            if (el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
        });

        const pinSet = new Set(st.pins);
        const list = [...st.timers].sort((a, b) => {
            const ap = pinSet.has(a.n) ? 1 : 0;
            const bp = pinSet.has(b.n) ? 1 : 0;
            return ap !== bp ? bp - ap : a.t - b.t;
        });

        const upcoming = list.filter(t => t.t > now);
        const next = upcoming.length ? upcoming[0] : null;

        document.getElementById('d-name').innerText = next ? next.n : "ÎåÄÍ∏∞ Ï§ë";
        document.getElementById('d-timer').innerText = next ? formatTimer(next.t - now) : "00:00:00";
        document.getElementById('d-meta').innerText = next ? `${new Date(next.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} (${BOSS_WORLD_MAP[next.n]})` : "-";
        document.getElementById('hero-card').className = (next && (next.t - now < 300000)) ? 'card hero-section imminent shadow-lg' : 'card hero-section';

        document.getElementById('top3-list').innerHTML = upcoming.slice(0, 3).map((t, i) => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #edf2f7; align-items:center;">
                <span style="font-weight:700;">${pinSet.has(t.n)?'üìå ':''}${i+1}. ${t.n}</span>
                <span style="color:var(--primary); font-family:'JetBrains Mono'; font-weight:700; font-size:14px;">${formatTimer(t.t - now).substring(3)}</span>
            </div>`).join('') || '<div style="color:#aaa; text-align:center;">Î¶¨Ï†† ÏòàÏ†ï Î≥¥Ïä§ ÏóÜÏùå</div>';

        if (st.battle.s && !st.battle.k) document.getElementById('b-elap').innerText = formatSimple((now - st.battle.s) / 1000);
        if (st.battle.k) {
            const rem = st.battle.est - Math.floor((now - st.battle.k) / 1000);
            document.getElementById('b-timer').innerText = (rem >= 0 ? "" : "+") + formatSimple(Math.abs(rem));
        }
        drawPIP(upcoming);
    }

    function triggerAlert(name, msg) {
        addLog(`[ALERT] ${name} ${msg}`);
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(`${name} ${msg}ÏûÖÎãàÎã§.`);
        u.lang = 'ko-KR'; window.speechSynthesis.speak(u);

        try {
            const ctx = getAudioCtx();
            const gain = ctx.createGain();
            const osc = ctx.createOscillator();
            gain.gain.setValueAtTime(0.0001, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
            osc.frequency.value = 440;
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.2);
            osc.onended = () => { osc.disconnect(); gain.disconnect(); };
        } catch(e){}
    }

    function renderSched() {
        const c = document.getElementById('sched-cont'); let h = '';
        const timerMap = new Map(st.timers.map(t => [t.n, t]));
        const pinSet = new Set(st.pins);

        bosses.forEach(g => {
            const folded = st.foldState[g.w] === true;
            h += `<div class="world-section ${folded ? 'is-folded' : ''}" data-world="${g.w}">
                <div class="world-banner" style="border-left-color:${g.c}" onclick="toggleFold('${g.w}')">
                    <span style="font-size:13px;">${folded ? '‚ñ∂' : '‚ñº'} <b>${g.w}</b></span>
                    <button class="p-btn" style="height:28px; font-size:10px; background:#f8f9fa;" onclick="event.stopPropagation(); clearWorldTimers('${g.w}')">World Clear</button>
                </div>
                <div class="world-content">`;
            g.b.forEach(b => {
                const sv = localStorage.getItem(`v29_${st.profile}_in_${b.n}`) || '';
                const isFav = st.favs.includes(b.n);
                const isPin = pinSet.has(b.n);
                const tm = timerMap.get(b.n);
                const zenTxt = tm ? new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}) : '--:--';

                h += `<div class="boss-row" data-name="${b.n}">
                    <div style="cursor:pointer; font-size:16px;" onclick="togglePin('${b.n}')">${isPin ? 'üìå' : 'üìç'}</div>
                    <div style="font-weight:700; display:flex; align-items:center; gap:5px;">
                        <span style="cursor:pointer; font-size:18px; color:${isFav ? '#ffd700' : '#ccc'};" onclick="toggleFav('${b.n}')">${isFav ? '‚òÖ' : '‚òÜ'}</span>
                        ${b.n}
                    </div>
                    <div>
                        <input type="text" class="v-in" data-name="${b.n}" value="${sv}" placeholder="Î∂Ñ/Ï¥à" 
                            oninput="previewSpawn(this)"
                            onblur="clearPreview(this)"
                            onkeydown="if(event.key==='Enter') handleEnterNav(this, Array.from(document.querySelectorAll('.v-in')).indexOf(this))">
                    </div>
                    <div class="zen-time-display">
                        <div id="${zenId(b.n)}">${zenTxt}</div>
                        <div id="${prevId(b.n)}" class="prev-time uppercase"></div>
                    </div>
                    <button class="p-btn active" style="height:30px; font-size:11px;" onclick="setTimer('${b.n}', ${b.r*60}, 'ÏûêÎèô')">Killed</button>
                    <button class="p-btn" style="height:30px; width:30px; padding:0; color:var(--danger); background:#fff;" onclick="delTimer('${b.n}')">√ó</button>
                </div>`;
            });
            h += `</div></div>`;
        });
        c.innerHTML = h; applyFilters();
    }

    /* Live Preview */
    function previewSpawn(el) {
        const name = el.dataset.name;
        const sec = parseSmart(el.value);
        const box = document.getElementById(prevId(name));
        if (sec > 0) {
            const time = new Date(Date.now() + sec * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            box.innerText = `Soon ${time}`;
        } else box.innerText = "";
    }
    function clearPreview(el) { document.getElementById(prevId(el.dataset.name)).innerText = ""; }
    function previewCalc(val) {
        const sec = parseSmart(val);
        document.getElementById('zc-preview').innerText = sec > 0 ? new Date(Date.now() + sec*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false}) : "--:--:--";
    }

    function togglePin(n) {
        const i = st.pins.indexOf(n);
        if(i > -1) st.pins.splice(i, 1); else st.pins.push(n);
        localStorage.setItem(`v29_${st.profile}_pins`, JSON.stringify(st.pins));
        renderSched();
    }

    /* Logic Overrides */
    function setTimer(n, s, raw) {
        pushUndo(`${n} update`);
        const t = Date.now() + (s * 1000);
        const now = Date.now();
        const entry = { n, t, m5: false, m1: false, lastD: Math.floor((t - now) / 1000) };
        st.timers = st.timers.filter(x => x.n !== n);
        st.timers.push(entry);
        st.recent = [n, ...st.recent.filter(x => x !== n)].slice(0, 5);
        if (raw !== "ÏûêÎèô") localStorage.setItem(`v29_${st.profile}_in_${n}`, raw);
        saveStore(); renderSched(); renderFavs(); addLog(`${n} mission set`);
    }

    function parseSmart(s) {
        if (!s) return 0;
        s = String(s).trim();
        const parts = s.split(/[:\s]+/).filter(Boolean).map(Number);
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        if (parts.length === 1 && !isNaN(parts[0])) return parts[0] * 60;
        return 0;
    }

    function confirmClear() { if(confirm("CLEAR Î•º ÏûÖÎ†•ÌïòÎ©¥ Ï†ÑÏ≤¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.")) { pushUndo("Full Clear"); st.timers = []; saveStore(); renderSched(); } }
    function saveStore() {
        localStorage.setItem(`v29_${st.profile}_timers`, JSON.stringify(st.timers));
        localStorage.setItem(`v29_${st.profile}_recent`, JSON.stringify(st.recent));
        localStorage.setItem(`v29_${st.profile}_fold`, JSON.stringify(st.foldState));
        localStorage.setItem(`v29_${st.profile}_pins`, JSON.stringify(st.pins));
        syncTxt();
    }

    /* Keep existing UI functions */
    function toggleFold(w) { st.foldState[w] = !st.foldState[w]; saveStore(); renderSched(); }
    function toggleAllFolds(s) { bosses.forEach(g => st.foldState[g.w] = s); saveStore(); renderSched(); }
    function handleSearch(v) { st.searchTerm = v.toLowerCase(); applyFilters(); }
    function applyFilters() {
        const activeOnly = document.getElementById('active-only').checked; const now = Date.now();
        document.querySelectorAll('.world-section').forEach(sec => {
            let visible = 0; sec.querySelectorAll('.boss-row').forEach(row => {
                const name = row.dataset.name.toLowerCase(); const timer = st.timers.find(t => t.n === row.dataset.name);
                const show = name.includes(st.searchTerm) && (!activeOnly || (timer && timer.t > now));
                row.style.display = show ? 'grid' : 'none'; if(show) visible++;
            });
            sec.style.display = visible > 0 ? 'block' : 'none';
        });
    }
    function delTimer(n) { pushUndo(`${n} deleted`); st.timers = st.timers.filter(t => t.n !== n); saveStore(); renderSched(); }
    function clearWorldTimers(w) { if(confirm(`${w} Clear?`)) { const list = bosses.find(g => g.w === w).b.map(b => b.n); st.timers = st.timers.filter(t => !list.includes(t.n)); saveStore(); renderSched(); } }
    function applyShift(dir) { const mins = parseInt(document.getElementById('shift-min').value) || 0; if(mins <= 0) return; pushUndo(`Shift ${mins}m`); const now = Date.now(); st.timers = st.timers.map(t => { if (t.t > now) t.t += mins * 60000 * dir; return t; }); saveStore(); renderSched(); }
    function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(el) el.classList.add('active'); if(id==='set-txt') syncTxt(); }
    function addLog(m) { const box = document.getElementById('logs'); const div = document.createElement('div'); div.innerHTML = `<span style="color:#718096; font-weight:700;">[${new Date().toLocaleTimeString()}]</span> ${m}`; box.appendChild(div); }
    function syncTxt() { let txt = `B-OPS PROFILE ${st.profile} SYNC\n`; st.timers.sort((a,b)=>a.t-b.t).forEach(tm => { txt += `${new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})} ${tm.n}\n`; }); document.getElementById('txt-ed').value = txt; }
    function saveText() { const lines = document.getElementById('txt-ed').value.split('\n'); const nt = []; lines.forEach(l => { const m = l.match(/(\d{2}:\d{2})\s+(.+)/); if(m) nt.push({ n: m[2].trim(), t: new Date(new Date().setHours(m[1].split(':')[0], m[1].split(':')[1], 0, 0)).getTime(), m5:false, m1:false, lastD: 9999 }); }); st.timers = nt; saveStore(); renderSched(); tab('dash', document.querySelectorAll('.nav-item')[0]); }
    function togglePwr() { st.on = !st.on; document.getElementById('pwr').style.color = st.on ? 'var(--success)' : '#ccc'; document.body.classList.toggle('system-off', !st.on); if(!st.on) window.speechSynthesis.cancel(); addLog(`System ${st.on?'ON':'OFF'}`); }
    function findBoss(n) { let r = null; bosses.forEach(g => g.b.forEach(b => { if(b.n===n) r=b; })); return r; }
    function formatTimer(ms) { if(ms<0) return "00:00:00"; const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(Math.floor(s%60)).toString().padStart(2,'0')}`; }
    function testAlert() { triggerAlert("ÌÖåÏä§Ìä∏", "ÏïåÎ¶º ÌÖåÏä§Ìä∏"); }
    async function toggleWakeLock() { if(!('wakeLock' in navigator)) return alert("Not supported"); if(st.wakeLock){ await st.wakeLock.release(); st.wakeLock=null; document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ OFF"; } else { requestWakeLock(false); } }
    async function requestWakeLock(silent) { try { st.wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wl-btn').innerText="üõ° ÌôîÎ©¥ Ïú†ÏßÄ ON"; } catch(e){} }
    function renderFavs() { const p = document.getElementById('fav-panel'); let h = ''; st.favs.forEach(n => h += `<div class="chip is-fav" onclick="quickKill('${n}')">‚≠ê ${n}</div>`); st.recent.forEach(n => { if(!st.favs.includes(n)) h += `<div class="chip" onclick="quickKill('${n}')">${n}</div>`; }); p.innerHTML = h; }
    function quickKill(name) { const n = name || document.getElementById('quick-sel').value; const b = findBoss(n); if(b) setTimer(n, b.r * 60, "ÏûêÎèô"); }
    function copyKakao(mode) {
        const now = Date.now(); const list = mode === 'top3' ? st.timers.filter(t => t.t > now).sort((a,b)=>a.t-b.t).slice(0,3) : [...st.timers].sort((a,b)=>a.t-b.t);
        if(!list.length) return alert("No active timers");
        const dH = `[${new Date().toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', weekday: 'short' })} Ïò§Îîò Î≥¥Ïä§ Ï††]`;
        let txt = mode==='top3' ? dH+'\n' : `${new Date().getMonth()+1}.${new Date().getDate()}\n`;
        list.forEach((t,i) => {
            const zT = new Date(t.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            if(mode==='top3') txt += `${i+1}) ${zT} ${t.n} (${BOSS_WORLD_MAP[t.n]||"-"}) - ÎÇ®ÏùÄ ${formatTimer(t.t-now).substring(3)}\n`;
            else txt += `${zT} ${t.n}\n`;
        });
        navigator.clipboard.writeText(txt.trim()).then(()=>alert("Î≥µÏÇ¨ ÏôÑÎ£å"));
    }
    function drawPIP(list) {
        const ctx = document.getElementById('pip-canvas').getContext('2d');
        ctx.fillStyle="#fff"; ctx.fillRect(0,0,240,135);
        ctx.fillStyle="#1a237e"; ctx.fillRect(0,0,240,35);
        ctx.fillStyle="#fff"; ctx.font="bold 13px Arial"; ctx.fillText("B-OPS PiP", 15, 23);
        if(list.length>0){
            const pinSet = new Set(st.pins); const n=list[0], d=n.t-Date.now();
            ctx.fillStyle="#1a237e"; ctx.font="bold 20px 'Inter'"; ctx.textAlign="center"; ctx.fillText((pinSet.has(n.n)?'üìå ':'')+n.n, 120, 75);
            ctx.fillStyle="#000"; ctx.font="bold 32px 'JetBrains Mono'"; ctx.fillText(formatTimer(d).substring(3), 120, 115);
        }
    }
    async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }
    function openBackup() { const data = { timers: st.timers, favs: st.favs, folds: st.foldState, pins: st.pins }; prompt("Backup (Copy JSON):", JSON.stringify(data)); }
    function handleKeys(e) { if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return; if(e.key==='/'){e.preventDefault(); document.getElementById('search-boss').focus();} if(e.ctrlKey && e.key==='z'){e.preventDefault(); executeUndo();} if(e.key>='1'&&e.key<='5'){const items=document.querySelectorAll('.nav-item'); if(items[e.key-1]) items[e.key-1].click();} }

    init();
</script>
</body>
</html>
