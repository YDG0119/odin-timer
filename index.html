<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS OPS CENTER V32.1 HD MASTER</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;800&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #1a237e; --primary-light: #e8eaf6; --border: #dee2e6; --danger: #d32f2f; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background: #f4f5f7; margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        body.system-off { filter: grayscale(1) brightness(0.9); pointer-events: none; }
        body.system-off header, body.system-off nav { pointer-events: auto !important; filter: none !important; }
        
        /* Sidebar Î†àÏù¥ÏïÑÏõÉ (720px ÏµúÏ†ÅÌôî ÎåÄÏùë) */
        nav { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px 0; z-index: 1000; flex-shrink: 0; }
        .nav-brand { padding: 0 25px 20px; font-weight: 900; font-size: 16px; color: var(--primary); border-bottom: 1px solid #f1f3f5; margin-bottom: 15px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; cursor: pointer; color: #6c757d; transition: 0.2s; gap: 12px; font-weight: 700; }
        .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .pane { display: none; width: 100%; max-width: 720px; animation: fadeIn 0.15s ease; }
        .pane.active { display: block; }
        .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

        /* ÌÉÄÏù¥Î®∏ Í∞ÄÎèÖÏÑ± (JetBrains Mono) */
        .timer-big { font-family: 'JetBrains Mono'; font-size: 52px; font-weight: 800; color: var(--primary); margin: 10px 0; letter-spacing: -2px; }
        .imminent .timer-big { color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .boss-row { display: grid; grid-template-columns: 35px 105px 1fr 100px 75px 35px; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f1f3f5; gap: 8px; }
        .v-in { height: 32px; width: 100%; border-radius: 6px; border: 1px solid #ced4da; text-align: center; font-family: 'JetBrains Mono'; font-weight: 700; font-size: 13px; }
        .v-in:focus { border-color: var(--primary); outline: none; background: #f0f4ff; }
        .zen-time-display { font-family: 'JetBrains Mono'; font-weight: 700; text-align: right; color: #475569; }
        .prev-time { font-size: 10px; color: var(--warning); font-weight: 700; height: 12px; }

        .log-box { font-family: 'JetBrains Mono'; font-size: 11px; height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; }
        
        .p-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 800; font-size: 11px; transition: 0.2s; }
        .p-btn.active { background: var(--primary); color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
    </style>
</head>
<body onkeydown="handleKeys(event)">

<nav>
    <div class="nav-brand italic">B-OPS V32.1 HD</div>
    <div class="nav-item active" onclick="tab('dash', this)">üè† Dashboard</div>
    <div class="nav-item" onclick="tab('sched', this)">üìÖ Boss Schedule</div>
    <div class="nav-item" onclick="tab('set-txt', this)">üïí Text Sync</div>
    <div class="nav-item" onclick="tab('battle', this)">‚öî Battle Ops</div>
    <div class="nav-item" onclick="togglePIP()">üì∫ Toggle HD-PiP</div>
</nav>

<main>
    <header>
        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
            <button class="p-btn active" data-p="A" onclick="switchProfile('A')">PROFILE A</button>
            <button class="p-btn" data-p="B" onclick="switchProfile('B')">PROFILE B</button>
        </div>
        <div class="flex items-center gap-4">
            <button class="p-btn border bg-white" onclick="testAlert()">üîî Test</button>
            <div id="pwr" class="cursor-pointer text-2xl text-green-600 font-bold" onclick="togglePwr()">‚èª</div>
        </div>
    </header>

    <div class="content">
        <div id="dash" class="pane active">
            <div id="hero-card" class="card text-center py-8">
                <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Next Boss Mission</div>
                <div id="d-name" class="text-3xl font-black mt-2">ÎåÄÍ∏∞ Ï§ë</div>
                <div id="d-timer" class="timer-big">00:00:00</div>
                <div id="d-meta" class="text-sm text-gray-500 font-bold">-</div>
                <div id="top3-list" class="mt-8 text-left bg-gray-50 p-5 rounded-2xl border border-gray-100 space-y-2"></div>
                <div class="mt-6 flex justify-center gap-3">
                    <button class="p-btn active px-8 py-3" onclick="copyKakao('top3')">üì¢ Top3 Î≥µÏÇ¨</button>
                    <button class="p-btn bg-gray-200 text-gray-700 px-8 py-3" onclick="copyKakao('all')">üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨</button>
                </div>
            </div>
            <div class="card">
                <div class="text-xs font-black text-blue-900 mb-3">COMMAND LOGS</div>
                <div id="logs" class="log-box"></div>
            </div>
        </div>

        <div id="sched" class="pane">
            <div class="card flex gap-3 items-center bg-gray-50 border-none shadow-none mb-4">
                <input type="text" id="search-boss" placeholder="Î≥¥Ïä§ ÌïÑÌÑ∞..." class="border rounded-md px-3 py-1 text-sm flex-1" oninput="handleSearch(this.value)">
                <label class="text-xs font-bold flex gap-1 items-center"><input type="checkbox" id="active-only" onchange="applyFilters()"> ÌôúÏÑ±Îßå</label>
                <button class="p-btn border bg-white" onclick="confirmClear()">CLEAR ALL</button>
            </div>
            <div id="sched-cont"></div>
        </div>

        <div id="set-txt" class="pane">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black">Text Sync Editor</h3>
                    <button class="p-btn active" onclick="saveText()">Ï†ÄÏû• ÌõÑ Ï†ÅÏö©</button>
                </div>
                <textarea id="txt-ed" class="w-full h-[500px] border p-5 font-mono text-sm leading-relaxed rounded-xl resize-none bg-gray-50"></textarea>
            </div>
        </div>

        <div id="battle" class="pane">
            <div class="card max-w-lg mx-auto">
                <h3 class="text-center font-black mb-6 uppercase tracking-wider">Tactical Battle Tracker</h3>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-gray-50 p-6 rounded-2xl text-center border">
                        <small class="font-black text-gray-400">ELAPSED</small>
                        <div id="b-elap" class="text-4xl font-mono font-black mt-2">00:00</div>
                    </div>
                    <div class="bg-red-50 p-6 rounded-2xl text-center border border-red-100">
                        <small class="font-black text-red-400">BERSERK PREDICT</small>
                        <div id="b-timer" class="text-4xl font-mono font-black mt-2 text-red-600">--:--</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <button class="p-btn bg-slate-700 text-white h-14" onclick="btl('start')">START</button>
                    <button class="p-btn bg-orange-500 text-white h-14" onclick="btl('kwang')">BERSERK</button>
                    <button class="p-btn active h-14" onclick="btl('kill')">KILLED</button>
                </div>
            </div>
        </div>
    </div>
</main>

<canvas id="pip-canvas" width="600" height="340" style="display:none;"></canvas>
<video id="pip-video" autoplay muted playsinline style="display:none;"></video>

<script>
/* [1] Ï†Ñ ÏßÄÏó≠ Î≥¥Ïä§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© (ÏïºÎ£¨->ÏïºÎ•∏ ÏàòÏ†ïÎê®) */
const bosses = [
    { w: "ÏöîÌà∞ÌïòÏûÑ", c: "#3f51b5", b: [{n:"ÏïºÎ•∏", r:240}, {n:"ÌååÎ•¥Î∞î", r:120}, {n:"ÏÖÄÎ°úÎπÑÏïÑ", r:720}, {n:"ÌùêÎãàÎ•¥", r:720}, {n:"ÌéòÌã∞", r:720}, {n:"Î∞îÏö∞Ìã∞", r:120}, {n:"ÎãàÎìúÌò∏Í∑∏", r:1440}, {n:"Ìã∞Î•¥", r:1440}] },
    { w: "ÎãàÎã§Î≤®Î¶¨Î•¥", c: "#43a047", b: [{n:"ÎùºÏù¥ÎÖ∏Î•¥", r:720}, {n:"ÎπÑÏöîÎ•∏", r:720}, {n:"Ìó§Î•¥Î™®Îìú", r:240}, {n:"Ïä§ÏπºÎùºÎãàÎ•¥", r:120}, {n:"Î∏åÎ•ÄÌûêÎìú", r:720}, {n:"ÎùºÌÉÄÌÜ†Ïä§ÌÅ¨", r:240}, {n:"ÏàòÎìúÎ¶¨", r:720}, {n:"ÌÜ†Î•¥", r:1440}] },
    { w: "ÏïåÎ∏åÌïòÏûÑ", c: "#ef6c00", b: [{n:"Ïä§Î∞îÎ•¥Ìä∏", r:240}, {n:"ÎëêÎùºÏä§Î°úÎ•¥", r:480}, {n:"Î™®ÎÑ§Í∞ÄÎ¶Ñ", r:120}, {n:"ÎìúÎùºÏö∞Í∑∏", r:240}, {n:"Íµ¥Î≤†Ïù¥Í∑∏", r:480}, {n:"Ïò§Îîò", r:1440}] },
    { w: "Î¨¥Ïä§Ìé†ÌïòÏûÑ", c: "#c62828", b: [{n:"Î©îÍ∏∞Î•¥", r:120}, {n:"Ïã†ÎßàÎùº", r:720}, {n:"Ìó§Î•¥Í∞ÄÎ¶Ñ", r:120}, {n:"ÌÉïÍ∑∏Î¶¨Ïä§ÎãàÎ•¥", r:240}, {n:"ÏóòÎìúÎ£¨", r:720}, {n:"Ïö∞Î°úÎ≥¥Î°úÏä§", r:1440}, {n:"ÏàòÎ•¥Ìä∏", r:1440}] },
    { w: "Î∞îÎÇòÌïòÏûÑ", c: "#689f38", b: [{n:"ÏóòÎîîÎ•¥", r:1440}, {n:"ÏïàÎÇòÎ•¥ÏóòÎîîÎ•¥", r:1440}, {n:"Ïä§Ïø®Îìú", r:1440}, {n:"Ïä§Ïπ¥Îîî", r:1440}, {n:"ÏóêÍ∏∞Î•¥", r:1440}, {n:"ÌîºÎ•¥Í∞ÄÎ∏å", r:240}] },
    { w: "ÏïÑÏä§Í∞ÄÎ•¥Îìú", c: "#7b1fa2", b: [{n:"Î∞úÎ¶¨", r:120}, {n:"ÎÖ∏Ìä∏", r:480}, {n:"ÏÉ§Î¨¥ÌÅ¨", r:120}, {n:"Ïä§ÏπºÎìúÎ©îÎ•¥", r:120}, {n:"Ïù¥ÎØ∏Î•¥", r:240}, {n:"Î™®Î•¥Í∞ÄÎÇò", r:240}] }
];
const BOSS_WORLD_MAP = {}; bosses.forEach(g => g.b.forEach(b => BOSS_WORLD_MAP[b.n] = g.w));

let st = { on: true, profile: 'A', timers: [], favs: [], pins: [], battle: { s: null, k: null, est: 0 }, foldState: {}, timeOffsetMs: 0, _keyCache: {} };

/* [2] SafeKey & HD PiP ÏóîÏßÑ */
function fnv1a32(str) {
    let h = 0x811c9dc5;
    for (let i = 0; i < str.length; i++) { h ^= str.charCodeAt(i); h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0; }
    return h >>> 0;
}
function safeKey(n) { if (!st._keyCache[n]) st._keyCache[n] = "b" + fnv1a32(String(n)).toString(36); return st._keyCache[n]; }

/* [ÏµúÏ†ÅÌôî] HD PiP Î†åÎçîÎßÅ (600x340) */
function drawPIP(list) {
    const canvas = document.getElementById('pip-canvas'); const ctx = canvas.getContext('2d');
    ctx.fillStyle = "#0f172a"; ctx.fillRect(0, 0, 600, 340);
    ctx.fillStyle = "#1e293b"; ctx.fillRect(0, 0, 600, 80);
    ctx.fillStyle = "#94a3b8"; ctx.font = "bold 26px Inter"; ctx.fillText("B-OPS COMMANDER HD", 40, 50);
    if (list.length > 0) {
        const next = list[0]; const rem = next.t - (Date.now() + st.timeOffsetMs);
        ctx.textAlign = "center"; ctx.fillStyle = "#fbbf24"; ctx.font = "900 48px 'Noto Sans KR'";
        ctx.fillText(next.n, 300, 165);
        ctx.fillStyle = "#ffffff"; ctx.font = "800 100px 'JetBrains Mono'";
        ctx.fillText(formatTimer(rem).substring(3), 300, 275);
    }
}

/* [4] Migration & Audio */
let __audioCtx = null;
function getCtx() { if (!__audioCtx) __audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (__audioCtx.state === "suspended") __audioCtx.resume(); return __audioCtx; }

function migrate() {
    const o = "ÏïºÎ£¨", n = "ÏïºÎ•∏";
    st.timers.forEach(t => { if(t.n === o) t.n = n; });
    ["favs", "pins"].forEach(k => { if(st[k]) st[k] = st[k].map(x => x === o ? n : x); });
}

function triggerAlert(name, msg) {
    addLog(`[ALERT] ${name} ${msg}`);
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(`${name} ${msg}ÏûÖÎãàÎã§.`);
    u.lang = 'ko-KR'; window.speechSynthesis.speak(u);
    try {
        const c = getCtx(); const g = c.createGain(); const o = c.createOscillator();
        g.gain.setValueAtTime(0.0001, c.currentTime); g.gain.exponentialRampToValueAtTime(0.15, c.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + 0.18);
        o.frequency.value = 440; o.connect(g); g.connect(c.destination);
        o.start(); o.stop(c.currentTime + 0.2); o.onended = () => { o.disconnect(); g.disconnect(); };
    } catch(e){}
}

/* [ÌïµÏã¨] KILLED Î∞è ÏàòÎèô ÏûÖÎ†• Î°úÏßÅ (Î∞òÏùë ÏÜçÎèÑ ÏµúÏ†ÅÌôî) */
function setTimer(n, s, raw) {
    const now = Date.now() + st.timeOffsetMs;
    const t = now + (s * 1000);
    st.timers = st.timers.filter(x => x.n !== n);
    st.timers.push({ n, t, m5: false, m1: false, lastD: s });
    save(); renderSched();
    addLog(`${n} mission updated.`);
}

/* [3] Ï†ïÎ∞Ä Î£®ÌîÑ Î∞è ÏµúÏ†ÅÌôî */
function loop() {
    if (!st.on) return;
    const now = Date.now() + st.timeOffsetMs;
    st.timers = st.timers.filter(t => (now - t.t) < 600000);

    st.timers.forEach(tm => {
        const d = Math.floor((tm.t - now) / 1000);
        const prev = tm.lastD || d;
        if (!tm.m5 && prev > 300 && d <= 300) { triggerAlert(tm.n, "5Î∂Ñ Ï†Ñ"); tm.m5 = true; }
        if (!tm.m1 && prev > 60 && d <= 60) { triggerAlert(tm.n, "1Î∂Ñ Ï†Ñ"); tm.m1 = true; }
        tm.lastD = d;
        const el = document.getElementById(`zen-${safeKey(tm.n)}`);
        if (el) el.innerText = new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
    });

    const list = [...st.timers].sort((a,b) => a.t - b.t);
    const upcoming = list.filter(t => t.t > now);
    const next = upcoming[0];
    document.getElementById('d-name').innerText = next ? next.n : "ÎåÄÍ∏∞ Ï§ë";
    document.getElementById('d-timer').innerText = next ? formatTimer(next.t - now) : "00:00:00";
    document.getElementById('d-meta').innerText = next ? `${new Date(next.t).toLocaleTimeString()} (${BOSS_WORLD_MAP[next.n]})` : "-";
    document.getElementById('hero-card').className = (next && (next.t - now < 300000)) ? 'card hero-section imminent shadow-2xl' : 'card hero-section';

    document.getElementById('top3-list').innerHTML = upcoming.slice(0,3).map((t, i) => `
        <div class="flex justify-between border-b border-gray-100 py-2 items-center">
            <span class="font-bold text-gray-700">${i+1}. ${t.n}</span>
            <span class="font-mono font-black text-blue-900">${formatTimer(t.t - now).substring(3)}</span>
        </div>`).join('') || "Î¶¨Ï†† ÏòàÏ†ï Î≥¥Ïä§ ÏóÜÏùå";
    
    if (st.battle.s && !st.battle.k) document.getElementById('b-elap').innerText = formatSimple((now - st.battle.s) / 1000);
    drawPIP(upcoming);
}

/* [Render] safeKey Í∏∞Î∞ò Ïä§ÏºÄÏ§Ñ Î¶¨Ïä§Ìä∏ */
function renderSched() {
    const cont = document.getElementById('sched-cont');
    const timerMap = new Map(st.timers.map(t => [t.n, t]));
    let html = '';
    bosses.forEach(g => {
        const folded = st.foldState[g.w];
        html += `<div class="world-section ${folded ? 'is-folded' : ''} mb-3 border rounded-xl overflow-hidden">
            <div class="bg-gray-100 p-3 font-black text-[10px] flex justify-between items-center" onclick="toggleFold('${g.w}')">
                <span>${g.w.toUpperCase()}</span>
                <button class="text-red-400 hover:underline" onclick="event.stopPropagation(); clearWorld('${g.w}')">World Clear</button>
            </div>
            <div class="world-content">`;
        g.b.forEach(b => {
            const tm = timerMap.get(b.n);
            const zenTxt = tm ? new Date(tm.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}) : '--:--';
            html += `<div class="boss-row">
                <button onclick="togglePin('${b.n}')" class="text-lg">${st.pins.includes(b.n)?'üìå':'üìç'}</button>
                <b class="text-sm truncate">${b.n}</b>
                <input type="text" data-name="${b.n}" class="v-in" onkeydown="if(event.key==='Enter') setTimer('${b.n}', parseSmart(this.value), this.value)" oninput="previewSpawn(this)" placeholder="0 0">
                <div class="zen-time-display">
                    <div id="zen-${safeKey(b.n)}">${zenTxt}</div>
                    <div id="prev-${safeKey(b.n)}" class="prev-time"></div>
                </div>
                <button onclick="setTimer('${b.n}', ${b.r*60}, 'ÏûêÎèô')" class="bg-blue-900 text-white text-[10px] py-1 rounded-md font-bold hover:bg-black transition">KILL</button>
                <button onclick="delTimer('${b.n}')" class="text-red-400 font-bold hover:text-red-600 transition text-lg">√ó</button>
            </div>`;
        });
        html += `</div></div>`;
    });
    cont.innerHTML = html;
}

/* [Utility] Í≥µÌÜµ Í∏∞Îä• */
function save() { localStorage.setItem(`v32_data_${st.profile}`, JSON.stringify({ timers: st.timers, pins: st.pins, fold: st.foldState })); syncTxt(); }
function switchProfile(p) { st.profile = p; const d = JSON.parse(localStorage.getItem(`v32_data_${p}`)) || {}; st.timers = d.timers || []; st.pins = d.pins || []; st.foldState = d.fold || {}; migrate(); renderSched(); addLog(`Profile ${p} Loaded.`); }
function togglePwr() { st.on = !st.on; document.getElementById('pwr').style.color = st.on ? '#16a34a' : '#94a3b8'; if(!st.on) window.speechSynthesis.cancel(); }
function previewSpawn(el) { const s = parseSmart(el.value); const box = document.getElementById(`prev-${safeKey(el.dataset.name)}`); box.innerText = s > 0 ? `Soon ${new Date(Date.now() + s*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})}` : ""; }
function formatTimer(ms) { if(ms<0) return "00:00:00"; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const rs=s%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${rs.toString().padStart(2,'0')}`; }
function parseSmart(v) { const p = v.split(' ').filter(x=>x!=='').map(Number); return p.length >= 2 ? p[0]*60 + p[1] : (p[0]||0)*60; }
function formatSimple(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
function tab(id, el) { document.querySelectorAll('.pane').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
function addLog(m) { const b = document.getElementById('logs'); const d = document.createElement('div'); d.innerHTML = `<span class="text-gray-500 font-bold">[${new Date().toLocaleTimeString()}]</span> ${m}`; b.appendChild(d); }
function togglePin(n) { const i = st.pins.indexOf(n); if(i>-1) st.pins.splice(i,1); else st.pins.push(n); save(); renderSched(); }
function delTimer(n) { st.timers = st.timers.filter(x => x.n !== n); save(); renderSched(); }
function confirmClear() { if(confirm("Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { st.timers = []; save(); renderSched(); } }
function btl(type) { const now = Date.now(); if(type==='start') st.battle.s=now; else if(type==='kill') st.battle.s=null; addLog(`Battle ${type}.`); }
function testAlert() { triggerAlert("ÌÖåÏä§Ìä∏", "ÏïåÎ¶º Ï†ïÏÉÅ ÏûëÎèô."); }
async function togglePIP() { const v = document.getElementById('pip-video'); if (document.pictureInPictureElement) await document.exitPictureInPicture(); else { v.srcObject = document.getElementById('pip-canvas').captureStream(); await v.play(); await v.requestPictureInPicture(); } }

window.onload = () => { switchProfile('A'); setInterval(loop, 1000); };
</script>
</body>
</html>
